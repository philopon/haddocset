<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Distribution/Simple/Program/HcPkg.hs</title>
<link type="text/css" rel="stylesheet" href="hscolour.css"></link>
</head>
<body>
<pre><a name="line-1"></a><span class="hs-comment">-----------------------------------------------------------------------------</span>
<a name="line-2"></a><span class="hs-comment">-- |</span>
<a name="line-3"></a><span class="hs-comment">-- Module      :  Distribution.Simple.Program.HcPkg</span>
<a name="line-4"></a><span class="hs-comment">-- Copyright   :  Duncan Coutts 2009</span>
<a name="line-5"></a><span class="hs-comment">--</span>
<a name="line-6"></a><span class="hs-comment">-- Maintainer  :  cabal-devel@haskell.org</span>
<a name="line-7"></a><span class="hs-comment">-- Portability :  portable</span>
<a name="line-8"></a><span class="hs-comment">--</span>
<a name="line-9"></a><span class="hs-comment">-- This module provides an library interface to the @hc-pkg@ program.</span>
<a name="line-10"></a><span class="hs-comment">-- Currently only GHC and LHC have hc-pkg programs.</span>
<a name="line-11"></a>
<a name="line-12"></a><span class="hs-keyword">module</span> <span class="hs-conid">Distribution</span><span class="hs-varop">.</span><span class="hs-conid">Simple</span><span class="hs-varop">.</span><span class="hs-conid">Program</span><span class="hs-varop">.</span><span class="hs-conid">HcPkg</span> <span class="hs-layout">(</span>
<a name="line-13"></a>    <span class="hs-varid">register</span><span class="hs-layout">,</span>
<a name="line-14"></a>    <span class="hs-varid">reregister</span><span class="hs-layout">,</span>
<a name="line-15"></a>    <span class="hs-varid">unregister</span><span class="hs-layout">,</span>
<a name="line-16"></a>    <span class="hs-varid">expose</span><span class="hs-layout">,</span>
<a name="line-17"></a>    <span class="hs-varid">hide</span><span class="hs-layout">,</span>
<a name="line-18"></a>    <span class="hs-varid">dump</span><span class="hs-layout">,</span>
<a name="line-19"></a>
<a name="line-20"></a>    <span class="hs-comment">-- * Program invocations</span>
<a name="line-21"></a>    <span class="hs-varid">registerInvocation</span><span class="hs-layout">,</span>
<a name="line-22"></a>    <span class="hs-varid">reregisterInvocation</span><span class="hs-layout">,</span>
<a name="line-23"></a>    <span class="hs-varid">unregisterInvocation</span><span class="hs-layout">,</span>
<a name="line-24"></a>    <span class="hs-varid">exposeInvocation</span><span class="hs-layout">,</span>
<a name="line-25"></a>    <span class="hs-varid">hideInvocation</span><span class="hs-layout">,</span>
<a name="line-26"></a>    <span class="hs-varid">dumpInvocation</span><span class="hs-layout">,</span>
<a name="line-27"></a>  <span class="hs-layout">)</span> <span class="hs-keyword">where</span>
<a name="line-28"></a>
<a name="line-29"></a><span class="hs-keyword">import</span> <span class="hs-conid">Distribution</span><span class="hs-varop">.</span><span class="hs-conid">Package</span>
<a name="line-30"></a>         <span class="hs-layout">(</span> <span class="hs-conid">PackageId</span><span class="hs-layout">,</span> <span class="hs-conid">InstalledPackageId</span><span class="hs-layout">(</span><span class="hs-keyglyph">..</span><span class="hs-layout">)</span> <span class="hs-layout">)</span>
<a name="line-31"></a><span class="hs-keyword">import</span> <span class="hs-conid">Distribution</span><span class="hs-varop">.</span><span class="hs-conid">InstalledPackageInfo</span>
<a name="line-32"></a>         <span class="hs-layout">(</span> <span class="hs-conid">InstalledPackageInfo</span><span class="hs-layout">,</span> <span class="hs-conid">InstalledPackageInfo_</span><span class="hs-layout">(</span><span class="hs-keyglyph">..</span><span class="hs-layout">)</span>
<a name="line-33"></a>         <span class="hs-layout">,</span> <span class="hs-varid">showInstalledPackageInfo</span>
<a name="line-34"></a>         <span class="hs-layout">,</span> <span class="hs-varid">emptyInstalledPackageInfo</span><span class="hs-layout">,</span> <span class="hs-varid">fieldsInstalledPackageInfo</span> <span class="hs-layout">)</span>
<a name="line-35"></a><span class="hs-keyword">import</span> <span class="hs-conid">Distribution</span><span class="hs-varop">.</span><span class="hs-conid">ParseUtils</span>
<a name="line-36"></a><span class="hs-keyword">import</span> <span class="hs-conid">Distribution</span><span class="hs-varop">.</span><span class="hs-conid">Simple</span><span class="hs-varop">.</span><span class="hs-conid">Compiler</span>
<a name="line-37"></a>         <span class="hs-layout">(</span> <span class="hs-conid">PackageDB</span><span class="hs-layout">(</span><span class="hs-keyglyph">..</span><span class="hs-layout">)</span><span class="hs-layout">,</span> <span class="hs-conid">PackageDBStack</span> <span class="hs-layout">)</span>
<a name="line-38"></a><span class="hs-keyword">import</span> <span class="hs-conid">Distribution</span><span class="hs-varop">.</span><span class="hs-conid">Simple</span><span class="hs-varop">.</span><span class="hs-conid">Program</span><span class="hs-varop">.</span><span class="hs-conid">Types</span>
<a name="line-39"></a>         <span class="hs-layout">(</span> <span class="hs-conid">ConfiguredProgram</span><span class="hs-layout">(</span><span class="hs-varid">programId</span><span class="hs-layout">,</span> <span class="hs-varid">programVersion</span><span class="hs-layout">)</span> <span class="hs-layout">)</span>
<a name="line-40"></a><span class="hs-keyword">import</span> <span class="hs-conid">Distribution</span><span class="hs-varop">.</span><span class="hs-conid">Simple</span><span class="hs-varop">.</span><span class="hs-conid">Program</span><span class="hs-varop">.</span><span class="hs-conid">Run</span>
<a name="line-41"></a>         <span class="hs-layout">(</span> <span class="hs-conid">ProgramInvocation</span><span class="hs-layout">(</span><span class="hs-keyglyph">..</span><span class="hs-layout">)</span><span class="hs-layout">,</span> <span class="hs-conid">IOEncoding</span><span class="hs-layout">(</span><span class="hs-keyglyph">..</span><span class="hs-layout">)</span><span class="hs-layout">,</span> <span class="hs-varid">programInvocation</span>
<a name="line-42"></a>         <span class="hs-layout">,</span> <span class="hs-varid">runProgramInvocation</span><span class="hs-layout">,</span> <span class="hs-varid">getProgramInvocationOutput</span> <span class="hs-layout">)</span>
<a name="line-43"></a><span class="hs-keyword">import</span> <span class="hs-conid">Distribution</span><span class="hs-varop">.</span><span class="hs-conid">Version</span>
<a name="line-44"></a>         <span class="hs-layout">(</span> <span class="hs-conid">Version</span><span class="hs-layout">(</span><span class="hs-keyglyph">..</span><span class="hs-layout">)</span> <span class="hs-layout">)</span>
<a name="line-45"></a><span class="hs-keyword">import</span> <span class="hs-conid">Distribution</span><span class="hs-varop">.</span><span class="hs-conid">Text</span>
<a name="line-46"></a>         <span class="hs-layout">(</span> <span class="hs-varid">display</span> <span class="hs-layout">)</span>
<a name="line-47"></a><span class="hs-keyword">import</span> <span class="hs-conid">Distribution</span><span class="hs-varop">.</span><span class="hs-conid">Simple</span><span class="hs-varop">.</span><span class="hs-conid">Utils</span>
<a name="line-48"></a>         <span class="hs-layout">(</span> <span class="hs-varid">die</span> <span class="hs-layout">)</span>
<a name="line-49"></a><span class="hs-keyword">import</span> <span class="hs-conid">Distribution</span><span class="hs-varop">.</span><span class="hs-conid">Verbosity</span>
<a name="line-50"></a>         <span class="hs-layout">(</span> <span class="hs-conid">Verbosity</span><span class="hs-layout">,</span> <span class="hs-varid">deafening</span><span class="hs-layout">,</span> <span class="hs-varid">silent</span> <span class="hs-layout">)</span>
<a name="line-51"></a><span class="hs-keyword">import</span> <span class="hs-conid">Distribution</span><span class="hs-varop">.</span><span class="hs-conid">Compat</span><span class="hs-varop">.</span><span class="hs-conid">Exception</span>
<a name="line-52"></a>         <span class="hs-layout">(</span> <span class="hs-varid">catchExit</span> <span class="hs-layout">)</span>
<a name="line-53"></a>
<a name="line-54"></a><span class="hs-keyword">import</span> <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">Char</span>
<a name="line-55"></a>         <span class="hs-layout">(</span> <span class="hs-varid">isSpace</span> <span class="hs-layout">)</span>
<a name="line-56"></a><span class="hs-keyword">import</span> <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">Maybe</span>
<a name="line-57"></a>         <span class="hs-layout">(</span> <span class="hs-varid">fromMaybe</span> <span class="hs-layout">)</span>
<a name="line-58"></a><span class="hs-keyword">import</span> <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">List</span>
<a name="line-59"></a>         <span class="hs-layout">(</span> <span class="hs-varid">stripPrefix</span> <span class="hs-layout">)</span>
<a name="line-60"></a><span class="hs-keyword">import</span> <span class="hs-conid">System</span><span class="hs-varop">.</span><span class="hs-conid">FilePath</span> <span class="hs-keyword">as</span> <span class="hs-conid">FilePath</span>
<a name="line-61"></a>         <span class="hs-layout">(</span> <span class="hs-layout">(</span><span class="hs-varop">&lt;/&gt;</span><span class="hs-layout">)</span><span class="hs-layout">,</span> <span class="hs-varid">splitPath</span><span class="hs-layout">,</span> <span class="hs-varid">splitDirectories</span><span class="hs-layout">,</span> <span class="hs-varid">joinPath</span><span class="hs-layout">,</span> <span class="hs-varid">isPathSeparator</span> <span class="hs-layout">)</span>
<a name="line-62"></a><span class="hs-keyword">import</span> <span class="hs-keyword">qualified</span> <span class="hs-conid">System</span><span class="hs-varop">.</span><span class="hs-conid">FilePath</span><span class="hs-varop">.</span><span class="hs-conid">Posix</span> <span class="hs-keyword">as</span> <span class="hs-conid">FilePath</span><span class="hs-varop">.</span><span class="hs-conid">Posix</span>
<a name="line-63"></a>
<a name="line-64"></a>
<a name="line-65"></a><a name="register"></a><span class="hs-comment">-- | Call @hc-pkg@ to register a package.</span>
<a name="line-66"></a><span class="hs-comment">--</span>
<a name="line-67"></a><span class="hs-comment">-- &gt; hc-pkg register {filename | -} [--user | --global | --package-db]</span>
<a name="line-68"></a><span class="hs-comment">--</span>
<a name="line-69"></a><span class="hs-definition">register</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Verbosity</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">ConfiguredProgram</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">PackageDBStack</span>
<a name="line-70"></a>         <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Either</span> <span class="hs-conid">FilePath</span>
<a name="line-71"></a>                   <span class="hs-conid">InstalledPackageInfo</span>
<a name="line-72"></a>         <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-conid">()</span>
<a name="line-73"></a><span class="hs-definition">register</span> <span class="hs-varid">verbosity</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">packagedb</span> <span class="hs-varid">pkgFile</span> <span class="hs-keyglyph">=</span>
<a name="line-74"></a>  <span class="hs-varid">runProgramInvocation</span> <span class="hs-varid">verbosity</span>
<a name="line-75"></a>    <span class="hs-layout">(</span><span class="hs-varid">registerInvocation</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">verbosity</span> <span class="hs-varid">packagedb</span> <span class="hs-varid">pkgFile</span><span class="hs-layout">)</span>
<a name="line-76"></a>
<a name="line-77"></a>
<a name="line-78"></a><a name="reregister"></a><span class="hs-comment">-- | Call @hc-pkg@ to re-register a package.</span>
<a name="line-79"></a><span class="hs-comment">--</span>
<a name="line-80"></a><span class="hs-comment">-- &gt; hc-pkg register {filename | -} [--user | --global | --package-db]</span>
<a name="line-81"></a><span class="hs-comment">--</span>
<a name="line-82"></a><span class="hs-definition">reregister</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Verbosity</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">ConfiguredProgram</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">PackageDBStack</span>
<a name="line-83"></a>           <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Either</span> <span class="hs-conid">FilePath</span>
<a name="line-84"></a>                     <span class="hs-conid">InstalledPackageInfo</span>
<a name="line-85"></a>           <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-conid">()</span>
<a name="line-86"></a><span class="hs-definition">reregister</span> <span class="hs-varid">verbosity</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">packagedb</span> <span class="hs-varid">pkgFile</span> <span class="hs-keyglyph">=</span>
<a name="line-87"></a>  <span class="hs-varid">runProgramInvocation</span> <span class="hs-varid">verbosity</span>
<a name="line-88"></a>    <span class="hs-layout">(</span><span class="hs-varid">reregisterInvocation</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">verbosity</span> <span class="hs-varid">packagedb</span> <span class="hs-varid">pkgFile</span><span class="hs-layout">)</span>
<a name="line-89"></a>
<a name="line-90"></a>
<a name="line-91"></a><a name="unregister"></a><span class="hs-comment">-- | Call @hc-pkg@ to unregister a package</span>
<a name="line-92"></a><span class="hs-comment">--</span>
<a name="line-93"></a><span class="hs-comment">-- &gt; hc-pkg unregister [pkgid] [--user | --global | --package-db]</span>
<a name="line-94"></a><span class="hs-comment">--</span>
<a name="line-95"></a><span class="hs-definition">unregister</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Verbosity</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">ConfiguredProgram</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">PackageDB</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">PackageId</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-conid">()</span>
<a name="line-96"></a><span class="hs-definition">unregister</span> <span class="hs-varid">verbosity</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">packagedb</span> <span class="hs-varid">pkgid</span> <span class="hs-keyglyph">=</span>
<a name="line-97"></a>  <span class="hs-varid">runProgramInvocation</span> <span class="hs-varid">verbosity</span>
<a name="line-98"></a>    <span class="hs-layout">(</span><span class="hs-varid">unregisterInvocation</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">verbosity</span> <span class="hs-varid">packagedb</span> <span class="hs-varid">pkgid</span><span class="hs-layout">)</span>
<a name="line-99"></a>
<a name="line-100"></a>
<a name="line-101"></a><a name="expose"></a><span class="hs-comment">-- | Call @hc-pkg@ to expose a package.</span>
<a name="line-102"></a><span class="hs-comment">--</span>
<a name="line-103"></a><span class="hs-comment">-- &gt; hc-pkg expose [pkgid] [--user | --global | --package-db]</span>
<a name="line-104"></a><span class="hs-comment">--</span>
<a name="line-105"></a><span class="hs-definition">expose</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Verbosity</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">ConfiguredProgram</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">PackageDB</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">PackageId</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-conid">()</span>
<a name="line-106"></a><span class="hs-definition">expose</span> <span class="hs-varid">verbosity</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">packagedb</span> <span class="hs-varid">pkgid</span> <span class="hs-keyglyph">=</span>
<a name="line-107"></a>  <span class="hs-varid">runProgramInvocation</span> <span class="hs-varid">verbosity</span>
<a name="line-108"></a>    <span class="hs-layout">(</span><span class="hs-varid">exposeInvocation</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">verbosity</span> <span class="hs-varid">packagedb</span> <span class="hs-varid">pkgid</span><span class="hs-layout">)</span>
<a name="line-109"></a>
<a name="line-110"></a>
<a name="line-111"></a><a name="hide"></a><span class="hs-comment">-- | Call @hc-pkg@ to expose a package.</span>
<a name="line-112"></a><span class="hs-comment">--</span>
<a name="line-113"></a><span class="hs-comment">-- &gt; hc-pkg expose [pkgid] [--user | --global | --package-db]</span>
<a name="line-114"></a><span class="hs-comment">--</span>
<a name="line-115"></a><span class="hs-definition">hide</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Verbosity</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">ConfiguredProgram</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">PackageDB</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">PackageId</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-conid">()</span>
<a name="line-116"></a><span class="hs-definition">hide</span> <span class="hs-varid">verbosity</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">packagedb</span> <span class="hs-varid">pkgid</span> <span class="hs-keyglyph">=</span>
<a name="line-117"></a>  <span class="hs-varid">runProgramInvocation</span> <span class="hs-varid">verbosity</span>
<a name="line-118"></a>    <span class="hs-layout">(</span><span class="hs-varid">hideInvocation</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">verbosity</span> <span class="hs-varid">packagedb</span> <span class="hs-varid">pkgid</span><span class="hs-layout">)</span>
<a name="line-119"></a>
<a name="line-120"></a>
<a name="line-121"></a><a name="dump"></a><span class="hs-comment">-- | Call @hc-pkg@ to get all the installed packages.</span>
<a name="line-122"></a><span class="hs-comment">--</span>
<a name="line-123"></a><span class="hs-definition">dump</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Verbosity</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">ConfiguredProgram</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">PackageDB</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-keyglyph">[</span><span class="hs-conid">InstalledPackageInfo</span><span class="hs-keyglyph">]</span>
<a name="line-124"></a><span class="hs-definition">dump</span> <span class="hs-varid">verbosity</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">packagedb</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span>
<a name="line-125"></a>
<a name="line-126"></a>  <span class="hs-varid">output</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">getProgramInvocationOutput</span> <span class="hs-varid">verbosity</span>
<a name="line-127"></a>              <span class="hs-layout">(</span><span class="hs-varid">dumpInvocation</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">verbosity</span> <span class="hs-varid">packagedb</span><span class="hs-layout">)</span>
<a name="line-128"></a>    <span class="hs-varop">`catchExit`</span> <span class="hs-keyglyph">\</span><span class="hs-keyword">_</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">die</span> <span class="hs-varop">$</span> <span class="hs-varid">programId</span> <span class="hs-varid">hcPkg</span> <span class="hs-varop">++</span> <span class="hs-str">&quot; dump failed&quot;</span>
<a name="line-129"></a>
<a name="line-130"></a>  <span class="hs-keyword">case</span> <span class="hs-varid">parsePackages</span> <span class="hs-varid">output</span> <span class="hs-keyword">of</span>
<a name="line-131"></a>    <span class="hs-conid">Left</span> <span class="hs-varid">ok</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">return</span> <span class="hs-varid">ok</span>
<a name="line-132"></a>    <span class="hs-keyword">_</span>       <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">die</span> <span class="hs-varop">$</span> <span class="hs-str">&quot;failed to parse output of '&quot;</span>
<a name="line-133"></a>                  <span class="hs-varop">++</span> <span class="hs-varid">programId</span> <span class="hs-varid">hcPkg</span> <span class="hs-varop">++</span> <span class="hs-str">&quot; dump'&quot;</span>
<a name="line-134"></a>
<a name="line-135"></a>  <span class="hs-keyword">where</span>
<a name="line-136"></a>    <span class="hs-varid">parsePackages</span> <span class="hs-varid">str</span> <span class="hs-keyglyph">=</span>
<a name="line-137"></a>      <span class="hs-keyword">let</span> <span class="hs-varid">parsed</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">map</span> <span class="hs-varid">parseInstalledPackageInfo'</span> <span class="hs-layout">(</span><span class="hs-varid">splitPkgs</span> <span class="hs-varid">str</span><span class="hs-layout">)</span>
<a name="line-138"></a>       <span class="hs-keyword">in</span> <span class="hs-keyword">case</span> <span class="hs-keyglyph">[</span> <span class="hs-varid">msg</span> <span class="hs-keyglyph">|</span> <span class="hs-conid">ParseFailed</span> <span class="hs-varid">msg</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">parsed</span> <span class="hs-keyglyph">]</span> <span class="hs-keyword">of</span>
<a name="line-139"></a>            <span class="hs-conid">[]</span>   <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Left</span> <span class="hs-keyglyph">[</span>   <span class="hs-varid">setInstalledPackageId</span>
<a name="line-140"></a>                           <span class="hs-varop">.</span> <span class="hs-varid">maybe</span> <span class="hs-varid">id</span> <span class="hs-varid">mungePackagePaths</span> <span class="hs-varid">pkgroot</span>
<a name="line-141"></a>                           <span class="hs-varop">$</span> <span class="hs-varid">pkg</span>
<a name="line-142"></a>                         <span class="hs-keyglyph">|</span> <span class="hs-conid">ParseOk</span> <span class="hs-keyword">_</span> <span class="hs-layout">(</span><span class="hs-varid">pkgroot</span><span class="hs-layout">,</span> <span class="hs-varid">pkg</span><span class="hs-layout">)</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">parsed</span> <span class="hs-keyglyph">]</span>
<a name="line-143"></a>            <span class="hs-varid">msgs</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Right</span> <span class="hs-varid">msgs</span>
<a name="line-144"></a>
<a name="line-145"></a>    <span class="hs-varid">parseInstalledPackageInfo'</span> <span class="hs-keyglyph">=</span>
<a name="line-146"></a>        <span class="hs-varid">parseFieldsFlat</span> <span class="hs-varid">fields</span> <span class="hs-layout">(</span><span class="hs-conid">Nothing</span><span class="hs-layout">,</span> <span class="hs-varid">emptyInstalledPackageInfo</span><span class="hs-layout">)</span>
<a name="line-147"></a>      <span class="hs-keyword">where</span>
<a name="line-148"></a>        <span class="hs-varid">fields</span> <span class="hs-keyglyph">=</span>     <span class="hs-varid">liftFieldFst</span> <span class="hs-varid">pkgrootField</span>
<a name="line-149"></a>               <span class="hs-conop">:</span> <span class="hs-varid">map</span> <span class="hs-varid">liftFieldSnd</span> <span class="hs-varid">fieldsInstalledPackageInfo</span>
<a name="line-150"></a>
<a name="line-151"></a>        <span class="hs-varid">pkgrootField</span> <span class="hs-keyglyph">=</span>
<a name="line-152"></a>          <span class="hs-varid">simpleField</span> <span class="hs-str">&quot;pkgroot&quot;</span>
<a name="line-153"></a>            <span class="hs-varid">showFilePath</span>    <span class="hs-varid">parseFilePathQ</span>
<a name="line-154"></a>            <span class="hs-layout">(</span><span class="hs-varid">fromMaybe</span> <span class="hs-str">&quot;&quot;</span><span class="hs-layout">)</span>  <span class="hs-layout">(</span><span class="hs-keyglyph">\</span><span class="hs-varid">x</span> <span class="hs-keyword">_</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Just</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-155"></a>
<a name="line-156"></a>        <span class="hs-varid">liftFieldFst</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">liftField</span> <span class="hs-varid">fst</span> <span class="hs-layout">(</span><span class="hs-keyglyph">\</span><span class="hs-varid">x</span> <span class="hs-layout">(</span><span class="hs-sel">_x</span><span class="hs-layout">,</span><span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-layout">(</span><span class="hs-varid">x</span><span class="hs-layout">,</span><span class="hs-varid">y</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-157"></a>        <span class="hs-varid">liftFieldSnd</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">liftField</span> <span class="hs-varid">snd</span> <span class="hs-layout">(</span><span class="hs-keyglyph">\</span><span class="hs-varid">y</span> <span class="hs-layout">(</span><span class="hs-varid">x</span><span class="hs-layout">,</span><span class="hs-sel">_y</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-layout">(</span><span class="hs-varid">x</span><span class="hs-layout">,</span><span class="hs-varid">y</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-158"></a>
<a name="line-159"></a>    <span class="hs-comment">--TODO: this could be a lot faster. We're doing normaliseLineEndings twice</span>
<a name="line-160"></a>    <span class="hs-comment">-- and converting back and forth with lines/unlines.</span>
<a name="line-161"></a>    <span class="hs-varid">splitPkgs</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">String</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyglyph">[</span><span class="hs-conid">String</span><span class="hs-keyglyph">]</span>
<a name="line-162"></a>    <span class="hs-varid">splitPkgs</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">checkEmpty</span> <span class="hs-varop">.</span> <span class="hs-varid">map</span> <span class="hs-varid">unlines</span> <span class="hs-varop">.</span> <span class="hs-varid">splitWith</span> <span class="hs-layout">(</span><span class="hs-str">&quot;---&quot;</span> <span class="hs-varop">==</span><span class="hs-layout">)</span> <span class="hs-varop">.</span> <span class="hs-varid">lines</span>
<a name="line-163"></a>      <span class="hs-keyword">where</span>
<a name="line-164"></a>        <span class="hs-comment">-- Handle the case of there being no packages at all.</span>
<a name="line-165"></a>        <span class="hs-varid">checkEmpty</span> <span class="hs-keyglyph">[</span><span class="hs-varid">s</span><span class="hs-keyglyph">]</span> <span class="hs-keyglyph">|</span> <span class="hs-varid">all</span> <span class="hs-varid">isSpace</span> <span class="hs-varid">s</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">[]</span>
<a name="line-166"></a>        <span class="hs-varid">checkEmpty</span> <span class="hs-varid">ss</span>                  <span class="hs-keyglyph">=</span> <span class="hs-varid">ss</span>
<a name="line-167"></a>
<a name="line-168"></a>        <span class="hs-varid">splitWith</span> <span class="hs-keyglyph">::</span> <span class="hs-layout">(</span><span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Bool</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyglyph">[</span><span class="hs-varid">a</span><span class="hs-keyglyph">]</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyglyph">[</span><span class="hs-keyglyph">[</span><span class="hs-varid">a</span><span class="hs-keyglyph">]</span><span class="hs-keyglyph">]</span>
<a name="line-169"></a>        <span class="hs-varid">splitWith</span> <span class="hs-varid">p</span> <span class="hs-varid">xs</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">ys</span> <span class="hs-conop">:</span> <span class="hs-keyword">case</span> <span class="hs-varid">zs</span> <span class="hs-keyword">of</span>
<a name="line-170"></a>                           <span class="hs-conid">[]</span>   <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">[]</span>
<a name="line-171"></a>                           <span class="hs-keyword">_</span><span class="hs-conop">:</span><span class="hs-varid">ws</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">splitWith</span> <span class="hs-varid">p</span> <span class="hs-varid">ws</span>
<a name="line-172"></a>          <span class="hs-keyword">where</span> <span class="hs-layout">(</span><span class="hs-varid">ys</span><span class="hs-layout">,</span><span class="hs-varid">zs</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">break</span> <span class="hs-varid">p</span> <span class="hs-varid">xs</span>
<a name="line-173"></a>
<a name="line-174"></a><a name="mungePackagePaths"></a><span class="hs-definition">mungePackagePaths</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">FilePath</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">InstalledPackageInfo</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">InstalledPackageInfo</span>
<a name="line-175"></a><span class="hs-comment">-- Perform path/URL variable substitution as per the Cabal ${pkgroot} spec</span>
<a name="line-176"></a><span class="hs-comment">-- (<a href="http://www.haskell.org/pipermail/libraries/2009-May/011772.html)">http://www.haskell.org/pipermail/libraries/2009-May/011772.html)</a></span>
<a name="line-177"></a><span class="hs-comment">-- Paths/URLs can be relative to ${pkgroot} or ${pkgrooturl}.</span>
<a name="line-178"></a><span class="hs-comment">-- The &quot;pkgroot&quot; is the directory containing the package database.</span>
<a name="line-179"></a><span class="hs-definition">mungePackagePaths</span> <span class="hs-varid">pkgroot</span> <span class="hs-varid">pkginfo</span> <span class="hs-keyglyph">=</span>
<a name="line-180"></a>    <span class="hs-varid">pkginfo</span> <span class="hs-layout">{</span>
<a name="line-181"></a>      <span class="hs-varid">importDirs</span>        <span class="hs-keyglyph">=</span> <span class="hs-varid">mungePaths</span> <span class="hs-layout">(</span><span class="hs-varid">importDirs</span>  <span class="hs-varid">pkginfo</span><span class="hs-layout">)</span><span class="hs-layout">,</span>
<a name="line-182"></a>      <span class="hs-varid">includeDirs</span>       <span class="hs-keyglyph">=</span> <span class="hs-varid">mungePaths</span> <span class="hs-layout">(</span><span class="hs-varid">includeDirs</span> <span class="hs-varid">pkginfo</span><span class="hs-layout">)</span><span class="hs-layout">,</span>
<a name="line-183"></a>      <span class="hs-varid">libraryDirs</span>       <span class="hs-keyglyph">=</span> <span class="hs-varid">mungePaths</span> <span class="hs-layout">(</span><span class="hs-varid">libraryDirs</span> <span class="hs-varid">pkginfo</span><span class="hs-layout">)</span><span class="hs-layout">,</span>
<a name="line-184"></a>      <span class="hs-varid">frameworkDirs</span>     <span class="hs-keyglyph">=</span> <span class="hs-varid">mungePaths</span> <span class="hs-layout">(</span><span class="hs-varid">frameworkDirs</span> <span class="hs-varid">pkginfo</span><span class="hs-layout">)</span><span class="hs-layout">,</span>
<a name="line-185"></a>      <span class="hs-varid">haddockInterfaces</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">mungePaths</span> <span class="hs-layout">(</span><span class="hs-varid">haddockInterfaces</span> <span class="hs-varid">pkginfo</span><span class="hs-layout">)</span><span class="hs-layout">,</span>
<a name="line-186"></a>      <span class="hs-varid">haddockHTMLs</span>      <span class="hs-keyglyph">=</span> <span class="hs-varid">mungeUrls</span>  <span class="hs-layout">(</span><span class="hs-varid">haddockHTMLs</span> <span class="hs-varid">pkginfo</span><span class="hs-layout">)</span>
<a name="line-187"></a>    <span class="hs-layout">}</span>
<a name="line-188"></a>  <span class="hs-keyword">where</span>
<a name="line-189"></a>    <span class="hs-varid">mungePaths</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">map</span> <span class="hs-varid">mungePath</span>
<a name="line-190"></a>    <span class="hs-varid">mungeUrls</span>  <span class="hs-keyglyph">=</span> <span class="hs-varid">map</span> <span class="hs-varid">mungeUrl</span>
<a name="line-191"></a>
<a name="line-192"></a>    <span class="hs-varid">mungePath</span> <span class="hs-varid">p</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-varid">stripVarPrefix</span> <span class="hs-str">&quot;${pkgroot}&quot;</span> <span class="hs-varid">p</span> <span class="hs-keyword">of</span>
<a name="line-193"></a>      <span class="hs-conid">Just</span> <span class="hs-varid">p'</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">pkgroot</span> <span class="hs-varop">&lt;/&gt;</span> <span class="hs-varid">p'</span>
<a name="line-194"></a>      <span class="hs-conid">Nothing</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">p</span>
<a name="line-195"></a>
<a name="line-196"></a>    <span class="hs-varid">mungeUrl</span> <span class="hs-varid">p</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-varid">stripVarPrefix</span> <span class="hs-str">&quot;${pkgrooturl}&quot;</span> <span class="hs-varid">p</span> <span class="hs-keyword">of</span>
<a name="line-197"></a>      <span class="hs-conid">Just</span> <span class="hs-varid">p'</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">toUrlPath</span> <span class="hs-varid">pkgroot</span> <span class="hs-varid">p'</span>
<a name="line-198"></a>      <span class="hs-conid">Nothing</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">p</span>
<a name="line-199"></a>
<a name="line-200"></a>    <span class="hs-varid">toUrlPath</span> <span class="hs-varid">r</span> <span class="hs-varid">p</span> <span class="hs-keyglyph">=</span> <span class="hs-str">&quot;file:///&quot;</span>
<a name="line-201"></a>                 <span class="hs-comment">-- URLs always use posix style '/' separators:</span>
<a name="line-202"></a>                 <span class="hs-varop">++</span> <span class="hs-conid">FilePath</span><span class="hs-varop">.</span><span class="hs-conid">Posix</span><span class="hs-varop">.</span><span class="hs-varid">joinPath</span> <span class="hs-layout">(</span><span class="hs-varid">r</span> <span class="hs-conop">:</span> <span class="hs-conid">FilePath</span><span class="hs-varop">.</span><span class="hs-varid">splitDirectories</span> <span class="hs-varid">p</span><span class="hs-layout">)</span>
<a name="line-203"></a>
<a name="line-204"></a>    <span class="hs-varid">stripVarPrefix</span> <span class="hs-varid">var</span> <span class="hs-varid">p</span> <span class="hs-keyglyph">=</span>
<a name="line-205"></a>      <span class="hs-keyword">case</span> <span class="hs-varid">splitPath</span> <span class="hs-varid">p</span> <span class="hs-keyword">of</span>
<a name="line-206"></a>        <span class="hs-layout">(</span><span class="hs-varid">root</span><span class="hs-conop">:</span><span class="hs-varid">path'</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyword">case</span> <span class="hs-varid">stripPrefix</span> <span class="hs-varid">var</span> <span class="hs-varid">root</span> <span class="hs-keyword">of</span>
<a name="line-207"></a>          <span class="hs-conid">Just</span> <span class="hs-keyglyph">[</span><span class="hs-varid">sep</span><span class="hs-keyglyph">]</span> <span class="hs-keyglyph">|</span> <span class="hs-varid">isPathSeparator</span> <span class="hs-varid">sep</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Just</span> <span class="hs-layout">(</span><span class="hs-varid">joinPath</span> <span class="hs-varid">path'</span><span class="hs-layout">)</span>
<a name="line-208"></a>          <span class="hs-keyword">_</span>                                <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Nothing</span>
<a name="line-209"></a>        <span class="hs-keyword">_</span>                                  <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Nothing</span>
<a name="line-210"></a>
<a name="line-211"></a>
<a name="line-212"></a><a name="setInstalledPackageId"></a><span class="hs-comment">-- Older installed package info files did not have the installedPackageId</span>
<a name="line-213"></a><span class="hs-comment">-- field, so if it is missing then we fill it as the source package ID.</span>
<a name="line-214"></a><span class="hs-definition">setInstalledPackageId</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">InstalledPackageInfo</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">InstalledPackageInfo</span>
<a name="line-215"></a><span class="hs-definition">setInstalledPackageId</span> <span class="hs-varid">pkginfo</span><span class="hs-keyglyph">@</span><span class="hs-conid">InstalledPackageInfo</span> <span class="hs-layout">{</span>
<a name="line-216"></a>                        <span class="hs-varid">installedPackageId</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">InstalledPackageId</span> <span class="hs-str">&quot;&quot;</span><span class="hs-layout">,</span>
<a name="line-217"></a>                        <span class="hs-varid">sourcePackageId</span>    <span class="hs-keyglyph">=</span> <span class="hs-varid">pkgid</span>
<a name="line-218"></a>                      <span class="hs-layout">}</span>
<a name="line-219"></a>                    <span class="hs-keyglyph">=</span> <span class="hs-varid">pkginfo</span> <span class="hs-layout">{</span>
<a name="line-220"></a>                        <span class="hs-comment">--TODO use a proper named function for the conversion</span>
<a name="line-221"></a>                        <span class="hs-comment">-- from source package id to installed package id</span>
<a name="line-222"></a>                        <span class="hs-varid">installedPackageId</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">InstalledPackageId</span> <span class="hs-layout">(</span><span class="hs-varid">display</span> <span class="hs-varid">pkgid</span><span class="hs-layout">)</span>
<a name="line-223"></a>                      <span class="hs-layout">}</span>
<a name="line-224"></a><span class="hs-definition">setInstalledPackageId</span> <span class="hs-varid">pkginfo</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">pkginfo</span>
<a name="line-225"></a>
<a name="line-226"></a>
<a name="line-227"></a><span class="hs-comment">--------------------------</span>
<a name="line-228"></a><span class="hs-comment">-- The program invocations</span>
<a name="line-229"></a><span class="hs-comment">--</span>
<a name="line-230"></a>
<a name="line-231"></a><a name="registerInvocation"></a><span class="hs-definition">registerInvocation</span><span class="hs-layout">,</span> <span class="hs-varid">reregisterInvocation</span>
<a name="line-232"></a>  <span class="hs-keyglyph">::</span> <span class="hs-conid">ConfiguredProgram</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Verbosity</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">PackageDBStack</span>
<a name="line-233"></a>  <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Either</span> <span class="hs-conid">FilePath</span> <span class="hs-conid">InstalledPackageInfo</span>
<a name="line-234"></a>  <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">ProgramInvocation</span>
<a name="line-235"></a><span class="hs-definition">registerInvocation</span>   <span class="hs-keyglyph">=</span> <span class="hs-varid">registerInvocation'</span> <span class="hs-str">&quot;register&quot;</span>
<a name="line-236"></a><a name="reregisterInvocation"></a><span class="hs-definition">reregisterInvocation</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">registerInvocation'</span> <span class="hs-str">&quot;update&quot;</span>
<a name="line-237"></a>
<a name="line-238"></a>
<a name="line-239"></a><a name="registerInvocation'"></a><span class="hs-definition">registerInvocation'</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">String</span>
<a name="line-240"></a>                    <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">ConfiguredProgram</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Verbosity</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">PackageDBStack</span>
<a name="line-241"></a>                    <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Either</span> <span class="hs-conid">FilePath</span> <span class="hs-conid">InstalledPackageInfo</span>
<a name="line-242"></a>                    <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">ProgramInvocation</span>
<a name="line-243"></a><span class="hs-definition">registerInvocation'</span> <span class="hs-varid">cmdname</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">verbosity</span> <span class="hs-varid">packagedbs</span> <span class="hs-layout">(</span><span class="hs-conid">Left</span> <span class="hs-varid">pkgFile</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span>
<a name="line-244"></a>    <span class="hs-varid">programInvocation</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">args</span>
<a name="line-245"></a>  <span class="hs-keyword">where</span>
<a name="line-246"></a>    <span class="hs-varid">args</span> <span class="hs-keyglyph">=</span> <span class="hs-keyglyph">[</span><span class="hs-varid">cmdname</span><span class="hs-layout">,</span> <span class="hs-varid">pkgFile</span><span class="hs-keyglyph">]</span>
<a name="line-247"></a>        <span class="hs-varop">++</span> <span class="hs-layout">(</span><span class="hs-keyword">if</span> <span class="hs-varid">legacyVersion</span> <span class="hs-varid">hcPkg</span>
<a name="line-248"></a>              <span class="hs-keyword">then</span> <span class="hs-keyglyph">[</span><span class="hs-varid">packageDbOpts</span> <span class="hs-varid">hcPkg</span> <span class="hs-layout">(</span><span class="hs-varid">last</span> <span class="hs-varid">packagedbs</span><span class="hs-layout">)</span><span class="hs-keyglyph">]</span>
<a name="line-249"></a>              <span class="hs-keyword">else</span> <span class="hs-varid">packageDbStackOpts</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">packagedbs</span><span class="hs-layout">)</span>
<a name="line-250"></a>        <span class="hs-varop">++</span> <span class="hs-varid">verbosityOpts</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">verbosity</span>
<a name="line-251"></a>
<a name="line-252"></a><span class="hs-definition">registerInvocation'</span> <span class="hs-varid">cmdname</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">verbosity</span> <span class="hs-varid">packagedbs</span> <span class="hs-layout">(</span><span class="hs-conid">Right</span> <span class="hs-varid">pkgInfo</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span>
<a name="line-253"></a>    <span class="hs-layout">(</span><span class="hs-varid">programInvocation</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">args</span><span class="hs-layout">)</span> <span class="hs-layout">{</span>
<a name="line-254"></a>      <span class="hs-varid">progInvokeInput</span>         <span class="hs-keyglyph">=</span> <span class="hs-conid">Just</span> <span class="hs-layout">(</span><span class="hs-varid">showInstalledPackageInfo</span> <span class="hs-varid">pkgInfo</span><span class="hs-layout">)</span><span class="hs-layout">,</span>
<a name="line-255"></a>      <span class="hs-varid">progInvokeInputEncoding</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">IOEncodingUTF8</span>
<a name="line-256"></a>    <span class="hs-layout">}</span>
<a name="line-257"></a>  <span class="hs-keyword">where</span>
<a name="line-258"></a>    <span class="hs-varid">args</span> <span class="hs-keyglyph">=</span> <span class="hs-keyglyph">[</span><span class="hs-varid">cmdname</span><span class="hs-layout">,</span> <span class="hs-str">&quot;-&quot;</span><span class="hs-keyglyph">]</span>
<a name="line-259"></a>        <span class="hs-varop">++</span> <span class="hs-layout">(</span><span class="hs-keyword">if</span> <span class="hs-varid">legacyVersion</span> <span class="hs-varid">hcPkg</span>
<a name="line-260"></a>              <span class="hs-keyword">then</span> <span class="hs-keyglyph">[</span><span class="hs-varid">packageDbOpts</span> <span class="hs-varid">hcPkg</span> <span class="hs-layout">(</span><span class="hs-varid">last</span> <span class="hs-varid">packagedbs</span><span class="hs-layout">)</span><span class="hs-keyglyph">]</span>
<a name="line-261"></a>              <span class="hs-keyword">else</span> <span class="hs-varid">packageDbStackOpts</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">packagedbs</span><span class="hs-layout">)</span>
<a name="line-262"></a>        <span class="hs-varop">++</span> <span class="hs-varid">verbosityOpts</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">verbosity</span>
<a name="line-263"></a>
<a name="line-264"></a>
<a name="line-265"></a><a name="unregisterInvocation"></a><span class="hs-definition">unregisterInvocation</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">ConfiguredProgram</span>
<a name="line-266"></a>                     <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Verbosity</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">PackageDB</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">PackageId</span>
<a name="line-267"></a>                     <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">ProgramInvocation</span>
<a name="line-268"></a><span class="hs-definition">unregisterInvocation</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">verbosity</span> <span class="hs-varid">packagedb</span> <span class="hs-varid">pkgid</span> <span class="hs-keyglyph">=</span>
<a name="line-269"></a>  <span class="hs-varid">programInvocation</span> <span class="hs-varid">hcPkg</span> <span class="hs-varop">$</span>
<a name="line-270"></a>       <span class="hs-keyglyph">[</span><span class="hs-str">&quot;unregister&quot;</span><span class="hs-layout">,</span> <span class="hs-varid">packageDbOpts</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">packagedb</span><span class="hs-layout">,</span> <span class="hs-varid">display</span> <span class="hs-varid">pkgid</span><span class="hs-keyglyph">]</span>
<a name="line-271"></a>    <span class="hs-varop">++</span> <span class="hs-varid">verbosityOpts</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">verbosity</span>
<a name="line-272"></a>
<a name="line-273"></a>
<a name="line-274"></a><a name="exposeInvocation"></a><span class="hs-definition">exposeInvocation</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">ConfiguredProgram</span>
<a name="line-275"></a>                 <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Verbosity</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">PackageDB</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">PackageId</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">ProgramInvocation</span>
<a name="line-276"></a><span class="hs-definition">exposeInvocation</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">verbosity</span> <span class="hs-varid">packagedb</span> <span class="hs-varid">pkgid</span> <span class="hs-keyglyph">=</span>
<a name="line-277"></a>  <span class="hs-varid">programInvocation</span> <span class="hs-varid">hcPkg</span> <span class="hs-varop">$</span>
<a name="line-278"></a>       <span class="hs-keyglyph">[</span><span class="hs-str">&quot;expose&quot;</span><span class="hs-layout">,</span> <span class="hs-varid">packageDbOpts</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">packagedb</span><span class="hs-layout">,</span> <span class="hs-varid">display</span> <span class="hs-varid">pkgid</span><span class="hs-keyglyph">]</span>
<a name="line-279"></a>    <span class="hs-varop">++</span> <span class="hs-varid">verbosityOpts</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">verbosity</span>
<a name="line-280"></a>
<a name="line-281"></a>
<a name="line-282"></a><a name="hideInvocation"></a><span class="hs-definition">hideInvocation</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">ConfiguredProgram</span>
<a name="line-283"></a>               <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Verbosity</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">PackageDB</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">PackageId</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">ProgramInvocation</span>
<a name="line-284"></a><span class="hs-definition">hideInvocation</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">verbosity</span> <span class="hs-varid">packagedb</span> <span class="hs-varid">pkgid</span> <span class="hs-keyglyph">=</span>
<a name="line-285"></a>  <span class="hs-varid">programInvocation</span> <span class="hs-varid">hcPkg</span> <span class="hs-varop">$</span>
<a name="line-286"></a>       <span class="hs-keyglyph">[</span><span class="hs-str">&quot;hide&quot;</span><span class="hs-layout">,</span> <span class="hs-varid">packageDbOpts</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">packagedb</span><span class="hs-layout">,</span> <span class="hs-varid">display</span> <span class="hs-varid">pkgid</span><span class="hs-keyglyph">]</span>
<a name="line-287"></a>    <span class="hs-varop">++</span> <span class="hs-varid">verbosityOpts</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">verbosity</span>
<a name="line-288"></a>
<a name="line-289"></a>
<a name="line-290"></a><a name="dumpInvocation"></a><span class="hs-definition">dumpInvocation</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">ConfiguredProgram</span>
<a name="line-291"></a>               <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Verbosity</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">PackageDB</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">ProgramInvocation</span>
<a name="line-292"></a><span class="hs-definition">dumpInvocation</span> <span class="hs-varid">hcPkg</span> <span class="hs-sel">_verbosity</span> <span class="hs-varid">packagedb</span> <span class="hs-keyglyph">=</span>
<a name="line-293"></a>    <span class="hs-layout">(</span><span class="hs-varid">programInvocation</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">args</span><span class="hs-layout">)</span> <span class="hs-layout">{</span>
<a name="line-294"></a>      <span class="hs-varid">progInvokeOutputEncoding</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">IOEncodingUTF8</span>
<a name="line-295"></a>    <span class="hs-layout">}</span>
<a name="line-296"></a>  <span class="hs-keyword">where</span>
<a name="line-297"></a>    <span class="hs-varid">args</span> <span class="hs-keyglyph">=</span> <span class="hs-keyglyph">[</span><span class="hs-str">&quot;dump&quot;</span><span class="hs-layout">,</span> <span class="hs-varid">packageDbOpts</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">packagedb</span><span class="hs-keyglyph">]</span>
<a name="line-298"></a>        <span class="hs-varop">++</span> <span class="hs-varid">verbosityOpts</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">silent</span>
<a name="line-299"></a>           <span class="hs-comment">-- We use verbosity level 'silent' because it is important that we</span>
<a name="line-300"></a>           <span class="hs-comment">-- do not contaminate the output with info/debug messages.</span>
<a name="line-301"></a>
<a name="line-302"></a>
<a name="line-303"></a><a name="packageDbStackOpts"></a><span class="hs-definition">packageDbStackOpts</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">ConfiguredProgram</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">PackageDBStack</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyglyph">[</span><span class="hs-conid">String</span><span class="hs-keyglyph">]</span>
<a name="line-304"></a><span class="hs-definition">packageDbStackOpts</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">dbstack</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-varid">dbstack</span> <span class="hs-keyword">of</span>
<a name="line-305"></a>  <span class="hs-layout">(</span><span class="hs-conid">GlobalPackageDB</span><span class="hs-conop">:</span><span class="hs-conid">UserPackageDB</span><span class="hs-conop">:</span><span class="hs-varid">dbs</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-str">&quot;--global&quot;</span>
<a name="line-306"></a>                                       <span class="hs-conop">:</span> <span class="hs-str">&quot;--user&quot;</span>
<a name="line-307"></a>                                       <span class="hs-conop">:</span> <span class="hs-varid">map</span> <span class="hs-varid">specific</span> <span class="hs-varid">dbs</span>
<a name="line-308"></a>  <span class="hs-layout">(</span><span class="hs-conid">GlobalPackageDB</span><span class="hs-conop">:</span><span class="hs-varid">dbs</span><span class="hs-layout">)</span>               <span class="hs-keyglyph">-&gt;</span> <span class="hs-str">&quot;--global&quot;</span>
<a name="line-309"></a>                                       <span class="hs-conop">:</span> <span class="hs-layout">(</span><span class="hs-str">&quot;--no-user-&quot;</span> <span class="hs-varop">++</span> <span class="hs-varid">packageDbFlag</span> <span class="hs-varid">hcPkg</span><span class="hs-layout">)</span>
<a name="line-310"></a>                                       <span class="hs-conop">:</span> <span class="hs-varid">map</span> <span class="hs-varid">specific</span> <span class="hs-varid">dbs</span>
<a name="line-311"></a>  <span class="hs-keyword">_</span>                                   <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">ierror</span>
<a name="line-312"></a>  <span class="hs-keyword">where</span>
<a name="line-313"></a>    <span class="hs-varid">specific</span> <span class="hs-layout">(</span><span class="hs-conid">SpecificPackageDB</span> <span class="hs-varid">db</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-str">&quot;--&quot;</span> <span class="hs-varop">++</span> <span class="hs-varid">packageDbFlag</span> <span class="hs-varid">hcPkg</span> <span class="hs-varop">++</span> <span class="hs-str">&quot;=&quot;</span> <span class="hs-varop">++</span> <span class="hs-varid">db</span>
<a name="line-314"></a>    <span class="hs-varid">specific</span> <span class="hs-keyword">_</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">ierror</span>
<a name="line-315"></a>    <span class="hs-varid">ierror</span> <span class="hs-keyglyph">::</span> <span class="hs-varid">a</span>
<a name="line-316"></a>    <span class="hs-varid">ierror</span>     <span class="hs-keyglyph">=</span> <span class="hs-varid">error</span> <span class="hs-layout">(</span><span class="hs-str">&quot;internal error: unexpected package db stack: &quot;</span> <span class="hs-varop">++</span> <span class="hs-varid">show</span> <span class="hs-varid">dbstack</span><span class="hs-layout">)</span>
<a name="line-317"></a>
<a name="line-318"></a><a name="packageDbFlag"></a><span class="hs-definition">packageDbFlag</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">ConfiguredProgram</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">String</span>
<a name="line-319"></a><span class="hs-definition">packageDbFlag</span> <span class="hs-varid">hcPkg</span>
<a name="line-320"></a>  <span class="hs-keyglyph">|</span> <span class="hs-varid">programVersion</span> <span class="hs-varid">hcPkg</span> <span class="hs-varop">&lt;</span> <span class="hs-conid">Just</span> <span class="hs-layout">(</span><span class="hs-conid">Version</span> <span class="hs-keyglyph">[</span><span class="hs-num">7</span><span class="hs-layout">,</span><span class="hs-num">5</span><span class="hs-keyglyph">]</span> <span class="hs-conid">[]</span><span class="hs-layout">)</span>
<a name="line-321"></a>  <span class="hs-keyglyph">=</span> <span class="hs-str">&quot;package-conf&quot;</span>
<a name="line-322"></a>  <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span>
<a name="line-323"></a>  <span class="hs-keyglyph">=</span> <span class="hs-str">&quot;package-db&quot;</span>
<a name="line-324"></a>
<a name="line-325"></a><a name="packageDbOpts"></a><span class="hs-definition">packageDbOpts</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">ConfiguredProgram</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">PackageDB</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">String</span>
<a name="line-326"></a><span class="hs-definition">packageDbOpts</span> <span class="hs-keyword">_</span> <span class="hs-conid">GlobalPackageDB</span>        <span class="hs-keyglyph">=</span> <span class="hs-str">&quot;--global&quot;</span>
<a name="line-327"></a><span class="hs-definition">packageDbOpts</span> <span class="hs-keyword">_</span> <span class="hs-conid">UserPackageDB</span>          <span class="hs-keyglyph">=</span> <span class="hs-str">&quot;--user&quot;</span>
<a name="line-328"></a><span class="hs-definition">packageDbOpts</span> <span class="hs-varid">hcPkg</span> <span class="hs-layout">(</span><span class="hs-conid">SpecificPackageDB</span> <span class="hs-varid">db</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-str">&quot;--&quot;</span> <span class="hs-varop">++</span> <span class="hs-varid">packageDbFlag</span> <span class="hs-varid">hcPkg</span> <span class="hs-varop">++</span> <span class="hs-str">&quot;=&quot;</span> <span class="hs-varop">++</span> <span class="hs-varid">db</span>
<a name="line-329"></a>
<a name="line-330"></a><a name="verbosityOpts"></a><span class="hs-definition">verbosityOpts</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">ConfiguredProgram</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Verbosity</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyglyph">[</span><span class="hs-conid">String</span><span class="hs-keyglyph">]</span>
<a name="line-331"></a><span class="hs-definition">verbosityOpts</span> <span class="hs-varid">hcPkg</span> <span class="hs-varid">v</span>
<a name="line-332"></a>
<a name="line-333"></a>  <span class="hs-comment">-- ghc-pkg &lt; 6.11 does not support -v</span>
<a name="line-334"></a>  <span class="hs-keyglyph">|</span> <span class="hs-varid">programId</span> <span class="hs-varid">hcPkg</span> <span class="hs-varop">==</span> <span class="hs-str">&quot;ghc-pkg&quot;</span>
<a name="line-335"></a> <span class="hs-varop">&amp;&amp;</span> <span class="hs-varid">programVersion</span> <span class="hs-varid">hcPkg</span> <span class="hs-varop">&lt;</span> <span class="hs-conid">Just</span> <span class="hs-layout">(</span><span class="hs-conid">Version</span> <span class="hs-keyglyph">[</span><span class="hs-num">6</span><span class="hs-layout">,</span><span class="hs-num">11</span><span class="hs-keyglyph">]</span> <span class="hs-conid">[]</span><span class="hs-layout">)</span>
<a name="line-336"></a>                   <span class="hs-keyglyph">=</span> <span class="hs-conid">[]</span>
<a name="line-337"></a>
<a name="line-338"></a>  <span class="hs-keyglyph">|</span> <span class="hs-varid">v</span> <span class="hs-varop">&gt;=</span> <span class="hs-varid">deafening</span> <span class="hs-keyglyph">=</span> <span class="hs-keyglyph">[</span><span class="hs-str">&quot;-v2&quot;</span><span class="hs-keyglyph">]</span>
<a name="line-339"></a>  <span class="hs-keyglyph">|</span> <span class="hs-varid">v</span> <span class="hs-varop">==</span> <span class="hs-varid">silent</span>    <span class="hs-keyglyph">=</span> <span class="hs-keyglyph">[</span><span class="hs-str">&quot;-v0&quot;</span><span class="hs-keyglyph">]</span>
<a name="line-340"></a>  <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span>      <span class="hs-keyglyph">=</span> <span class="hs-conid">[]</span>
<a name="line-341"></a>
<a name="line-342"></a><a name="legacyVersion"></a><span class="hs-comment">-- Handle quirks in ghc-pkg 6.8 and older</span>
<a name="line-343"></a><span class="hs-definition">legacyVersion</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">ConfiguredProgram</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Bool</span>
<a name="line-344"></a><span class="hs-definition">legacyVersion</span> <span class="hs-varid">hcPkg</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">programId</span> <span class="hs-varid">hcPkg</span> <span class="hs-varop">==</span> <span class="hs-str">&quot;ghc-pkg&quot;</span>
<a name="line-345"></a>                   <span class="hs-varop">&amp;&amp;</span> <span class="hs-varid">programVersion</span> <span class="hs-varid">hcPkg</span> <span class="hs-varop">&lt;</span> <span class="hs-conid">Just</span> <span class="hs-layout">(</span><span class="hs-conid">Version</span> <span class="hs-keyglyph">[</span><span class="hs-num">6</span><span class="hs-layout">,</span><span class="hs-num">9</span><span class="hs-keyglyph">]</span> <span class="hs-conid">[]</span><span class="hs-layout">)</span>
</pre></body>
</html>
