<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Float.lhs</title>
<link type="text/css" rel="stylesheet" href="hscolour.css"></link>
</head>
<body>
\begin{code}
<pre><a name="line-1"></a><span class="hs-comment">{-# LANGUAGE Trustworthy #-}</span>
<a name="line-2"></a><span class="hs-comment">{-# LANGUAGE CPP
<a name="line-3"></a>           , NoImplicitPrelude
<a name="line-4"></a>           , MagicHash
<a name="line-5"></a>           , UnboxedTuples
<a name="line-6"></a>           , ForeignFunctionInterface
<a name="line-7"></a>  #-}</span>
<a name="line-8"></a><span class="hs-comment">-- We believe we could deorphan this module, by moving lots of things</span>
<a name="line-9"></a><span class="hs-comment">-- around, but we haven't got there yet:</span>
<a name="line-10"></a><span class="hs-comment">{-# OPTIONS_GHC -fno-warn-orphans #-}</span>
<a name="line-11"></a><span class="hs-comment">{-# OPTIONS_HADDOCK hide #-}</span>
<a name="line-12"></a>
<a name="line-13"></a><span class="hs-comment">-----------------------------------------------------------------------------</span>
<a name="line-14"></a><span class="hs-comment">-- |</span>
<a name="line-15"></a><span class="hs-comment">-- Module      :  GHC.Float</span>
<a name="line-16"></a><span class="hs-comment">-- Copyright   :  (c) The University of Glasgow 1994-2002</span>
<a name="line-17"></a><span class="hs-comment">--                Portions obtained from hbc (c) Lennart Augusstson</span>
<a name="line-18"></a><span class="hs-comment">-- License     :  see libraries/base/LICENSE</span>
<a name="line-19"></a><span class="hs-comment">--</span>
<a name="line-20"></a><span class="hs-comment">-- Maintainer  :  cvs-ghc@haskell.org</span>
<a name="line-21"></a><span class="hs-comment">-- Stability   :  internal</span>
<a name="line-22"></a><span class="hs-comment">-- Portability :  non-portable (GHC Extensions)</span>
<a name="line-23"></a><span class="hs-comment">--</span>
<a name="line-24"></a><span class="hs-comment">-- The types 'Float' and 'Double', and the classes 'Floating' and 'RealFloat'.</span>
<a name="line-25"></a><span class="hs-comment">--</span>
<a name="line-26"></a><span class="hs-comment">-----------------------------------------------------------------------------</span>
<a name="line-27"></a>
<a name="line-28"></a><span class="hs-cpp">#include &quot;ieee-flpt.h&quot;</span>
<a name="line-29"></a>
<a name="line-30"></a><span class="hs-comment">-- #hide</span>
<a name="line-31"></a><span class="hs-keyword">module</span> <span class="hs-conid">GHC</span><span class="hs-varop">.</span><span class="hs-conid">Float</span><span class="hs-layout">(</span> <span class="hs-keyword">module</span> <span class="hs-conid">GHC</span><span class="hs-varop">.</span><span class="hs-conid">Float</span><span class="hs-layout">,</span> <span class="hs-conid">Float</span><span class="hs-layout">(</span><span class="hs-keyglyph">..</span><span class="hs-layout">)</span><span class="hs-layout">,</span> <span class="hs-conid">Double</span><span class="hs-layout">(</span><span class="hs-keyglyph">..</span><span class="hs-layout">)</span><span class="hs-layout">,</span> <span class="hs-conid">Float</span><span class="hs-cpp">#</span><span class="hs-layout">,</span> <span class="hs-conid">Double</span><span class="hs-cpp">#</span>
<a name="line-32"></a>                <span class="hs-layout">,</span> <span class="hs-varid">double2Int</span><span class="hs-layout">,</span> <span class="hs-varid">int2Double</span><span class="hs-layout">,</span> <span class="hs-varid">float2Int</span><span class="hs-layout">,</span> <span class="hs-varid">int2Float</span> <span class="hs-layout">)</span>
<a name="line-33"></a>    <span class="hs-keyword">where</span>
<a name="line-34"></a>
<a name="line-35"></a><span class="hs-keyword">import</span> <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">Maybe</span>
<a name="line-36"></a>
<a name="line-37"></a><span class="hs-keyword">import</span> <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">Bits</span>
<a name="line-38"></a><span class="hs-keyword">import</span> <span class="hs-conid">GHC</span><span class="hs-varop">.</span><span class="hs-conid">Base</span>
<a name="line-39"></a><span class="hs-keyword">import</span> <span class="hs-conid">GHC</span><span class="hs-varop">.</span><span class="hs-conid">List</span>
<a name="line-40"></a><span class="hs-keyword">import</span> <span class="hs-conid">GHC</span><span class="hs-varop">.</span><span class="hs-conid">Enum</span>
<a name="line-41"></a><span class="hs-keyword">import</span> <span class="hs-conid">GHC</span><span class="hs-varop">.</span><span class="hs-conid">Show</span>
<a name="line-42"></a><span class="hs-keyword">import</span> <span class="hs-conid">GHC</span><span class="hs-varop">.</span><span class="hs-conid">Num</span>
<a name="line-43"></a><span class="hs-keyword">import</span> <span class="hs-conid">GHC</span><span class="hs-varop">.</span><span class="hs-conid">Real</span>
<a name="line-44"></a><span class="hs-keyword">import</span> <span class="hs-conid">GHC</span><span class="hs-varop">.</span><span class="hs-conid">Arr</span>
<a name="line-45"></a><span class="hs-keyword">import</span> <span class="hs-conid">GHC</span><span class="hs-varop">.</span><span class="hs-conid">Float</span><span class="hs-varop">.</span><span class="hs-conid">RealFracMethods</span>
<a name="line-46"></a><span class="hs-keyword">import</span> <span class="hs-conid">GHC</span><span class="hs-varop">.</span><span class="hs-conid">Float</span><span class="hs-varop">.</span><span class="hs-conid">ConversionUtils</span>
<a name="line-47"></a><span class="hs-keyword">import</span> <span class="hs-conid">GHC</span><span class="hs-varop">.</span><span class="hs-conid">Integer</span><span class="hs-varop">.</span><span class="hs-conid">Logarithms</span> <span class="hs-layout">(</span> <span class="hs-varid">integerLogBase</span><span class="hs-cpp">#</span> <span class="hs-layout">)</span>
<a name="line-48"></a><span class="hs-keyword">import</span> <span class="hs-conid">GHC</span><span class="hs-varop">.</span><span class="hs-conid">Integer</span><span class="hs-varop">.</span><span class="hs-conid">Logarithms</span><span class="hs-varop">.</span><span class="hs-conid">Internals</span>
<a name="line-49"></a>
<a name="line-50"></a><span class="hs-keyword">infixr</span> <span class="hs-num">8</span>  <span class="hs-varop">**</span>
</pre>\end{code}

%*********************************************************
%*                                                      *
\subsection{Standard numeric classes}
%*                                                      *
%*********************************************************

\begin{code}
<pre><a name="line-1"></a><a name="Floating"></a><span class="hs-comment">-- | Trigonometric and hyperbolic functions and related functions.</span>
<a name="line-2"></a><a name="Floating"></a><span class="hs-comment">--</span>
<a name="line-3"></a><a name="Floating"></a><span class="hs-comment">-- Minimal complete definition:</span>
<a name="line-4"></a><a name="Floating"></a><span class="hs-comment">--      'pi', 'exp', 'log', 'sin', 'cos', 'sinh', 'cosh',</span>
<a name="line-5"></a><a name="Floating"></a><span class="hs-comment">--      'asin', 'acos', 'atan', 'asinh', 'acosh' and 'atanh'</span>
<a name="line-6"></a><a name="Floating"></a><span class="hs-keyword">class</span>  <span class="hs-layout">(</span><span class="hs-conid">Fractional</span> <span class="hs-varid">a</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=&gt;</span> <span class="hs-conid">Floating</span> <span class="hs-varid">a</span>  <span class="hs-keyword">where</span>
<a name="line-7"></a>    <span class="hs-varid">pi</span>                  <span class="hs-keyglyph">::</span> <span class="hs-varid">a</span>
<a name="line-8"></a>    <span class="hs-varid">exp</span><span class="hs-layout">,</span> <span class="hs-varid">log</span><span class="hs-layout">,</span> <span class="hs-varid">sqrt</span>      <span class="hs-keyglyph">::</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span>
<a name="line-9"></a>    <span class="hs-layout">(</span><span class="hs-varop">**</span><span class="hs-layout">)</span><span class="hs-layout">,</span> <span class="hs-varid">logBase</span>       <span class="hs-keyglyph">::</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span>
<a name="line-10"></a>    <span class="hs-varid">sin</span><span class="hs-layout">,</span> <span class="hs-varid">cos</span><span class="hs-layout">,</span> <span class="hs-varid">tan</span>       <span class="hs-keyglyph">::</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span>
<a name="line-11"></a>    <span class="hs-varid">asin</span><span class="hs-layout">,</span> <span class="hs-varid">acos</span><span class="hs-layout">,</span> <span class="hs-varid">atan</span>    <span class="hs-keyglyph">::</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span>
<a name="line-12"></a>    <span class="hs-varid">sinh</span><span class="hs-layout">,</span> <span class="hs-varid">cosh</span><span class="hs-layout">,</span> <span class="hs-varid">tanh</span>    <span class="hs-keyglyph">::</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span>
<a name="line-13"></a>    <span class="hs-varid">asinh</span><span class="hs-layout">,</span> <span class="hs-varid">acosh</span><span class="hs-layout">,</span> <span class="hs-varid">atanh</span> <span class="hs-keyglyph">::</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span>
<a name="line-14"></a>
<a name="line-15"></a>    <span class="hs-comment">{-# INLINE (**) #-}</span>
<a name="line-16"></a>    <span class="hs-comment">{-# INLINE logBase #-}</span>
<a name="line-17"></a>    <span class="hs-comment">{-# INLINE sqrt #-}</span>
<a name="line-18"></a>    <span class="hs-comment">{-# INLINE tan #-}</span>
<a name="line-19"></a>    <span class="hs-comment">{-# INLINE tanh #-}</span>
<a name="line-20"></a>    <span class="hs-varid">x</span> <span class="hs-varop">**</span> <span class="hs-varid">y</span>              <span class="hs-keyglyph">=</span>  <span class="hs-varid">exp</span> <span class="hs-layout">(</span><span class="hs-varid">log</span> <span class="hs-varid">x</span> <span class="hs-varop">*</span> <span class="hs-varid">y</span><span class="hs-layout">)</span>
<a name="line-21"></a>    <span class="hs-varid">logBase</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span>         <span class="hs-keyglyph">=</span>  <span class="hs-varid">log</span> <span class="hs-varid">y</span> <span class="hs-varop">/</span> <span class="hs-varid">log</span> <span class="hs-varid">x</span>
<a name="line-22"></a>    <span class="hs-varid">sqrt</span> <span class="hs-varid">x</span>              <span class="hs-keyglyph">=</span>  <span class="hs-varid">x</span> <span class="hs-varop">**</span> <span class="hs-num">0.5</span>
<a name="line-23"></a>    <span class="hs-varid">tan</span>  <span class="hs-varid">x</span>              <span class="hs-keyglyph">=</span>  <span class="hs-varid">sin</span>  <span class="hs-varid">x</span> <span class="hs-varop">/</span> <span class="hs-varid">cos</span>  <span class="hs-varid">x</span>
<a name="line-24"></a>    <span class="hs-varid">tanh</span> <span class="hs-varid">x</span>              <span class="hs-keyglyph">=</span>  <span class="hs-varid">sinh</span> <span class="hs-varid">x</span> <span class="hs-varop">/</span> <span class="hs-varid">cosh</span> <span class="hs-varid">x</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="RealFloat"></a><span class="hs-comment">-- | Efficient, machine-independent access to the components of a</span>
<a name="line-27"></a><a name="RealFloat"></a><span class="hs-comment">-- floating-point number.</span>
<a name="line-28"></a><a name="RealFloat"></a><span class="hs-comment">--</span>
<a name="line-29"></a><a name="RealFloat"></a><span class="hs-comment">-- Minimal complete definition:</span>
<a name="line-30"></a><a name="RealFloat"></a><span class="hs-comment">--      all except 'exponent', 'significand', 'scaleFloat' and 'atan2'</span>
<a name="line-31"></a><a name="RealFloat"></a><span class="hs-keyword">class</span>  <span class="hs-layout">(</span><span class="hs-conid">RealFrac</span> <span class="hs-varid">a</span><span class="hs-layout">,</span> <span class="hs-conid">Floating</span> <span class="hs-varid">a</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=&gt;</span> <span class="hs-conid">RealFloat</span> <span class="hs-varid">a</span>  <span class="hs-keyword">where</span>
<a name="line-32"></a>    <span class="hs-comment">-- | a constant function, returning the radix of the representation</span>
<a name="line-33"></a>    <span class="hs-comment">-- (often @2@)</span>
<a name="line-34"></a>    <span class="hs-varid">floatRadix</span>          <span class="hs-keyglyph">::</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Integer</span>
<a name="line-35"></a>    <span class="hs-comment">-- | a constant function, returning the number of digits of</span>
<a name="line-36"></a>    <span class="hs-comment">-- 'floatRadix' in the significand</span>
<a name="line-37"></a>    <span class="hs-varid">floatDigits</span>         <span class="hs-keyglyph">::</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int</span>
<a name="line-38"></a>    <span class="hs-comment">-- | a constant function, returning the lowest and highest values</span>
<a name="line-39"></a>    <span class="hs-comment">-- the exponent may assume</span>
<a name="line-40"></a>    <span class="hs-varid">floatRange</span>          <span class="hs-keyglyph">::</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-layout">(</span><span class="hs-conid">Int</span><span class="hs-layout">,</span><span class="hs-conid">Int</span><span class="hs-layout">)</span>
<a name="line-41"></a>    <span class="hs-comment">-- | The function 'decodeFloat' applied to a real floating-point</span>
<a name="line-42"></a>    <span class="hs-comment">-- number returns the significand expressed as an 'Integer' and an</span>
<a name="line-43"></a>    <span class="hs-comment">-- appropriately scaled exponent (an 'Int').  If @'decodeFloat' x@</span>
<a name="line-44"></a>    <span class="hs-comment">-- yields @(m,n)@, then @x@ is equal in value to @m*b^^n@, where @b@</span>
<a name="line-45"></a>    <span class="hs-comment">-- is the floating-point radix, and furthermore, either @m@ and @n@</span>
<a name="line-46"></a>    <span class="hs-comment">-- are both zero or else @b^(d-1) &lt;= 'abs' m &lt; b^d@, where @d@ is</span>
<a name="line-47"></a>    <span class="hs-comment">-- the value of @'floatDigits' x@.</span>
<a name="line-48"></a>    <span class="hs-comment">-- In particular, @'decodeFloat' 0 = (0,0)@. If the type</span>
<a name="line-49"></a>    <span class="hs-comment">-- contains a negative zero, also @'decodeFloat' (-0.0) = (0,0)@.</span>
<a name="line-50"></a>    <span class="hs-comment">-- /The result of/ @'decodeFloat' x@ /is unspecified if either of/</span>
<a name="line-51"></a>    <span class="hs-comment">-- @'isNaN' x@ /or/ @'isInfinite' x@ /is/ 'True'.</span>
<a name="line-52"></a>    <span class="hs-varid">decodeFloat</span>         <span class="hs-keyglyph">::</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-layout">(</span><span class="hs-conid">Integer</span><span class="hs-layout">,</span><span class="hs-conid">Int</span><span class="hs-layout">)</span>
<a name="line-53"></a>    <span class="hs-comment">-- | 'encodeFloat' performs the inverse of 'decodeFloat' in the</span>
<a name="line-54"></a>    <span class="hs-comment">-- sense that for finite @x@ with the exception of @-0.0@,</span>
<a name="line-55"></a>    <span class="hs-comment">-- @'uncurry' 'encodeFloat' ('decodeFloat' x) = x@.</span>
<a name="line-56"></a>    <span class="hs-comment">-- @'encodeFloat' m n@ is one of the two closest representable</span>
<a name="line-57"></a>    <span class="hs-comment">-- floating-point numbers to @m*b^^n@ (or @&amp;#177;Infinity@ if overflow</span>
<a name="line-58"></a>    <span class="hs-comment">-- occurs); usually the closer, but if @m@ contains too many bits,</span>
<a name="line-59"></a>    <span class="hs-comment">-- the result may be rounded in the wrong direction.</span>
<a name="line-60"></a>    <span class="hs-varid">encodeFloat</span>         <span class="hs-keyglyph">::</span> <span class="hs-conid">Integer</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span>
<a name="line-61"></a>    <span class="hs-comment">-- | 'exponent' corresponds to the second component of 'decodeFloat'.</span>
<a name="line-62"></a>    <span class="hs-comment">-- @'exponent' 0 = 0@ and for finite nonzero @x@,</span>
<a name="line-63"></a>    <span class="hs-comment">-- @'exponent' x = snd ('decodeFloat' x) + 'floatDigits' x@.</span>
<a name="line-64"></a>    <span class="hs-comment">-- If @x@ is a finite floating-point number, it is equal in value to</span>
<a name="line-65"></a>    <span class="hs-comment">-- @'significand' x * b ^^ 'exponent' x@, where @b@ is the</span>
<a name="line-66"></a>    <span class="hs-comment">-- floating-point radix.</span>
<a name="line-67"></a>    <span class="hs-comment">-- The behaviour is unspecified on infinite or @NaN@ values.</span>
<a name="line-68"></a>    <span class="hs-varid">exponent</span>            <span class="hs-keyglyph">::</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int</span>
<a name="line-69"></a>    <span class="hs-comment">-- | The first component of 'decodeFloat', scaled to lie in the open</span>
<a name="line-70"></a>    <span class="hs-comment">-- interval (@-1@,@1@), either @0.0@ or of absolute value @&gt;= 1\/b@,</span>
<a name="line-71"></a>    <span class="hs-comment">-- where @b@ is the floating-point radix.</span>
<a name="line-72"></a>    <span class="hs-comment">-- The behaviour is unspecified on infinite or @NaN@ values.</span>
<a name="line-73"></a>    <span class="hs-varid">significand</span>         <span class="hs-keyglyph">::</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span>
<a name="line-74"></a>    <span class="hs-comment">-- | multiplies a floating-point number by an integer power of the radix</span>
<a name="line-75"></a>    <span class="hs-varid">scaleFloat</span>          <span class="hs-keyglyph">::</span> <span class="hs-conid">Int</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span>
<a name="line-76"></a>    <span class="hs-comment">-- | 'True' if the argument is an IEEE \&quot;not-a-number\&quot; (NaN) value</span>
<a name="line-77"></a>    <span class="hs-varid">isNaN</span>               <span class="hs-keyglyph">::</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Bool</span>
<a name="line-78"></a>    <span class="hs-comment">-- | 'True' if the argument is an IEEE infinity or negative infinity</span>
<a name="line-79"></a>    <span class="hs-varid">isInfinite</span>          <span class="hs-keyglyph">::</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Bool</span>
<a name="line-80"></a>    <span class="hs-comment">-- | 'True' if the argument is too small to be represented in</span>
<a name="line-81"></a>    <span class="hs-comment">-- normalized format</span>
<a name="line-82"></a>    <span class="hs-varid">isDenormalized</span>      <span class="hs-keyglyph">::</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Bool</span>
<a name="line-83"></a>    <span class="hs-comment">-- | 'True' if the argument is an IEEE negative zero</span>
<a name="line-84"></a>    <span class="hs-varid">isNegativeZero</span>      <span class="hs-keyglyph">::</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Bool</span>
<a name="line-85"></a>    <span class="hs-comment">-- | 'True' if the argument is an IEEE floating point number</span>
<a name="line-86"></a>    <span class="hs-varid">isIEEE</span>              <span class="hs-keyglyph">::</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Bool</span>
<a name="line-87"></a>    <span class="hs-comment">-- | a version of arctangent taking two real floating-point arguments.</span>
<a name="line-88"></a>    <span class="hs-comment">-- For real floating @x@ and @y@, @'atan2' y x@ computes the angle</span>
<a name="line-89"></a>    <span class="hs-comment">-- (from the positive x-axis) of the vector from the origin to the</span>
<a name="line-90"></a>    <span class="hs-comment">-- point @(x,y)@.  @'atan2' y x@ returns a value in the range [@-pi@,</span>
<a name="line-91"></a>    <span class="hs-comment">-- @pi@].  It follows the Common Lisp semantics for the origin when</span>
<a name="line-92"></a>    <span class="hs-comment">-- signed zeroes are supported.  @'atan2' y 1@, with @y@ in a type</span>
<a name="line-93"></a>    <span class="hs-comment">-- that is 'RealFloat', should return the same value as @'atan' y@.</span>
<a name="line-94"></a>    <span class="hs-comment">-- A default definition of 'atan2' is provided, but implementors</span>
<a name="line-95"></a>    <span class="hs-comment">-- can provide a more accurate implementation.</span>
<a name="line-96"></a>    <span class="hs-varid">atan2</span>               <span class="hs-keyglyph">::</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span>
<a name="line-97"></a>
<a name="line-98"></a>
<a name="line-99"></a>    <span class="hs-varid">exponent</span> <span class="hs-varid">x</span>          <span class="hs-keyglyph">=</span>  <span class="hs-keyword">if</span> <span class="hs-varid">m</span> <span class="hs-varop">==</span> <span class="hs-num">0</span> <span class="hs-keyword">then</span> <span class="hs-num">0</span> <span class="hs-keyword">else</span> <span class="hs-varid">n</span> <span class="hs-varop">+</span> <span class="hs-varid">floatDigits</span> <span class="hs-varid">x</span>
<a name="line-100"></a>                           <span class="hs-keyword">where</span> <span class="hs-layout">(</span><span class="hs-varid">m</span><span class="hs-layout">,</span><span class="hs-varid">n</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">decodeFloat</span> <span class="hs-varid">x</span>
<a name="line-101"></a>
<a name="line-102"></a>    <span class="hs-varid">significand</span> <span class="hs-varid">x</span>       <span class="hs-keyglyph">=</span>  <span class="hs-varid">encodeFloat</span> <span class="hs-varid">m</span> <span class="hs-layout">(</span><span class="hs-varid">negate</span> <span class="hs-layout">(</span><span class="hs-varid">floatDigits</span> <span class="hs-varid">x</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-103"></a>                           <span class="hs-keyword">where</span> <span class="hs-layout">(</span><span class="hs-varid">m</span><span class="hs-layout">,</span><span class="hs-keyword">_</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">decodeFloat</span> <span class="hs-varid">x</span>
<a name="line-104"></a>
<a name="line-105"></a>    <span class="hs-varid">scaleFloat</span> <span class="hs-num">0</span> <span class="hs-varid">x</span>      <span class="hs-keyglyph">=</span>  <span class="hs-varid">x</span>
<a name="line-106"></a>    <span class="hs-varid">scaleFloat</span> <span class="hs-varid">k</span> <span class="hs-varid">x</span>
<a name="line-107"></a>      <span class="hs-keyglyph">|</span> <span class="hs-varid">isFix</span>           <span class="hs-keyglyph">=</span>  <span class="hs-varid">x</span>
<a name="line-108"></a>      <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span>       <span class="hs-keyglyph">=</span>  <span class="hs-varid">encodeFloat</span> <span class="hs-varid">m</span> <span class="hs-layout">(</span><span class="hs-varid">n</span> <span class="hs-varop">+</span> <span class="hs-varid">clamp</span> <span class="hs-varid">b</span> <span class="hs-varid">k</span><span class="hs-layout">)</span>
<a name="line-109"></a>                           <span class="hs-keyword">where</span> <span class="hs-layout">(</span><span class="hs-varid">m</span><span class="hs-layout">,</span><span class="hs-varid">n</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">decodeFloat</span> <span class="hs-varid">x</span>
<a name="line-110"></a>                                 <span class="hs-layout">(</span><span class="hs-varid">l</span><span class="hs-layout">,</span><span class="hs-varid">h</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">floatRange</span> <span class="hs-varid">x</span>
<a name="line-111"></a>                                 <span class="hs-varid">d</span>     <span class="hs-keyglyph">=</span> <span class="hs-varid">floatDigits</span> <span class="hs-varid">x</span>
<a name="line-112"></a>                                 <span class="hs-varid">b</span>     <span class="hs-keyglyph">=</span> <span class="hs-varid">h</span> <span class="hs-comment">-</span> <span class="hs-varid">l</span> <span class="hs-varop">+</span> <span class="hs-num">4</span><span class="hs-varop">*</span><span class="hs-varid">d</span>
<a name="line-113"></a>                                 <span class="hs-comment">-- n+k may overflow, which would lead</span>
<a name="line-114"></a>                                 <span class="hs-comment">-- to wrong results, hence we clamp the</span>
<a name="line-115"></a>                                 <span class="hs-comment">-- scaling parameter.</span>
<a name="line-116"></a>                                 <span class="hs-comment">-- If n + k would be larger than h,</span>
<a name="line-117"></a>                                 <span class="hs-comment">-- n + clamp b k must be too, simliar</span>
<a name="line-118"></a>                                 <span class="hs-comment">-- for smaller than l - d.</span>
<a name="line-119"></a>                                 <span class="hs-comment">-- Add a little extra to keep clear</span>
<a name="line-120"></a>                                 <span class="hs-comment">-- from the boundary cases.</span>
<a name="line-121"></a>                                 <span class="hs-varid">isFix</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">x</span> <span class="hs-varop">==</span> <span class="hs-num">0</span> <span class="hs-varop">||</span> <span class="hs-varid">isNaN</span> <span class="hs-varid">x</span> <span class="hs-varop">||</span> <span class="hs-varid">isInfinite</span> <span class="hs-varid">x</span>
<a name="line-122"></a>
<a name="line-123"></a>    <span class="hs-varid">atan2</span> <span class="hs-varid">y</span> <span class="hs-varid">x</span>
<a name="line-124"></a>      <span class="hs-keyglyph">|</span> <span class="hs-varid">x</span> <span class="hs-varop">&gt;</span> <span class="hs-num">0</span>            <span class="hs-keyglyph">=</span>  <span class="hs-varid">atan</span> <span class="hs-layout">(</span><span class="hs-varid">y</span><span class="hs-varop">/</span><span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-125"></a>      <span class="hs-keyglyph">|</span> <span class="hs-varid">x</span> <span class="hs-varop">==</span> <span class="hs-num">0</span> <span class="hs-varop">&amp;&amp;</span> <span class="hs-varid">y</span> <span class="hs-varop">&gt;</span> <span class="hs-num">0</span>  <span class="hs-keyglyph">=</span>  <span class="hs-varid">pi</span><span class="hs-varop">/</span><span class="hs-num">2</span>
<a name="line-126"></a>      <span class="hs-keyglyph">|</span> <span class="hs-varid">x</span> <span class="hs-varop">&lt;</span>  <span class="hs-num">0</span> <span class="hs-varop">&amp;&amp;</span> <span class="hs-varid">y</span> <span class="hs-varop">&gt;</span> <span class="hs-num">0</span>  <span class="hs-keyglyph">=</span>  <span class="hs-varid">pi</span> <span class="hs-varop">+</span> <span class="hs-varid">atan</span> <span class="hs-layout">(</span><span class="hs-varid">y</span><span class="hs-varop">/</span><span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-127"></a>      <span class="hs-keyglyph">|</span><span class="hs-layout">(</span><span class="hs-varid">x</span> <span class="hs-varop">&lt;=</span> <span class="hs-num">0</span> <span class="hs-varop">&amp;&amp;</span> <span class="hs-varid">y</span> <span class="hs-varop">&lt;</span> <span class="hs-num">0</span><span class="hs-layout">)</span>            <span class="hs-varop">||</span>
<a name="line-128"></a>       <span class="hs-layout">(</span><span class="hs-varid">x</span> <span class="hs-varop">&lt;</span>  <span class="hs-num">0</span> <span class="hs-varop">&amp;&amp;</span> <span class="hs-varid">isNegativeZero</span> <span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-varop">||</span>
<a name="line-129"></a>       <span class="hs-layout">(</span><span class="hs-varid">isNegativeZero</span> <span class="hs-varid">x</span> <span class="hs-varop">&amp;&amp;</span> <span class="hs-varid">isNegativeZero</span> <span class="hs-varid">y</span><span class="hs-layout">)</span>
<a name="line-130"></a>                         <span class="hs-keyglyph">=</span> <span class="hs-comment">-</span><span class="hs-varid">atan2</span> <span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-varid">x</span>
<a name="line-131"></a>      <span class="hs-keyglyph">|</span> <span class="hs-varid">y</span> <span class="hs-varop">==</span> <span class="hs-num">0</span> <span class="hs-varop">&amp;&amp;</span> <span class="hs-layout">(</span><span class="hs-varid">x</span> <span class="hs-varop">&lt;</span> <span class="hs-num">0</span> <span class="hs-varop">||</span> <span class="hs-varid">isNegativeZero</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-132"></a>                          <span class="hs-keyglyph">=</span>  <span class="hs-varid">pi</span>    <span class="hs-comment">-- must be after the previous test on zero y</span>
<a name="line-133"></a>      <span class="hs-keyglyph">|</span> <span class="hs-varid">x</span><span class="hs-varop">==</span><span class="hs-num">0</span> <span class="hs-varop">&amp;&amp;</span> <span class="hs-varid">y</span><span class="hs-varop">==</span><span class="hs-num">0</span>      <span class="hs-keyglyph">=</span>  <span class="hs-varid">y</span>     <span class="hs-comment">-- must be after the other double zero tests</span>
<a name="line-134"></a>      <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span>         <span class="hs-keyglyph">=</span>  <span class="hs-varid">x</span> <span class="hs-varop">+</span> <span class="hs-varid">y</span> <span class="hs-comment">-- x or y is a NaN, return a NaN (via +)</span>
</pre>\end{code}


%*********************************************************
%*                                                      *
\subsection{Type @Float@}
%*                                                      *
%*********************************************************

\begin{code}
<pre><a name="line-1"></a><a name="instance%20Num%20Float"></a><span class="hs-keyword">instance</span>  <span class="hs-conid">Num</span> <span class="hs-conid">Float</span>  <span class="hs-keyword">where</span>
<a name="line-2"></a>    <span class="hs-layout">(</span><span class="hs-varop">+</span><span class="hs-layout">)</span>         <span class="hs-varid">x</span> <span class="hs-varid">y</span>     <span class="hs-keyglyph">=</span>  <span class="hs-varid">plusFloat</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span>
<a name="line-3"></a>    <span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-layout">)</span>         <span class="hs-varid">x</span> <span class="hs-varid">y</span>     <span class="hs-keyglyph">=</span>  <span class="hs-varid">minusFloat</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span>
<a name="line-4"></a>    <span class="hs-varid">negate</span>      <span class="hs-varid">x</span>       <span class="hs-keyglyph">=</span>  <span class="hs-varid">negateFloat</span> <span class="hs-varid">x</span>
<a name="line-5"></a>    <span class="hs-layout">(</span><span class="hs-varop">*</span><span class="hs-layout">)</span>         <span class="hs-varid">x</span> <span class="hs-varid">y</span>     <span class="hs-keyglyph">=</span>  <span class="hs-varid">timesFloat</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span>
<a name="line-6"></a>    <span class="hs-varid">abs</span> <span class="hs-varid">x</span> <span class="hs-keyglyph">|</span> <span class="hs-varid">x</span> <span class="hs-varop">&gt;=</span> <span class="hs-num">0.0</span>    <span class="hs-keyglyph">=</span>  <span class="hs-varid">x</span>
<a name="line-7"></a>          <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span>   <span class="hs-keyglyph">=</span>  <span class="hs-varid">negateFloat</span> <span class="hs-varid">x</span>
<a name="line-8"></a>    <span class="hs-varid">signum</span> <span class="hs-varid">x</span> <span class="hs-keyglyph">|</span> <span class="hs-varid">x</span> <span class="hs-varop">==</span> <span class="hs-num">0.0</span>  <span class="hs-keyglyph">=</span> <span class="hs-num">0</span>
<a name="line-9"></a>             <span class="hs-keyglyph">|</span> <span class="hs-varid">x</span> <span class="hs-varop">&gt;</span> <span class="hs-num">0.0</span>   <span class="hs-keyglyph">=</span> <span class="hs-num">1</span>
<a name="line-10"></a>             <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">negate</span> <span class="hs-num">1</span>
<a name="line-11"></a>
<a name="line-12"></a>    <span class="hs-comment">{-# INLINE fromInteger #-}</span>
<a name="line-13"></a>    <span class="hs-varid">fromInteger</span> <span class="hs-varid">i</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">floatFromInteger</span> <span class="hs-varid">i</span><span class="hs-layout">)</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="instance%20Real%20Float"></a><span class="hs-keyword">instance</span>  <span class="hs-conid">Real</span> <span class="hs-conid">Float</span>  <span class="hs-keyword">where</span>
<a name="line-16"></a>    <span class="hs-varid">toRational</span> <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-cpp">#</span><span class="hs-layout">)</span>  <span class="hs-keyglyph">=</span>
<a name="line-17"></a>        <span class="hs-keyword">case</span> <span class="hs-varid">decodeFloat_Int</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-cpp">#</span> <span class="hs-keyword">of</span>
<a name="line-18"></a>          <span class="hs-layout">(</span><span class="hs-cpp">#</span> <span class="hs-varid">m</span><span class="hs-cpp">#</span><span class="hs-layout">,</span> <span class="hs-varid">e</span><span class="hs-cpp">#</span> <span class="hs-cpp">#</span><span class="hs-layout">)</span>
<a name="line-19"></a>            <span class="hs-keyglyph">|</span> <span class="hs-varid">e</span><span class="hs-cpp">#</span> <span class="hs-varop">&gt;=#</span> <span class="hs-num">0</span><span class="hs-cpp">#</span>                                 <span class="hs-keyglyph">-&gt;</span>
<a name="line-20"></a>                    <span class="hs-layout">(</span><span class="hs-varid">smallInteger</span> <span class="hs-varid">m</span><span class="hs-cpp">#</span> <span class="hs-varop">`shiftLInteger`</span> <span class="hs-varid">e</span><span class="hs-cpp">#</span><span class="hs-layout">)</span> <span class="hs-conop">:%</span> <span class="hs-num">1</span>
<a name="line-21"></a>            <span class="hs-keyglyph">|</span> <span class="hs-layout">(</span><span class="hs-varid">int2Word</span><span class="hs-cpp">#</span> <span class="hs-varid">m</span><span class="hs-cpp">#</span> <span class="hs-varop">`</span><span class="hs-varid">and</span><span class="hs-cpp">#</span><span class="hs-varop">`</span> <span class="hs-num">1</span><span class="hs-cpp">##</span><span class="hs-layout">)</span> <span class="hs-varop">`</span><span class="hs-varid">eqWord</span><span class="hs-cpp">#</span><span class="hs-varop">`</span> <span class="hs-num">0</span><span class="hs-cpp">##</span>   <span class="hs-keyglyph">-&gt;</span>
<a name="line-22"></a>                    <span class="hs-keyword">case</span> <span class="hs-varid">elimZerosInt</span><span class="hs-cpp">#</span> <span class="hs-varid">m</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">negateInt</span><span class="hs-cpp">#</span> <span class="hs-varid">e</span><span class="hs-cpp">#</span><span class="hs-layout">)</span> <span class="hs-keyword">of</span>
<a name="line-23"></a>                      <span class="hs-layout">(</span><span class="hs-cpp">#</span> <span class="hs-varid">n</span><span class="hs-layout">,</span> <span class="hs-varid">d</span><span class="hs-cpp">#</span> <span class="hs-cpp">#</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">n</span> <span class="hs-conop">:%</span> <span class="hs-varid">shiftLInteger</span> <span class="hs-num">1</span> <span class="hs-varid">d</span><span class="hs-cpp">#</span>
<a name="line-24"></a>            <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span>                                 <span class="hs-keyglyph">-&gt;</span>
<a name="line-25"></a>                    <span class="hs-varid">smallInteger</span> <span class="hs-varid">m</span><span class="hs-cpp">#</span> <span class="hs-conop">:%</span> <span class="hs-varid">shiftLInteger</span> <span class="hs-num">1</span> <span class="hs-layout">(</span><span class="hs-varid">negateInt</span><span class="hs-cpp">#</span> <span class="hs-varid">e</span><span class="hs-cpp">#</span><span class="hs-layout">)</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="instance%20Fractional%20Float"></a><span class="hs-keyword">instance</span>  <span class="hs-conid">Fractional</span> <span class="hs-conid">Float</span>  <span class="hs-keyword">where</span>
<a name="line-28"></a>    <span class="hs-layout">(</span><span class="hs-varop">/</span><span class="hs-layout">)</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span>             <span class="hs-keyglyph">=</span>  <span class="hs-varid">divideFloat</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span>
<a name="line-29"></a>    <span class="hs-varid">fromRational</span> <span class="hs-layout">(</span><span class="hs-varid">n</span><span class="hs-conop">:%</span><span class="hs-num">0</span><span class="hs-layout">)</span>
<a name="line-30"></a>        <span class="hs-keyglyph">|</span> <span class="hs-varid">n</span> <span class="hs-varop">==</span> <span class="hs-num">0</span>        <span class="hs-keyglyph">=</span> <span class="hs-num">0</span><span class="hs-varop">/</span><span class="hs-num">0</span>
<a name="line-31"></a>        <span class="hs-keyglyph">|</span> <span class="hs-varid">n</span> <span class="hs-varop">&lt;</span> <span class="hs-num">0</span>         <span class="hs-keyglyph">=</span> <span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-num">1</span><span class="hs-layout">)</span><span class="hs-varop">/</span><span class="hs-num">0</span>
<a name="line-32"></a>        <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span>     <span class="hs-keyglyph">=</span> <span class="hs-num">1</span><span class="hs-varop">/</span><span class="hs-num">0</span>
<a name="line-33"></a>    <span class="hs-varid">fromRational</span> <span class="hs-layout">(</span><span class="hs-varid">n</span><span class="hs-conop">:%</span><span class="hs-varid">d</span><span class="hs-layout">)</span>
<a name="line-34"></a>        <span class="hs-keyglyph">|</span> <span class="hs-varid">n</span> <span class="hs-varop">==</span> <span class="hs-num">0</span>        <span class="hs-keyglyph">=</span> <span class="hs-varid">encodeFloat</span> <span class="hs-num">0</span> <span class="hs-num">0</span>
<a name="line-35"></a>        <span class="hs-keyglyph">|</span> <span class="hs-varid">n</span> <span class="hs-varop">&lt;</span> <span class="hs-num">0</span>         <span class="hs-keyglyph">=</span> <span class="hs-comment">-</span><span class="hs-layout">(</span><span class="hs-varid">fromRat''</span> <span class="hs-varid">minEx</span> <span class="hs-varid">mantDigs</span> <span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-varid">n</span><span class="hs-layout">)</span> <span class="hs-varid">d</span><span class="hs-layout">)</span>
<a name="line-36"></a>        <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span>     <span class="hs-keyglyph">=</span> <span class="hs-varid">fromRat''</span> <span class="hs-varid">minEx</span> <span class="hs-varid">mantDigs</span> <span class="hs-varid">n</span> <span class="hs-varid">d</span>
<a name="line-37"></a>          <span class="hs-keyword">where</span>
<a name="line-38"></a>            <span class="hs-varid">minEx</span>       <span class="hs-keyglyph">=</span> <span class="hs-conid">FLT_MIN_EXP</span>
<a name="line-39"></a>            <span class="hs-varid">mantDigs</span>    <span class="hs-keyglyph">=</span> <span class="hs-conid">FLT_MANT_DIG</span>
<a name="line-40"></a>    <span class="hs-varid">recip</span> <span class="hs-varid">x</span>             <span class="hs-keyglyph">=</span>  <span class="hs-num">1.0</span> <span class="hs-varop">/</span> <span class="hs-varid">x</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="instance%20RealFrac%20Float"></a><span class="hs-comment">-- RULES for Integer and Int</span>
<a name="line-43"></a><a name="instance%20RealFrac%20Float"></a><span class="hs-comment">{-# RULES
<a name="line-44"></a>&quot;properFraction/Float-&gt;Integer&quot;     properFraction = properFractionFloatInteger
<a name="line-45"></a>&quot;truncate/Float-&gt;Integer&quot;           truncate = truncateFloatInteger
<a name="line-46"></a>&quot;floor/Float-&gt;Integer&quot;              floor = floorFloatInteger
<a name="line-47"></a>&quot;ceiling/Float-&gt;Integer&quot;            ceiling = ceilingFloatInteger
<a name="line-48"></a>&quot;round/Float-&gt;Integer&quot;              round = roundFloatInteger
<a name="line-49"></a>&quot;properFraction/Float-&gt;Int&quot;         properFraction = properFractionFloatInt
<a name="line-50"></a>&quot;truncate/Float-&gt;Int&quot;               truncate = float2Int
<a name="line-51"></a>&quot;floor/Float-&gt;Int&quot;                  floor = floorFloatInt
<a name="line-52"></a>&quot;ceiling/Float-&gt;Int&quot;                ceiling = ceilingFloatInt
<a name="line-53"></a>&quot;round/Float-&gt;Int&quot;                  round = roundFloatInt
<a name="line-54"></a>  #-}</span>
<a name="line-55"></a><a name="instance%20RealFrac%20Float"></a><span class="hs-keyword">instance</span>  <span class="hs-conid">RealFrac</span> <span class="hs-conid">Float</span>  <span class="hs-keyword">where</span>
<a name="line-56"></a>
<a name="line-57"></a>        <span class="hs-comment">-- ceiling, floor, and truncate are all small</span>
<a name="line-58"></a>    <span class="hs-comment">{-# INLINE [1] ceiling #-}</span>
<a name="line-59"></a>    <span class="hs-comment">{-# INLINE [1] floor #-}</span>
<a name="line-60"></a>    <span class="hs-comment">{-# INLINE [1] truncate #-}</span>
<a name="line-61"></a>
<a name="line-62"></a><span class="hs-comment">-- We assume that FLT_RADIX is 2 so that we can use more efficient code</span>
<a name="line-63"></a><span class="hs-cpp">#if FLT_RADIX != 2</span>
<a name="line-64"></a><span class="hs-cpp">#error FLT_RADIX must be 2</span>
<a name="line-65"></a><span class="hs-cpp">#endif</span>
<a name="line-66"></a>    <span class="hs-varid">properFraction</span> <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-cpp">#</span><span class="hs-layout">)</span>
<a name="line-67"></a>      <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-varid">decodeFloat_Int</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-cpp">#</span> <span class="hs-keyword">of</span>
<a name="line-68"></a>        <span class="hs-layout">(</span><span class="hs-cpp">#</span> <span class="hs-varid">m</span><span class="hs-cpp">#</span><span class="hs-layout">,</span> <span class="hs-varid">n</span><span class="hs-cpp">#</span> <span class="hs-cpp">#</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span>
<a name="line-69"></a>            <span class="hs-keyword">let</span> <span class="hs-varid">m</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">I</span><span class="hs-cpp">#</span> <span class="hs-varid">m</span><span class="hs-cpp">#</span>
<a name="line-70"></a>                <span class="hs-varid">n</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">I</span><span class="hs-cpp">#</span> <span class="hs-varid">n</span><span class="hs-cpp">#</span>
<a name="line-71"></a>            <span class="hs-keyword">in</span>
<a name="line-72"></a>            <span class="hs-keyword">if</span> <span class="hs-varid">n</span> <span class="hs-varop">&gt;=</span> <span class="hs-num">0</span>
<a name="line-73"></a>            <span class="hs-keyword">then</span> <span class="hs-layout">(</span><span class="hs-varid">fromIntegral</span> <span class="hs-varid">m</span> <span class="hs-varop">*</span> <span class="hs-layout">(</span><span class="hs-num">2</span> <span class="hs-varop">^</span> <span class="hs-varid">n</span><span class="hs-layout">)</span><span class="hs-layout">,</span> <span class="hs-num">0.0</span><span class="hs-layout">)</span>
<a name="line-74"></a>            <span class="hs-keyword">else</span> <span class="hs-keyword">let</span> <span class="hs-varid">i</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">if</span> <span class="hs-varid">m</span> <span class="hs-varop">&gt;=</span> <span class="hs-num">0</span> <span class="hs-keyword">then</span>                <span class="hs-varid">m</span> <span class="hs-varop">`shiftR`</span> <span class="hs-varid">negate</span> <span class="hs-varid">n</span>
<a name="line-75"></a>                                   <span class="hs-keyword">else</span> <span class="hs-varid">negate</span> <span class="hs-layout">(</span><span class="hs-varid">negate</span> <span class="hs-varid">m</span> <span class="hs-varop">`shiftR`</span> <span class="hs-varid">negate</span> <span class="hs-varid">n</span><span class="hs-layout">)</span>
<a name="line-76"></a>                     <span class="hs-varid">f</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">m</span> <span class="hs-comment">-</span> <span class="hs-layout">(</span><span class="hs-varid">i</span> <span class="hs-varop">`shiftL`</span> <span class="hs-varid">negate</span> <span class="hs-varid">n</span><span class="hs-layout">)</span>
<a name="line-77"></a>                 <span class="hs-keyword">in</span> <span class="hs-layout">(</span><span class="hs-varid">fromIntegral</span> <span class="hs-varid">i</span><span class="hs-layout">,</span> <span class="hs-varid">encodeFloat</span> <span class="hs-layout">(</span><span class="hs-varid">fromIntegral</span> <span class="hs-varid">f</span><span class="hs-layout">)</span> <span class="hs-varid">n</span><span class="hs-layout">)</span>
<a name="line-78"></a>
<a name="line-79"></a>    <span class="hs-varid">truncate</span> <span class="hs-varid">x</span>  <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-varid">properFraction</span> <span class="hs-varid">x</span> <span class="hs-keyword">of</span>
<a name="line-80"></a>                     <span class="hs-layout">(</span><span class="hs-varid">n</span><span class="hs-layout">,</span><span class="hs-keyword">_</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">n</span>
<a name="line-81"></a>
<a name="line-82"></a>    <span class="hs-varid">round</span> <span class="hs-varid">x</span>     <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-varid">properFraction</span> <span class="hs-varid">x</span> <span class="hs-keyword">of</span>
<a name="line-83"></a>                     <span class="hs-layout">(</span><span class="hs-varid">n</span><span class="hs-layout">,</span><span class="hs-varid">r</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyword">let</span>
<a name="line-84"></a>                                <span class="hs-varid">m</span>         <span class="hs-keyglyph">=</span> <span class="hs-keyword">if</span> <span class="hs-varid">r</span> <span class="hs-varop">&lt;</span> <span class="hs-num">0.0</span> <span class="hs-keyword">then</span> <span class="hs-varid">n</span> <span class="hs-comment">-</span> <span class="hs-num">1</span> <span class="hs-keyword">else</span> <span class="hs-varid">n</span> <span class="hs-varop">+</span> <span class="hs-num">1</span>
<a name="line-85"></a>                                <span class="hs-varid">half_down</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">abs</span> <span class="hs-varid">r</span> <span class="hs-comment">-</span> <span class="hs-num">0.5</span>
<a name="line-86"></a>                              <span class="hs-keyword">in</span>
<a name="line-87"></a>                              <span class="hs-keyword">case</span> <span class="hs-layout">(</span><span class="hs-varid">compare</span> <span class="hs-varid">half_down</span> <span class="hs-num">0.0</span><span class="hs-layout">)</span> <span class="hs-keyword">of</span>
<a name="line-88"></a>                                <span class="hs-conid">LT</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">n</span>
<a name="line-89"></a>                                <span class="hs-conid">EQ</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyword">if</span> <span class="hs-varid">even</span> <span class="hs-varid">n</span> <span class="hs-keyword">then</span> <span class="hs-varid">n</span> <span class="hs-keyword">else</span> <span class="hs-varid">m</span>
<a name="line-90"></a>                                <span class="hs-conid">GT</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">m</span>
<a name="line-91"></a>
<a name="line-92"></a>    <span class="hs-varid">ceiling</span> <span class="hs-varid">x</span>   <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-varid">properFraction</span> <span class="hs-varid">x</span> <span class="hs-keyword">of</span>
<a name="line-93"></a>                    <span class="hs-layout">(</span><span class="hs-varid">n</span><span class="hs-layout">,</span><span class="hs-varid">r</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyword">if</span> <span class="hs-varid">r</span> <span class="hs-varop">&gt;</span> <span class="hs-num">0.0</span> <span class="hs-keyword">then</span> <span class="hs-varid">n</span> <span class="hs-varop">+</span> <span class="hs-num">1</span> <span class="hs-keyword">else</span> <span class="hs-varid">n</span>
<a name="line-94"></a>
<a name="line-95"></a>    <span class="hs-varid">floor</span> <span class="hs-varid">x</span>     <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-varid">properFraction</span> <span class="hs-varid">x</span> <span class="hs-keyword">of</span>
<a name="line-96"></a>                    <span class="hs-layout">(</span><span class="hs-varid">n</span><span class="hs-layout">,</span><span class="hs-varid">r</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyword">if</span> <span class="hs-varid">r</span> <span class="hs-varop">&lt;</span> <span class="hs-num">0.0</span> <span class="hs-keyword">then</span> <span class="hs-varid">n</span> <span class="hs-comment">-</span> <span class="hs-num">1</span> <span class="hs-keyword">else</span> <span class="hs-varid">n</span>
<a name="line-97"></a>
<a name="line-98"></a><a name="instance%20Floating%20Float"></a><span class="hs-keyword">instance</span>  <span class="hs-conid">Floating</span> <span class="hs-conid">Float</span>  <span class="hs-keyword">where</span>
<a name="line-99"></a>    <span class="hs-varid">pi</span>                  <span class="hs-keyglyph">=</span>  <span class="hs-num">3.141592653589793238</span>
<a name="line-100"></a>    <span class="hs-varid">exp</span> <span class="hs-varid">x</span>               <span class="hs-keyglyph">=</span>  <span class="hs-varid">expFloat</span> <span class="hs-varid">x</span>
<a name="line-101"></a>    <span class="hs-varid">log</span> <span class="hs-varid">x</span>               <span class="hs-keyglyph">=</span>  <span class="hs-varid">logFloat</span> <span class="hs-varid">x</span>
<a name="line-102"></a>    <span class="hs-varid">sqrt</span> <span class="hs-varid">x</span>              <span class="hs-keyglyph">=</span>  <span class="hs-varid">sqrtFloat</span> <span class="hs-varid">x</span>
<a name="line-103"></a>    <span class="hs-varid">sin</span> <span class="hs-varid">x</span>               <span class="hs-keyglyph">=</span>  <span class="hs-varid">sinFloat</span> <span class="hs-varid">x</span>
<a name="line-104"></a>    <span class="hs-varid">cos</span> <span class="hs-varid">x</span>               <span class="hs-keyglyph">=</span>  <span class="hs-varid">cosFloat</span> <span class="hs-varid">x</span>
<a name="line-105"></a>    <span class="hs-varid">tan</span> <span class="hs-varid">x</span>               <span class="hs-keyglyph">=</span>  <span class="hs-varid">tanFloat</span> <span class="hs-varid">x</span>
<a name="line-106"></a>    <span class="hs-varid">asin</span> <span class="hs-varid">x</span>              <span class="hs-keyglyph">=</span>  <span class="hs-varid">asinFloat</span> <span class="hs-varid">x</span>
<a name="line-107"></a>    <span class="hs-varid">acos</span> <span class="hs-varid">x</span>              <span class="hs-keyglyph">=</span>  <span class="hs-varid">acosFloat</span> <span class="hs-varid">x</span>
<a name="line-108"></a>    <span class="hs-varid">atan</span> <span class="hs-varid">x</span>              <span class="hs-keyglyph">=</span>  <span class="hs-varid">atanFloat</span> <span class="hs-varid">x</span>
<a name="line-109"></a>    <span class="hs-varid">sinh</span> <span class="hs-varid">x</span>              <span class="hs-keyglyph">=</span>  <span class="hs-varid">sinhFloat</span> <span class="hs-varid">x</span>
<a name="line-110"></a>    <span class="hs-varid">cosh</span> <span class="hs-varid">x</span>              <span class="hs-keyglyph">=</span>  <span class="hs-varid">coshFloat</span> <span class="hs-varid">x</span>
<a name="line-111"></a>    <span class="hs-varid">tanh</span> <span class="hs-varid">x</span>              <span class="hs-keyglyph">=</span>  <span class="hs-varid">tanhFloat</span> <span class="hs-varid">x</span>
<a name="line-112"></a>    <span class="hs-layout">(</span><span class="hs-varop">**</span><span class="hs-layout">)</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span>            <span class="hs-keyglyph">=</span>  <span class="hs-varid">powerFloat</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span>
<a name="line-113"></a>    <span class="hs-varid">logBase</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span>         <span class="hs-keyglyph">=</span>  <span class="hs-varid">log</span> <span class="hs-varid">y</span> <span class="hs-varop">/</span> <span class="hs-varid">log</span> <span class="hs-varid">x</span>
<a name="line-114"></a>
<a name="line-115"></a>    <span class="hs-varid">asinh</span> <span class="hs-varid">x</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">log</span> <span class="hs-layout">(</span><span class="hs-varid">x</span> <span class="hs-varop">+</span> <span class="hs-varid">sqrt</span> <span class="hs-layout">(</span><span class="hs-num">1.0</span><span class="hs-varop">+</span><span class="hs-varid">x</span><span class="hs-varop">*</span><span class="hs-varid">x</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-116"></a>    <span class="hs-varid">acosh</span> <span class="hs-varid">x</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">log</span> <span class="hs-layout">(</span><span class="hs-varid">x</span> <span class="hs-varop">+</span> <span class="hs-layout">(</span><span class="hs-varid">x</span><span class="hs-varop">+</span><span class="hs-num">1.0</span><span class="hs-layout">)</span> <span class="hs-varop">*</span> <span class="hs-varid">sqrt</span> <span class="hs-layout">(</span><span class="hs-layout">(</span><span class="hs-varid">x</span><span class="hs-comment">-</span><span class="hs-num">1.0</span><span class="hs-layout">)</span><span class="hs-varop">/</span><span class="hs-layout">(</span><span class="hs-varid">x</span><span class="hs-varop">+</span><span class="hs-num">1.0</span><span class="hs-layout">)</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-117"></a>    <span class="hs-varid">atanh</span> <span class="hs-varid">x</span> <span class="hs-keyglyph">=</span> <span class="hs-num">0.5</span> <span class="hs-varop">*</span> <span class="hs-varid">log</span> <span class="hs-layout">(</span><span class="hs-layout">(</span><span class="hs-num">1.0</span><span class="hs-varop">+</span><span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-varop">/</span> <span class="hs-layout">(</span><span class="hs-num">1.0</span><span class="hs-comment">-</span><span class="hs-varid">x</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-118"></a>
<a name="line-119"></a><a name="instance%20RealFloat%20Float"></a><span class="hs-keyword">instance</span>  <span class="hs-conid">RealFloat</span> <span class="hs-conid">Float</span>  <span class="hs-keyword">where</span>
<a name="line-120"></a>    <span class="hs-varid">floatRadix</span> <span class="hs-keyword">_</span>        <span class="hs-keyglyph">=</span>  <span class="hs-conid">FLT_RADIX</span>        <span class="hs-comment">-- from float.h</span>
<a name="line-121"></a>    <span class="hs-varid">floatDigits</span> <span class="hs-keyword">_</span>       <span class="hs-keyglyph">=</span>  <span class="hs-conid">FLT_MANT_DIG</span>     <span class="hs-comment">-- ditto</span>
<a name="line-122"></a>    <span class="hs-varid">floatRange</span> <span class="hs-keyword">_</span>        <span class="hs-keyglyph">=</span>  <span class="hs-layout">(</span><span class="hs-conid">FLT_MIN_EXP</span><span class="hs-layout">,</span> <span class="hs-conid">FLT_MAX_EXP</span><span class="hs-layout">)</span> <span class="hs-comment">-- ditto</span>
<a name="line-123"></a>
<a name="line-124"></a>    <span class="hs-varid">decodeFloat</span> <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">f</span><span class="hs-cpp">#</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-varid">decodeFloat_Int</span><span class="hs-cpp">#</span> <span class="hs-varid">f</span><span class="hs-cpp">#</span> <span class="hs-keyword">of</span>
<a name="line-125"></a>                          <span class="hs-layout">(</span><span class="hs-cpp">#</span> <span class="hs-varid">i</span><span class="hs-layout">,</span> <span class="hs-varid">e</span> <span class="hs-cpp">#</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-layout">(</span><span class="hs-varid">smallInteger</span> <span class="hs-varid">i</span><span class="hs-layout">,</span> <span class="hs-conid">I</span><span class="hs-cpp">#</span> <span class="hs-varid">e</span><span class="hs-layout">)</span>
<a name="line-126"></a>
<a name="line-127"></a>    <span class="hs-varid">encodeFloat</span> <span class="hs-varid">i</span> <span class="hs-layout">(</span><span class="hs-conid">I</span><span class="hs-cpp">#</span> <span class="hs-varid">e</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">encodeFloatInteger</span> <span class="hs-varid">i</span> <span class="hs-varid">e</span><span class="hs-layout">)</span>
<a name="line-128"></a>
<a name="line-129"></a>    <span class="hs-varid">exponent</span> <span class="hs-varid">x</span>          <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-varid">decodeFloat</span> <span class="hs-varid">x</span> <span class="hs-keyword">of</span>
<a name="line-130"></a>                            <span class="hs-layout">(</span><span class="hs-varid">m</span><span class="hs-layout">,</span><span class="hs-varid">n</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyword">if</span> <span class="hs-varid">m</span> <span class="hs-varop">==</span> <span class="hs-num">0</span> <span class="hs-keyword">then</span> <span class="hs-num">0</span> <span class="hs-keyword">else</span> <span class="hs-varid">n</span> <span class="hs-varop">+</span> <span class="hs-varid">floatDigits</span> <span class="hs-varid">x</span>
<a name="line-131"></a>
<a name="line-132"></a>    <span class="hs-varid">significand</span> <span class="hs-varid">x</span>       <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-varid">decodeFloat</span> <span class="hs-varid">x</span> <span class="hs-keyword">of</span>
<a name="line-133"></a>                            <span class="hs-layout">(</span><span class="hs-varid">m</span><span class="hs-layout">,</span><span class="hs-keyword">_</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">encodeFloat</span> <span class="hs-varid">m</span> <span class="hs-layout">(</span><span class="hs-varid">negate</span> <span class="hs-layout">(</span><span class="hs-varid">floatDigits</span> <span class="hs-varid">x</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-134"></a>
<a name="line-135"></a>    <span class="hs-varid">scaleFloat</span> <span class="hs-num">0</span> <span class="hs-varid">x</span>      <span class="hs-keyglyph">=</span> <span class="hs-varid">x</span>
<a name="line-136"></a>    <span class="hs-varid">scaleFloat</span> <span class="hs-varid">k</span> <span class="hs-varid">x</span>
<a name="line-137"></a>      <span class="hs-keyglyph">|</span> <span class="hs-varid">isFix</span>           <span class="hs-keyglyph">=</span> <span class="hs-varid">x</span>
<a name="line-138"></a>      <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span>       <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-varid">decodeFloat</span> <span class="hs-varid">x</span> <span class="hs-keyword">of</span>
<a name="line-139"></a>                            <span class="hs-layout">(</span><span class="hs-varid">m</span><span class="hs-layout">,</span><span class="hs-varid">n</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">encodeFloat</span> <span class="hs-varid">m</span> <span class="hs-layout">(</span><span class="hs-varid">n</span> <span class="hs-varop">+</span> <span class="hs-varid">clamp</span> <span class="hs-varid">bf</span> <span class="hs-varid">k</span><span class="hs-layout">)</span>
<a name="line-140"></a>                        <span class="hs-keyword">where</span> <span class="hs-varid">bf</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">FLT_MAX_EXP</span> <span class="hs-comment">-</span> <span class="hs-layout">(</span><span class="hs-conid">FLT_MIN_EXP</span><span class="hs-layout">)</span> <span class="hs-varop">+</span> <span class="hs-num">4</span><span class="hs-varop">*</span><span class="hs-conid">FLT_MANT_DIG</span>
<a name="line-141"></a>                              <span class="hs-varid">isFix</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">x</span> <span class="hs-varop">==</span> <span class="hs-num">0</span> <span class="hs-varop">||</span> <span class="hs-varid">isFloatFinite</span> <span class="hs-varid">x</span> <span class="hs-varop">==</span> <span class="hs-num">0</span>
<a name="line-142"></a>
<a name="line-143"></a>    <span class="hs-varid">isNaN</span> <span class="hs-varid">x</span>          <span class="hs-keyglyph">=</span> <span class="hs-num">0</span> <span class="hs-varop">/=</span> <span class="hs-varid">isFloatNaN</span> <span class="hs-varid">x</span>
<a name="line-144"></a>    <span class="hs-varid">isInfinite</span> <span class="hs-varid">x</span>     <span class="hs-keyglyph">=</span> <span class="hs-num">0</span> <span class="hs-varop">/=</span> <span class="hs-varid">isFloatInfinite</span> <span class="hs-varid">x</span>
<a name="line-145"></a>    <span class="hs-varid">isDenormalized</span> <span class="hs-varid">x</span> <span class="hs-keyglyph">=</span> <span class="hs-num">0</span> <span class="hs-varop">/=</span> <span class="hs-varid">isFloatDenormalized</span> <span class="hs-varid">x</span>
<a name="line-146"></a>    <span class="hs-varid">isNegativeZero</span> <span class="hs-varid">x</span> <span class="hs-keyglyph">=</span> <span class="hs-num">0</span> <span class="hs-varop">/=</span> <span class="hs-varid">isFloatNegativeZero</span> <span class="hs-varid">x</span>
<a name="line-147"></a>    <span class="hs-varid">isIEEE</span> <span class="hs-keyword">_</span>         <span class="hs-keyglyph">=</span> <span class="hs-conid">True</span>
<a name="line-148"></a>
<a name="line-149"></a><a name="instance%20Show%20Float"></a><span class="hs-keyword">instance</span>  <span class="hs-conid">Show</span> <span class="hs-conid">Float</span>  <span class="hs-keyword">where</span>
<a name="line-150"></a>    <span class="hs-varid">showsPrec</span>   <span class="hs-varid">x</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">showSignedFloat</span> <span class="hs-varid">showFloat</span> <span class="hs-varid">x</span>
<a name="line-151"></a>    <span class="hs-varid">showList</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">showList__</span> <span class="hs-layout">(</span><span class="hs-varid">showsPrec</span> <span class="hs-num">0</span><span class="hs-layout">)</span>
</pre>\end{code}

%*********************************************************
%*                                                      *
\subsection{Type @Double@}
%*                                                      *
%*********************************************************

\begin{code}
<pre><a name="line-1"></a><a name="instance%20Num%20Double"></a><span class="hs-keyword">instance</span>  <span class="hs-conid">Num</span> <span class="hs-conid">Double</span>  <span class="hs-keyword">where</span>
<a name="line-2"></a>    <span class="hs-layout">(</span><span class="hs-varop">+</span><span class="hs-layout">)</span>         <span class="hs-varid">x</span> <span class="hs-varid">y</span>     <span class="hs-keyglyph">=</span>  <span class="hs-varid">plusDouble</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span>
<a name="line-3"></a>    <span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-layout">)</span>         <span class="hs-varid">x</span> <span class="hs-varid">y</span>     <span class="hs-keyglyph">=</span>  <span class="hs-varid">minusDouble</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span>
<a name="line-4"></a>    <span class="hs-varid">negate</span>      <span class="hs-varid">x</span>       <span class="hs-keyglyph">=</span>  <span class="hs-varid">negateDouble</span> <span class="hs-varid">x</span>
<a name="line-5"></a>    <span class="hs-layout">(</span><span class="hs-varop">*</span><span class="hs-layout">)</span>         <span class="hs-varid">x</span> <span class="hs-varid">y</span>     <span class="hs-keyglyph">=</span>  <span class="hs-varid">timesDouble</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span>
<a name="line-6"></a>    <span class="hs-varid">abs</span> <span class="hs-varid">x</span> <span class="hs-keyglyph">|</span> <span class="hs-varid">x</span> <span class="hs-varop">&gt;=</span> <span class="hs-num">0.0</span>    <span class="hs-keyglyph">=</span>  <span class="hs-varid">x</span>
<a name="line-7"></a>          <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span>   <span class="hs-keyglyph">=</span>  <span class="hs-varid">negateDouble</span> <span class="hs-varid">x</span>
<a name="line-8"></a>    <span class="hs-varid">signum</span> <span class="hs-varid">x</span> <span class="hs-keyglyph">|</span> <span class="hs-varid">x</span> <span class="hs-varop">==</span> <span class="hs-num">0.0</span>  <span class="hs-keyglyph">=</span> <span class="hs-num">0</span>
<a name="line-9"></a>             <span class="hs-keyglyph">|</span> <span class="hs-varid">x</span> <span class="hs-varop">&gt;</span> <span class="hs-num">0.0</span>   <span class="hs-keyglyph">=</span> <span class="hs-num">1</span>
<a name="line-10"></a>             <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">negate</span> <span class="hs-num">1</span>
<a name="line-11"></a>
<a name="line-12"></a>    <span class="hs-comment">{-# INLINE fromInteger #-}</span>
<a name="line-13"></a>    <span class="hs-varid">fromInteger</span> <span class="hs-varid">i</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">doubleFromInteger</span> <span class="hs-varid">i</span><span class="hs-layout">)</span>
<a name="line-14"></a>
<a name="line-15"></a>
<a name="line-16"></a><a name="instance%20Real%20Double"></a><span class="hs-keyword">instance</span>  <span class="hs-conid">Real</span> <span class="hs-conid">Double</span>  <span class="hs-keyword">where</span>
<a name="line-17"></a>    <span class="hs-varid">toRational</span> <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-cpp">#</span><span class="hs-layout">)</span>  <span class="hs-keyglyph">=</span>
<a name="line-18"></a>        <span class="hs-keyword">case</span> <span class="hs-varid">decodeDoubleInteger</span> <span class="hs-varid">x</span><span class="hs-cpp">#</span> <span class="hs-keyword">of</span>
<a name="line-19"></a>          <span class="hs-layout">(</span><span class="hs-cpp">#</span> <span class="hs-varid">m</span><span class="hs-layout">,</span> <span class="hs-varid">e</span><span class="hs-cpp">#</span> <span class="hs-cpp">#</span><span class="hs-layout">)</span>
<a name="line-20"></a>            <span class="hs-keyglyph">|</span> <span class="hs-varid">e</span><span class="hs-cpp">#</span> <span class="hs-varop">&gt;=#</span> <span class="hs-num">0</span><span class="hs-cpp">#</span>                                     <span class="hs-keyglyph">-&gt;</span>
<a name="line-21"></a>                <span class="hs-varid">shiftLInteger</span> <span class="hs-varid">m</span> <span class="hs-varid">e</span><span class="hs-cpp">#</span> <span class="hs-conop">:%</span> <span class="hs-num">1</span>
<a name="line-22"></a>            <span class="hs-keyglyph">|</span> <span class="hs-layout">(</span><span class="hs-varid">integerToWord</span> <span class="hs-varid">m</span> <span class="hs-varop">`</span><span class="hs-varid">and</span><span class="hs-cpp">#</span><span class="hs-varop">`</span> <span class="hs-num">1</span><span class="hs-cpp">##</span><span class="hs-layout">)</span> <span class="hs-varop">`</span><span class="hs-varid">eqWord</span><span class="hs-cpp">#</span><span class="hs-varop">`</span> <span class="hs-num">0</span><span class="hs-cpp">##</span>    <span class="hs-keyglyph">-&gt;</span>
<a name="line-23"></a>                <span class="hs-keyword">case</span> <span class="hs-varid">elimZerosInteger</span> <span class="hs-varid">m</span> <span class="hs-layout">(</span><span class="hs-varid">negateInt</span><span class="hs-cpp">#</span> <span class="hs-varid">e</span><span class="hs-cpp">#</span><span class="hs-layout">)</span> <span class="hs-keyword">of</span>
<a name="line-24"></a>                    <span class="hs-layout">(</span><span class="hs-cpp">#</span> <span class="hs-varid">n</span><span class="hs-layout">,</span> <span class="hs-varid">d</span><span class="hs-cpp">#</span> <span class="hs-cpp">#</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span>  <span class="hs-varid">n</span> <span class="hs-conop">:%</span> <span class="hs-varid">shiftLInteger</span> <span class="hs-num">1</span> <span class="hs-varid">d</span><span class="hs-cpp">#</span>
<a name="line-25"></a>            <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span>                                     <span class="hs-keyglyph">-&gt;</span>
<a name="line-26"></a>                <span class="hs-varid">m</span> <span class="hs-conop">:%</span> <span class="hs-varid">shiftLInteger</span> <span class="hs-num">1</span> <span class="hs-layout">(</span><span class="hs-varid">negateInt</span><span class="hs-cpp">#</span> <span class="hs-varid">e</span><span class="hs-cpp">#</span><span class="hs-layout">)</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="instance%20Fractional%20Double"></a><span class="hs-keyword">instance</span>  <span class="hs-conid">Fractional</span> <span class="hs-conid">Double</span>  <span class="hs-keyword">where</span>
<a name="line-29"></a>    <span class="hs-layout">(</span><span class="hs-varop">/</span><span class="hs-layout">)</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span>             <span class="hs-keyglyph">=</span>  <span class="hs-varid">divideDouble</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span>
<a name="line-30"></a>    <span class="hs-varid">fromRational</span> <span class="hs-layout">(</span><span class="hs-varid">n</span><span class="hs-conop">:%</span><span class="hs-num">0</span><span class="hs-layout">)</span>
<a name="line-31"></a>        <span class="hs-keyglyph">|</span> <span class="hs-varid">n</span> <span class="hs-varop">==</span> <span class="hs-num">0</span>        <span class="hs-keyglyph">=</span> <span class="hs-num">0</span><span class="hs-varop">/</span><span class="hs-num">0</span>
<a name="line-32"></a>        <span class="hs-keyglyph">|</span> <span class="hs-varid">n</span> <span class="hs-varop">&lt;</span> <span class="hs-num">0</span>         <span class="hs-keyglyph">=</span> <span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-num">1</span><span class="hs-layout">)</span><span class="hs-varop">/</span><span class="hs-num">0</span>
<a name="line-33"></a>        <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span>     <span class="hs-keyglyph">=</span> <span class="hs-num">1</span><span class="hs-varop">/</span><span class="hs-num">0</span>
<a name="line-34"></a>    <span class="hs-varid">fromRational</span> <span class="hs-layout">(</span><span class="hs-varid">n</span><span class="hs-conop">:%</span><span class="hs-varid">d</span><span class="hs-layout">)</span>
<a name="line-35"></a>        <span class="hs-keyglyph">|</span> <span class="hs-varid">n</span> <span class="hs-varop">==</span> <span class="hs-num">0</span>        <span class="hs-keyglyph">=</span> <span class="hs-varid">encodeFloat</span> <span class="hs-num">0</span> <span class="hs-num">0</span>
<a name="line-36"></a>        <span class="hs-keyglyph">|</span> <span class="hs-varid">n</span> <span class="hs-varop">&lt;</span> <span class="hs-num">0</span>         <span class="hs-keyglyph">=</span> <span class="hs-comment">-</span><span class="hs-layout">(</span><span class="hs-varid">fromRat''</span> <span class="hs-varid">minEx</span> <span class="hs-varid">mantDigs</span> <span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-varid">n</span><span class="hs-layout">)</span> <span class="hs-varid">d</span><span class="hs-layout">)</span>
<a name="line-37"></a>        <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span>     <span class="hs-keyglyph">=</span> <span class="hs-varid">fromRat''</span> <span class="hs-varid">minEx</span> <span class="hs-varid">mantDigs</span> <span class="hs-varid">n</span> <span class="hs-varid">d</span>
<a name="line-38"></a>          <span class="hs-keyword">where</span>
<a name="line-39"></a>            <span class="hs-varid">minEx</span>       <span class="hs-keyglyph">=</span> <span class="hs-conid">DBL_MIN_EXP</span>
<a name="line-40"></a>            <span class="hs-varid">mantDigs</span>    <span class="hs-keyglyph">=</span> <span class="hs-conid">DBL_MANT_DIG</span>
<a name="line-41"></a>    <span class="hs-varid">recip</span> <span class="hs-varid">x</span>             <span class="hs-keyglyph">=</span>  <span class="hs-num">1.0</span> <span class="hs-varop">/</span> <span class="hs-varid">x</span>
<a name="line-42"></a>
<a name="line-43"></a><a name="instance%20Floating%20Double"></a><span class="hs-keyword">instance</span>  <span class="hs-conid">Floating</span> <span class="hs-conid">Double</span>  <span class="hs-keyword">where</span>
<a name="line-44"></a>    <span class="hs-varid">pi</span>                  <span class="hs-keyglyph">=</span>  <span class="hs-num">3.141592653589793238</span>
<a name="line-45"></a>    <span class="hs-varid">exp</span> <span class="hs-varid">x</span>               <span class="hs-keyglyph">=</span>  <span class="hs-varid">expDouble</span> <span class="hs-varid">x</span>
<a name="line-46"></a>    <span class="hs-varid">log</span> <span class="hs-varid">x</span>               <span class="hs-keyglyph">=</span>  <span class="hs-varid">logDouble</span> <span class="hs-varid">x</span>
<a name="line-47"></a>    <span class="hs-varid">sqrt</span> <span class="hs-varid">x</span>              <span class="hs-keyglyph">=</span>  <span class="hs-varid">sqrtDouble</span> <span class="hs-varid">x</span>
<a name="line-48"></a>    <span class="hs-varid">sin</span>  <span class="hs-varid">x</span>              <span class="hs-keyglyph">=</span>  <span class="hs-varid">sinDouble</span> <span class="hs-varid">x</span>
<a name="line-49"></a>    <span class="hs-varid">cos</span>  <span class="hs-varid">x</span>              <span class="hs-keyglyph">=</span>  <span class="hs-varid">cosDouble</span> <span class="hs-varid">x</span>
<a name="line-50"></a>    <span class="hs-varid">tan</span>  <span class="hs-varid">x</span>              <span class="hs-keyglyph">=</span>  <span class="hs-varid">tanDouble</span> <span class="hs-varid">x</span>
<a name="line-51"></a>    <span class="hs-varid">asin</span> <span class="hs-varid">x</span>              <span class="hs-keyglyph">=</span>  <span class="hs-varid">asinDouble</span> <span class="hs-varid">x</span>
<a name="line-52"></a>    <span class="hs-varid">acos</span> <span class="hs-varid">x</span>              <span class="hs-keyglyph">=</span>  <span class="hs-varid">acosDouble</span> <span class="hs-varid">x</span>
<a name="line-53"></a>    <span class="hs-varid">atan</span> <span class="hs-varid">x</span>              <span class="hs-keyglyph">=</span>  <span class="hs-varid">atanDouble</span> <span class="hs-varid">x</span>
<a name="line-54"></a>    <span class="hs-varid">sinh</span> <span class="hs-varid">x</span>              <span class="hs-keyglyph">=</span>  <span class="hs-varid">sinhDouble</span> <span class="hs-varid">x</span>
<a name="line-55"></a>    <span class="hs-varid">cosh</span> <span class="hs-varid">x</span>              <span class="hs-keyglyph">=</span>  <span class="hs-varid">coshDouble</span> <span class="hs-varid">x</span>
<a name="line-56"></a>    <span class="hs-varid">tanh</span> <span class="hs-varid">x</span>              <span class="hs-keyglyph">=</span>  <span class="hs-varid">tanhDouble</span> <span class="hs-varid">x</span>
<a name="line-57"></a>    <span class="hs-layout">(</span><span class="hs-varop">**</span><span class="hs-layout">)</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span>            <span class="hs-keyglyph">=</span>  <span class="hs-varid">powerDouble</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span>
<a name="line-58"></a>    <span class="hs-varid">logBase</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span>         <span class="hs-keyglyph">=</span>  <span class="hs-varid">log</span> <span class="hs-varid">y</span> <span class="hs-varop">/</span> <span class="hs-varid">log</span> <span class="hs-varid">x</span>
<a name="line-59"></a>
<a name="line-60"></a>    <span class="hs-varid">asinh</span> <span class="hs-varid">x</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">log</span> <span class="hs-layout">(</span><span class="hs-varid">x</span> <span class="hs-varop">+</span> <span class="hs-varid">sqrt</span> <span class="hs-layout">(</span><span class="hs-num">1.0</span><span class="hs-varop">+</span><span class="hs-varid">x</span><span class="hs-varop">*</span><span class="hs-varid">x</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-61"></a>    <span class="hs-varid">acosh</span> <span class="hs-varid">x</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">log</span> <span class="hs-layout">(</span><span class="hs-varid">x</span> <span class="hs-varop">+</span> <span class="hs-layout">(</span><span class="hs-varid">x</span><span class="hs-varop">+</span><span class="hs-num">1.0</span><span class="hs-layout">)</span> <span class="hs-varop">*</span> <span class="hs-varid">sqrt</span> <span class="hs-layout">(</span><span class="hs-layout">(</span><span class="hs-varid">x</span><span class="hs-comment">-</span><span class="hs-num">1.0</span><span class="hs-layout">)</span><span class="hs-varop">/</span><span class="hs-layout">(</span><span class="hs-varid">x</span><span class="hs-varop">+</span><span class="hs-num">1.0</span><span class="hs-layout">)</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-62"></a>    <span class="hs-varid">atanh</span> <span class="hs-varid">x</span> <span class="hs-keyglyph">=</span> <span class="hs-num">0.5</span> <span class="hs-varop">*</span> <span class="hs-varid">log</span> <span class="hs-layout">(</span><span class="hs-layout">(</span><span class="hs-num">1.0</span><span class="hs-varop">+</span><span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-varop">/</span> <span class="hs-layout">(</span><span class="hs-num">1.0</span><span class="hs-comment">-</span><span class="hs-varid">x</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="instance%20RealFrac%20Double"></a><span class="hs-comment">-- RULES for Integer and Int</span>
<a name="line-65"></a><a name="instance%20RealFrac%20Double"></a><span class="hs-comment">{-# RULES
<a name="line-66"></a>&quot;properFraction/Double-&gt;Integer&quot;    properFraction = properFractionDoubleInteger
<a name="line-67"></a>&quot;truncate/Double-&gt;Integer&quot;          truncate = truncateDoubleInteger
<a name="line-68"></a>&quot;floor/Double-&gt;Integer&quot;             floor = floorDoubleInteger
<a name="line-69"></a>&quot;ceiling/Double-&gt;Integer&quot;           ceiling = ceilingDoubleInteger
<a name="line-70"></a>&quot;round/Double-&gt;Integer&quot;             round = roundDoubleInteger
<a name="line-71"></a>&quot;properFraction/Double-&gt;Int&quot;        properFraction = properFractionDoubleInt
<a name="line-72"></a>&quot;truncate/Double-&gt;Int&quot;              truncate = double2Int
<a name="line-73"></a>&quot;floor/Double-&gt;Int&quot;                 floor = floorDoubleInt
<a name="line-74"></a>&quot;ceiling/Double-&gt;Int&quot;               ceiling = ceilingDoubleInt
<a name="line-75"></a>&quot;round/Double-&gt;Int&quot;                 round = roundDoubleInt
<a name="line-76"></a>  #-}</span>
<a name="line-77"></a><a name="instance%20RealFrac%20Double"></a><span class="hs-keyword">instance</span>  <span class="hs-conid">RealFrac</span> <span class="hs-conid">Double</span>  <span class="hs-keyword">where</span>
<a name="line-78"></a>
<a name="line-79"></a>        <span class="hs-comment">-- ceiling, floor, and truncate are all small</span>
<a name="line-80"></a>    <span class="hs-comment">{-# INLINE [1] ceiling #-}</span>
<a name="line-81"></a>    <span class="hs-comment">{-# INLINE [1] floor #-}</span>
<a name="line-82"></a>    <span class="hs-comment">{-# INLINE [1] truncate #-}</span>
<a name="line-83"></a>
<a name="line-84"></a>    <span class="hs-varid">properFraction</span> <span class="hs-varid">x</span>
<a name="line-85"></a>      <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-layout">(</span><span class="hs-varid">decodeFloat</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>      <span class="hs-keyword">of</span> <span class="hs-layout">{</span> <span class="hs-layout">(</span><span class="hs-varid">m</span><span class="hs-layout">,</span><span class="hs-varid">n</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span>
<a name="line-86"></a>        <span class="hs-keyword">if</span> <span class="hs-varid">n</span> <span class="hs-varop">&gt;=</span> <span class="hs-num">0</span> <span class="hs-keyword">then</span>
<a name="line-87"></a>            <span class="hs-layout">(</span><span class="hs-varid">fromInteger</span> <span class="hs-varid">m</span> <span class="hs-varop">*</span> <span class="hs-num">2</span> <span class="hs-varop">^</span> <span class="hs-varid">n</span><span class="hs-layout">,</span> <span class="hs-num">0.0</span><span class="hs-layout">)</span>
<a name="line-88"></a>        <span class="hs-keyword">else</span>
<a name="line-89"></a>            <span class="hs-keyword">case</span> <span class="hs-layout">(</span><span class="hs-varid">quotRem</span> <span class="hs-varid">m</span> <span class="hs-layout">(</span><span class="hs-num">2</span><span class="hs-varop">^</span><span class="hs-layout">(</span><span class="hs-varid">negate</span> <span class="hs-varid">n</span><span class="hs-layout">)</span><span class="hs-layout">)</span><span class="hs-layout">)</span> <span class="hs-keyword">of</span> <span class="hs-layout">{</span> <span class="hs-layout">(</span><span class="hs-varid">w</span><span class="hs-layout">,</span><span class="hs-varid">r</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span>
<a name="line-90"></a>            <span class="hs-layout">(</span><span class="hs-varid">fromInteger</span> <span class="hs-varid">w</span><span class="hs-layout">,</span> <span class="hs-varid">encodeFloat</span> <span class="hs-varid">r</span> <span class="hs-varid">n</span><span class="hs-layout">)</span>
<a name="line-91"></a>            <span class="hs-layout">}</span>
<a name="line-92"></a>        <span class="hs-layout">}</span>
<a name="line-93"></a>
<a name="line-94"></a>    <span class="hs-varid">truncate</span> <span class="hs-varid">x</span>  <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-varid">properFraction</span> <span class="hs-varid">x</span> <span class="hs-keyword">of</span>
<a name="line-95"></a>                     <span class="hs-layout">(</span><span class="hs-varid">n</span><span class="hs-layout">,</span><span class="hs-keyword">_</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">n</span>
<a name="line-96"></a>
<a name="line-97"></a>    <span class="hs-varid">round</span> <span class="hs-varid">x</span>     <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-varid">properFraction</span> <span class="hs-varid">x</span> <span class="hs-keyword">of</span>
<a name="line-98"></a>                     <span class="hs-layout">(</span><span class="hs-varid">n</span><span class="hs-layout">,</span><span class="hs-varid">r</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyword">let</span>
<a name="line-99"></a>                                <span class="hs-varid">m</span>         <span class="hs-keyglyph">=</span> <span class="hs-keyword">if</span> <span class="hs-varid">r</span> <span class="hs-varop">&lt;</span> <span class="hs-num">0.0</span> <span class="hs-keyword">then</span> <span class="hs-varid">n</span> <span class="hs-comment">-</span> <span class="hs-num">1</span> <span class="hs-keyword">else</span> <span class="hs-varid">n</span> <span class="hs-varop">+</span> <span class="hs-num">1</span>
<a name="line-100"></a>                                <span class="hs-varid">half_down</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">abs</span> <span class="hs-varid">r</span> <span class="hs-comment">-</span> <span class="hs-num">0.5</span>
<a name="line-101"></a>                              <span class="hs-keyword">in</span>
<a name="line-102"></a>                              <span class="hs-keyword">case</span> <span class="hs-layout">(</span><span class="hs-varid">compare</span> <span class="hs-varid">half_down</span> <span class="hs-num">0.0</span><span class="hs-layout">)</span> <span class="hs-keyword">of</span>
<a name="line-103"></a>                                <span class="hs-conid">LT</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">n</span>
<a name="line-104"></a>                                <span class="hs-conid">EQ</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyword">if</span> <span class="hs-varid">even</span> <span class="hs-varid">n</span> <span class="hs-keyword">then</span> <span class="hs-varid">n</span> <span class="hs-keyword">else</span> <span class="hs-varid">m</span>
<a name="line-105"></a>                                <span class="hs-conid">GT</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">m</span>
<a name="line-106"></a>
<a name="line-107"></a>    <span class="hs-varid">ceiling</span> <span class="hs-varid">x</span>   <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-varid">properFraction</span> <span class="hs-varid">x</span> <span class="hs-keyword">of</span>
<a name="line-108"></a>                    <span class="hs-layout">(</span><span class="hs-varid">n</span><span class="hs-layout">,</span><span class="hs-varid">r</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyword">if</span> <span class="hs-varid">r</span> <span class="hs-varop">&gt;</span> <span class="hs-num">0.0</span> <span class="hs-keyword">then</span> <span class="hs-varid">n</span> <span class="hs-varop">+</span> <span class="hs-num">1</span> <span class="hs-keyword">else</span> <span class="hs-varid">n</span>
<a name="line-109"></a>
<a name="line-110"></a>    <span class="hs-varid">floor</span> <span class="hs-varid">x</span>     <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-varid">properFraction</span> <span class="hs-varid">x</span> <span class="hs-keyword">of</span>
<a name="line-111"></a>                    <span class="hs-layout">(</span><span class="hs-varid">n</span><span class="hs-layout">,</span><span class="hs-varid">r</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyword">if</span> <span class="hs-varid">r</span> <span class="hs-varop">&lt;</span> <span class="hs-num">0.0</span> <span class="hs-keyword">then</span> <span class="hs-varid">n</span> <span class="hs-comment">-</span> <span class="hs-num">1</span> <span class="hs-keyword">else</span> <span class="hs-varid">n</span>
<a name="line-112"></a>
<a name="line-113"></a><a name="instance%20RealFloat%20Double"></a><span class="hs-keyword">instance</span>  <span class="hs-conid">RealFloat</span> <span class="hs-conid">Double</span>  <span class="hs-keyword">where</span>
<a name="line-114"></a>    <span class="hs-varid">floatRadix</span> <span class="hs-keyword">_</span>        <span class="hs-keyglyph">=</span>  <span class="hs-conid">FLT_RADIX</span>        <span class="hs-comment">-- from float.h</span>
<a name="line-115"></a>    <span class="hs-varid">floatDigits</span> <span class="hs-keyword">_</span>       <span class="hs-keyglyph">=</span>  <span class="hs-conid">DBL_MANT_DIG</span>     <span class="hs-comment">-- ditto</span>
<a name="line-116"></a>    <span class="hs-varid">floatRange</span> <span class="hs-keyword">_</span>        <span class="hs-keyglyph">=</span>  <span class="hs-layout">(</span><span class="hs-conid">DBL_MIN_EXP</span><span class="hs-layout">,</span> <span class="hs-conid">DBL_MAX_EXP</span><span class="hs-layout">)</span> <span class="hs-comment">-- ditto</span>
<a name="line-117"></a>
<a name="line-118"></a>    <span class="hs-varid">decodeFloat</span> <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-cpp">#</span><span class="hs-layout">)</span>
<a name="line-119"></a>      <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-varid">decodeDoubleInteger</span> <span class="hs-varid">x</span><span class="hs-cpp">#</span>   <span class="hs-keyword">of</span>
<a name="line-120"></a>          <span class="hs-layout">(</span><span class="hs-cpp">#</span> <span class="hs-varid">i</span><span class="hs-layout">,</span> <span class="hs-varid">j</span> <span class="hs-cpp">#</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-layout">(</span><span class="hs-varid">i</span><span class="hs-layout">,</span> <span class="hs-conid">I</span><span class="hs-cpp">#</span> <span class="hs-varid">j</span><span class="hs-layout">)</span>
<a name="line-121"></a>
<a name="line-122"></a>    <span class="hs-varid">encodeFloat</span> <span class="hs-varid">i</span> <span class="hs-layout">(</span><span class="hs-conid">I</span><span class="hs-cpp">#</span> <span class="hs-varid">j</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">encodeDoubleInteger</span> <span class="hs-varid">i</span> <span class="hs-varid">j</span><span class="hs-layout">)</span>
<a name="line-123"></a>
<a name="line-124"></a>    <span class="hs-varid">exponent</span> <span class="hs-varid">x</span>          <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-varid">decodeFloat</span> <span class="hs-varid">x</span> <span class="hs-keyword">of</span>
<a name="line-125"></a>                            <span class="hs-layout">(</span><span class="hs-varid">m</span><span class="hs-layout">,</span><span class="hs-varid">n</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyword">if</span> <span class="hs-varid">m</span> <span class="hs-varop">==</span> <span class="hs-num">0</span> <span class="hs-keyword">then</span> <span class="hs-num">0</span> <span class="hs-keyword">else</span> <span class="hs-varid">n</span> <span class="hs-varop">+</span> <span class="hs-varid">floatDigits</span> <span class="hs-varid">x</span>
<a name="line-126"></a>
<a name="line-127"></a>    <span class="hs-varid">significand</span> <span class="hs-varid">x</span>       <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-varid">decodeFloat</span> <span class="hs-varid">x</span> <span class="hs-keyword">of</span>
<a name="line-128"></a>                            <span class="hs-layout">(</span><span class="hs-varid">m</span><span class="hs-layout">,</span><span class="hs-keyword">_</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">encodeFloat</span> <span class="hs-varid">m</span> <span class="hs-layout">(</span><span class="hs-varid">negate</span> <span class="hs-layout">(</span><span class="hs-varid">floatDigits</span> <span class="hs-varid">x</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-129"></a>
<a name="line-130"></a>    <span class="hs-varid">scaleFloat</span> <span class="hs-num">0</span> <span class="hs-varid">x</span>      <span class="hs-keyglyph">=</span> <span class="hs-varid">x</span>
<a name="line-131"></a>    <span class="hs-varid">scaleFloat</span> <span class="hs-varid">k</span> <span class="hs-varid">x</span>
<a name="line-132"></a>      <span class="hs-keyglyph">|</span> <span class="hs-varid">isFix</span>           <span class="hs-keyglyph">=</span> <span class="hs-varid">x</span>
<a name="line-133"></a>      <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span>       <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-varid">decodeFloat</span> <span class="hs-varid">x</span> <span class="hs-keyword">of</span>
<a name="line-134"></a>                            <span class="hs-layout">(</span><span class="hs-varid">m</span><span class="hs-layout">,</span><span class="hs-varid">n</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">encodeFloat</span> <span class="hs-varid">m</span> <span class="hs-layout">(</span><span class="hs-varid">n</span> <span class="hs-varop">+</span> <span class="hs-varid">clamp</span> <span class="hs-varid">bd</span> <span class="hs-varid">k</span><span class="hs-layout">)</span>
<a name="line-135"></a>                        <span class="hs-keyword">where</span> <span class="hs-varid">bd</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">DBL_MAX_EXP</span> <span class="hs-comment">-</span> <span class="hs-layout">(</span><span class="hs-conid">DBL_MIN_EXP</span><span class="hs-layout">)</span> <span class="hs-varop">+</span> <span class="hs-num">4</span><span class="hs-varop">*</span><span class="hs-conid">DBL_MANT_DIG</span>
<a name="line-136"></a>                              <span class="hs-varid">isFix</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">x</span> <span class="hs-varop">==</span> <span class="hs-num">0</span> <span class="hs-varop">||</span> <span class="hs-varid">isDoubleFinite</span> <span class="hs-varid">x</span> <span class="hs-varop">==</span> <span class="hs-num">0</span>
<a name="line-137"></a>
<a name="line-138"></a>    <span class="hs-varid">isNaN</span> <span class="hs-varid">x</span>             <span class="hs-keyglyph">=</span> <span class="hs-num">0</span> <span class="hs-varop">/=</span> <span class="hs-varid">isDoubleNaN</span> <span class="hs-varid">x</span>
<a name="line-139"></a>    <span class="hs-varid">isInfinite</span> <span class="hs-varid">x</span>        <span class="hs-keyglyph">=</span> <span class="hs-num">0</span> <span class="hs-varop">/=</span> <span class="hs-varid">isDoubleInfinite</span> <span class="hs-varid">x</span>
<a name="line-140"></a>    <span class="hs-varid">isDenormalized</span> <span class="hs-varid">x</span>    <span class="hs-keyglyph">=</span> <span class="hs-num">0</span> <span class="hs-varop">/=</span> <span class="hs-varid">isDoubleDenormalized</span> <span class="hs-varid">x</span>
<a name="line-141"></a>    <span class="hs-varid">isNegativeZero</span> <span class="hs-varid">x</span>    <span class="hs-keyglyph">=</span> <span class="hs-num">0</span> <span class="hs-varop">/=</span> <span class="hs-varid">isDoubleNegativeZero</span> <span class="hs-varid">x</span>
<a name="line-142"></a>    <span class="hs-varid">isIEEE</span> <span class="hs-keyword">_</span>            <span class="hs-keyglyph">=</span> <span class="hs-conid">True</span>
<a name="line-143"></a>
<a name="line-144"></a><a name="instance%20Show%20Double"></a><span class="hs-keyword">instance</span>  <span class="hs-conid">Show</span> <span class="hs-conid">Double</span>  <span class="hs-keyword">where</span>
<a name="line-145"></a>    <span class="hs-varid">showsPrec</span>   <span class="hs-varid">x</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">showSignedFloat</span> <span class="hs-varid">showFloat</span> <span class="hs-varid">x</span>
<a name="line-146"></a>    <span class="hs-varid">showList</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">showList__</span> <span class="hs-layout">(</span><span class="hs-varid">showsPrec</span> <span class="hs-num">0</span><span class="hs-layout">)</span>
</pre>\end{code}

%*********************************************************
%*                                                      *
\subsection{@Enum@ instances}
%*                                                      *
%*********************************************************

The @Enum@ instances for Floats and Doubles are slightly unusual.
The @toEnum@ function truncates numbers to Int.  The definitions
of @enumFrom@ and @enumFromThen@ allow floats to be used in arithmetic
series: [0,0.1 .. 1.0].  However, roundoff errors make these somewhat
dubious.  This example may have either 10 or 11 elements, depending on
how 0.1 is represented.

NOTE: The instances for Float and Double do not make use of the default
methods for @enumFromTo@ and @enumFromThenTo@, as these rely on there being
a `non-lossy' conversion to and from Ints. Instead we make use of the
1.2 default methods (back in the days when Enum had Ord as a superclass)
for these (@numericEnumFromTo@ and @numericEnumFromThenTo@ below.)

\begin{code}
<pre><a name="line-1"></a><a name="instance%20Enum%20Float"></a><span class="hs-keyword">instance</span>  <span class="hs-conid">Enum</span> <span class="hs-conid">Float</span>  <span class="hs-keyword">where</span>
<a name="line-2"></a>    <span class="hs-varid">succ</span> <span class="hs-varid">x</span>         <span class="hs-keyglyph">=</span> <span class="hs-varid">x</span> <span class="hs-varop">+</span> <span class="hs-num">1</span>
<a name="line-3"></a>    <span class="hs-varid">pred</span> <span class="hs-varid">x</span>         <span class="hs-keyglyph">=</span> <span class="hs-varid">x</span> <span class="hs-comment">-</span> <span class="hs-num">1</span>
<a name="line-4"></a>    <span class="hs-varid">toEnum</span>         <span class="hs-keyglyph">=</span> <span class="hs-varid">int2Float</span>
<a name="line-5"></a>    <span class="hs-varid">fromEnum</span>       <span class="hs-keyglyph">=</span> <span class="hs-varid">fromInteger</span> <span class="hs-varop">.</span> <span class="hs-varid">truncate</span>   <span class="hs-comment">-- may overflow</span>
<a name="line-6"></a>    <span class="hs-varid">enumFrom</span>       <span class="hs-keyglyph">=</span> <span class="hs-varid">numericEnumFrom</span>
<a name="line-7"></a>    <span class="hs-varid">enumFromTo</span>     <span class="hs-keyglyph">=</span> <span class="hs-varid">numericEnumFromTo</span>
<a name="line-8"></a>    <span class="hs-varid">enumFromThen</span>   <span class="hs-keyglyph">=</span> <span class="hs-varid">numericEnumFromThen</span>
<a name="line-9"></a>    <span class="hs-varid">enumFromThenTo</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">numericEnumFromThenTo</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="instance%20Enum%20Double"></a><span class="hs-keyword">instance</span>  <span class="hs-conid">Enum</span> <span class="hs-conid">Double</span>  <span class="hs-keyword">where</span>
<a name="line-12"></a>    <span class="hs-varid">succ</span> <span class="hs-varid">x</span>         <span class="hs-keyglyph">=</span> <span class="hs-varid">x</span> <span class="hs-varop">+</span> <span class="hs-num">1</span>
<a name="line-13"></a>    <span class="hs-varid">pred</span> <span class="hs-varid">x</span>         <span class="hs-keyglyph">=</span> <span class="hs-varid">x</span> <span class="hs-comment">-</span> <span class="hs-num">1</span>
<a name="line-14"></a>    <span class="hs-varid">toEnum</span>         <span class="hs-keyglyph">=</span>  <span class="hs-varid">int2Double</span>
<a name="line-15"></a>    <span class="hs-varid">fromEnum</span>       <span class="hs-keyglyph">=</span>  <span class="hs-varid">fromInteger</span> <span class="hs-varop">.</span> <span class="hs-varid">truncate</span>   <span class="hs-comment">-- may overflow</span>
<a name="line-16"></a>    <span class="hs-varid">enumFrom</span>       <span class="hs-keyglyph">=</span>  <span class="hs-varid">numericEnumFrom</span>
<a name="line-17"></a>    <span class="hs-varid">enumFromTo</span>     <span class="hs-keyglyph">=</span>  <span class="hs-varid">numericEnumFromTo</span>
<a name="line-18"></a>    <span class="hs-varid">enumFromThen</span>   <span class="hs-keyglyph">=</span>  <span class="hs-varid">numericEnumFromThen</span>
<a name="line-19"></a>    <span class="hs-varid">enumFromThenTo</span> <span class="hs-keyglyph">=</span>  <span class="hs-varid">numericEnumFromThenTo</span>
</pre>\end{code}


%*********************************************************
%*                                                      *
\subsection{Printing floating point}
%*                                                      *
%*********************************************************


\begin{code}
<pre><a name="line-1"></a><a name="showFloat"></a><span class="hs-comment">-- | Show a signed 'RealFloat' value to full precision</span>
<a name="line-2"></a><span class="hs-comment">-- using standard decimal notation for arguments whose absolute value lies</span>
<a name="line-3"></a><span class="hs-comment">-- between @0.1@ and @9,999,999@, and scientific notation otherwise.</span>
<a name="line-4"></a><span class="hs-definition">showFloat</span> <span class="hs-keyglyph">::</span> <span class="hs-layout">(</span><span class="hs-conid">RealFloat</span> <span class="hs-varid">a</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=&gt;</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">ShowS</span>
<a name="line-5"></a><span class="hs-definition">showFloat</span> <span class="hs-varid">x</span>  <span class="hs-keyglyph">=</span>  <span class="hs-varid">showString</span> <span class="hs-layout">(</span><span class="hs-varid">formatRealFloat</span> <span class="hs-conid">FFGeneric</span> <span class="hs-conid">Nothing</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-6"></a>
<a name="line-7"></a><span class="hs-comment">-- These are the format types.  This type is not exported.</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="FFFormat"></a><span class="hs-keyword">data</span> <span class="hs-conid">FFFormat</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">FFExponent</span> <span class="hs-keyglyph">|</span> <span class="hs-conid">FFFixed</span> <span class="hs-keyglyph">|</span> <span class="hs-conid">FFGeneric</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="formatRealFloat"></a><span class="hs-definition">formatRealFloat</span> <span class="hs-keyglyph">::</span> <span class="hs-layout">(</span><span class="hs-conid">RealFloat</span> <span class="hs-varid">a</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=&gt;</span> <span class="hs-conid">FFFormat</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Maybe</span> <span class="hs-conid">Int</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">String</span>
<a name="line-12"></a><span class="hs-definition">formatRealFloat</span> <span class="hs-varid">fmt</span> <span class="hs-varid">decs</span> <span class="hs-varid">x</span>
<a name="line-13"></a>   <span class="hs-keyglyph">|</span> <span class="hs-varid">isNaN</span> <span class="hs-varid">x</span>                   <span class="hs-keyglyph">=</span> <span class="hs-str">&quot;NaN&quot;</span>
<a name="line-14"></a>   <span class="hs-keyglyph">|</span> <span class="hs-varid">isInfinite</span> <span class="hs-varid">x</span>              <span class="hs-keyglyph">=</span> <span class="hs-keyword">if</span> <span class="hs-varid">x</span> <span class="hs-varop">&lt;</span> <span class="hs-num">0</span> <span class="hs-keyword">then</span> <span class="hs-str">&quot;-Infinity&quot;</span> <span class="hs-keyword">else</span> <span class="hs-str">&quot;Infinity&quot;</span>
<a name="line-15"></a>   <span class="hs-keyglyph">|</span> <span class="hs-varid">x</span> <span class="hs-varop">&lt;</span> <span class="hs-num">0</span> <span class="hs-varop">||</span> <span class="hs-varid">isNegativeZero</span> <span class="hs-varid">x</span> <span class="hs-keyglyph">=</span> <span class="hs-chr">'-'</span><span class="hs-conop">:</span><span class="hs-varid">doFmt</span> <span class="hs-varid">fmt</span> <span class="hs-layout">(</span><span class="hs-varid">floatToDigits</span> <span class="hs-layout">(</span><span class="hs-varid">toInteger</span> <span class="hs-varid">base</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-varid">x</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-16"></a>   <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span>                 <span class="hs-keyglyph">=</span> <span class="hs-varid">doFmt</span> <span class="hs-varid">fmt</span> <span class="hs-layout">(</span><span class="hs-varid">floatToDigits</span> <span class="hs-layout">(</span><span class="hs-varid">toInteger</span> <span class="hs-varid">base</span><span class="hs-layout">)</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-17"></a> <span class="hs-keyword">where</span>
<a name="line-18"></a>  <span class="hs-varid">base</span> <span class="hs-keyglyph">=</span> <span class="hs-num">10</span>
<a name="line-19"></a>
<a name="line-20"></a>  <span class="hs-varid">doFmt</span> <span class="hs-varid">format</span> <span class="hs-layout">(</span><span class="hs-varid">is</span><span class="hs-layout">,</span> <span class="hs-varid">e</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span>
<a name="line-21"></a>    <span class="hs-keyword">let</span> <span class="hs-varid">ds</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">map</span> <span class="hs-varid">intToDigit</span> <span class="hs-varid">is</span> <span class="hs-keyword">in</span>
<a name="line-22"></a>    <span class="hs-keyword">case</span> <span class="hs-varid">format</span> <span class="hs-keyword">of</span>
<a name="line-23"></a>     <span class="hs-conid">FFGeneric</span> <span class="hs-keyglyph">-&gt;</span>
<a name="line-24"></a>      <span class="hs-varid">doFmt</span> <span class="hs-layout">(</span><span class="hs-keyword">if</span> <span class="hs-varid">e</span> <span class="hs-varop">&lt;</span> <span class="hs-num">0</span> <span class="hs-varop">||</span> <span class="hs-varid">e</span> <span class="hs-varop">&gt;</span> <span class="hs-num">7</span> <span class="hs-keyword">then</span> <span class="hs-conid">FFExponent</span> <span class="hs-keyword">else</span> <span class="hs-conid">FFFixed</span><span class="hs-layout">)</span>
<a name="line-25"></a>            <span class="hs-layout">(</span><span class="hs-varid">is</span><span class="hs-layout">,</span><span class="hs-varid">e</span><span class="hs-layout">)</span>
<a name="line-26"></a>     <span class="hs-conid">FFExponent</span> <span class="hs-keyglyph">-&gt;</span>
<a name="line-27"></a>      <span class="hs-keyword">case</span> <span class="hs-varid">decs</span> <span class="hs-keyword">of</span>
<a name="line-28"></a>       <span class="hs-conid">Nothing</span> <span class="hs-keyglyph">-&gt;</span>
<a name="line-29"></a>        <span class="hs-keyword">let</span> <span class="hs-varid">show_e'</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">show</span> <span class="hs-layout">(</span><span class="hs-varid">e</span><span class="hs-comment">-</span><span class="hs-num">1</span><span class="hs-layout">)</span> <span class="hs-keyword">in</span>
<a name="line-30"></a>        <span class="hs-keyword">case</span> <span class="hs-varid">ds</span> <span class="hs-keyword">of</span>
<a name="line-31"></a>          <span class="hs-str">&quot;0&quot;</span>     <span class="hs-keyglyph">-&gt;</span> <span class="hs-str">&quot;0.0e0&quot;</span>
<a name="line-32"></a>          <span class="hs-keyglyph">[</span><span class="hs-varid">d</span><span class="hs-keyglyph">]</span>     <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">d</span> <span class="hs-conop">:</span> <span class="hs-str">&quot;.0e&quot;</span> <span class="hs-varop">++</span> <span class="hs-varid">show_e'</span>
<a name="line-33"></a>          <span class="hs-layout">(</span><span class="hs-varid">d</span><span class="hs-conop">:</span><span class="hs-varid">ds'</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">d</span> <span class="hs-conop">:</span> <span class="hs-chr">'.'</span> <span class="hs-conop">:</span> <span class="hs-varid">ds'</span> <span class="hs-varop">++</span> <span class="hs-str">&quot;e&quot;</span> <span class="hs-varop">++</span> <span class="hs-varid">show_e'</span>
<a name="line-34"></a>          <span class="hs-conid">[]</span>      <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">error</span> <span class="hs-str">&quot;formatRealFloat/doFmt/FFExponent: []&quot;</span>
<a name="line-35"></a>       <span class="hs-conid">Just</span> <span class="hs-varid">dec</span> <span class="hs-keyglyph">-&gt;</span>
<a name="line-36"></a>        <span class="hs-keyword">let</span> <span class="hs-varid">dec'</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">max</span> <span class="hs-varid">dec</span> <span class="hs-num">1</span> <span class="hs-keyword">in</span>
<a name="line-37"></a>        <span class="hs-keyword">case</span> <span class="hs-varid">is</span> <span class="hs-keyword">of</span>
<a name="line-38"></a>         <span class="hs-keyglyph">[</span><span class="hs-num">0</span><span class="hs-keyglyph">]</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-chr">'0'</span> <span class="hs-conop">:</span><span class="hs-chr">'.'</span> <span class="hs-conop">:</span> <span class="hs-varid">take</span> <span class="hs-varid">dec'</span> <span class="hs-layout">(</span><span class="hs-varid">repeat</span> <span class="hs-chr">'0'</span><span class="hs-layout">)</span> <span class="hs-varop">++</span> <span class="hs-str">&quot;e0&quot;</span>
<a name="line-39"></a>         <span class="hs-keyword">_</span> <span class="hs-keyglyph">-&gt;</span>
<a name="line-40"></a>          <span class="hs-keyword">let</span>
<a name="line-41"></a>           <span class="hs-layout">(</span><span class="hs-varid">ei</span><span class="hs-layout">,</span><span class="hs-varid">is'</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">roundTo</span> <span class="hs-varid">base</span> <span class="hs-layout">(</span><span class="hs-varid">dec'</span><span class="hs-varop">+</span><span class="hs-num">1</span><span class="hs-layout">)</span> <span class="hs-varid">is</span>
<a name="line-42"></a>           <span class="hs-layout">(</span><span class="hs-varid">d</span><span class="hs-conop">:</span><span class="hs-varid">ds'</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">map</span> <span class="hs-varid">intToDigit</span> <span class="hs-layout">(</span><span class="hs-keyword">if</span> <span class="hs-varid">ei</span> <span class="hs-varop">&gt;</span> <span class="hs-num">0</span> <span class="hs-keyword">then</span> <span class="hs-varid">init</span> <span class="hs-varid">is'</span> <span class="hs-keyword">else</span> <span class="hs-varid">is'</span><span class="hs-layout">)</span>
<a name="line-43"></a>          <span class="hs-keyword">in</span>
<a name="line-44"></a>          <span class="hs-varid">d</span><span class="hs-conop">:</span><span class="hs-chr">'.'</span><span class="hs-conop">:</span><span class="hs-varid">ds'</span> <span class="hs-varop">++</span> <span class="hs-chr">'e'</span><span class="hs-conop">:</span><span class="hs-varid">show</span> <span class="hs-layout">(</span><span class="hs-varid">e</span><span class="hs-comment">-</span><span class="hs-num">1</span><span class="hs-varop">+</span><span class="hs-varid">ei</span><span class="hs-layout">)</span>
<a name="line-45"></a>     <span class="hs-conid">FFFixed</span> <span class="hs-keyglyph">-&gt;</span>
<a name="line-46"></a>      <span class="hs-keyword">let</span>
<a name="line-47"></a>       <span class="hs-varid">mk0</span> <span class="hs-varid">ls</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-varid">ls</span> <span class="hs-keyword">of</span> <span class="hs-layout">{</span> <span class="hs-str">&quot;&quot;</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-str">&quot;0&quot;</span> <span class="hs-layout">;</span> <span class="hs-keyword">_</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">ls</span><span class="hs-layout">}</span>
<a name="line-48"></a>      <span class="hs-keyword">in</span>
<a name="line-49"></a>      <span class="hs-keyword">case</span> <span class="hs-varid">decs</span> <span class="hs-keyword">of</span>
<a name="line-50"></a>       <span class="hs-conid">Nothing</span>
<a name="line-51"></a>          <span class="hs-keyglyph">|</span> <span class="hs-varid">e</span> <span class="hs-varop">&lt;=</span> <span class="hs-num">0</span>    <span class="hs-keyglyph">-&gt;</span> <span class="hs-str">&quot;0.&quot;</span> <span class="hs-varop">++</span> <span class="hs-varid">replicate</span> <span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-varid">e</span><span class="hs-layout">)</span> <span class="hs-chr">'0'</span> <span class="hs-varop">++</span> <span class="hs-varid">ds</span>
<a name="line-52"></a>          <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span> <span class="hs-keyglyph">-&gt;</span>
<a name="line-53"></a>             <span class="hs-keyword">let</span>
<a name="line-54"></a>                <span class="hs-varid">f</span> <span class="hs-num">0</span> <span class="hs-varid">s</span>    <span class="hs-varid">rs</span>  <span class="hs-keyglyph">=</span> <span class="hs-varid">mk0</span> <span class="hs-layout">(</span><span class="hs-varid">reverse</span> <span class="hs-varid">s</span><span class="hs-layout">)</span> <span class="hs-varop">++</span> <span class="hs-chr">'.'</span><span class="hs-conop">:</span><span class="hs-varid">mk0</span> <span class="hs-varid">rs</span>
<a name="line-55"></a>                <span class="hs-varid">f</span> <span class="hs-varid">n</span> <span class="hs-varid">s</span>    <span class="hs-str">&quot;&quot;</span>  <span class="hs-keyglyph">=</span> <span class="hs-varid">f</span> <span class="hs-layout">(</span><span class="hs-varid">n</span><span class="hs-comment">-</span><span class="hs-num">1</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-chr">'0'</span><span class="hs-conop">:</span><span class="hs-varid">s</span><span class="hs-layout">)</span> <span class="hs-str">&quot;&quot;</span>
<a name="line-56"></a>                <span class="hs-varid">f</span> <span class="hs-varid">n</span> <span class="hs-varid">s</span> <span class="hs-layout">(</span><span class="hs-varid">r</span><span class="hs-conop">:</span><span class="hs-varid">rs</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">f</span> <span class="hs-layout">(</span><span class="hs-varid">n</span><span class="hs-comment">-</span><span class="hs-num">1</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-varid">r</span><span class="hs-conop">:</span><span class="hs-varid">s</span><span class="hs-layout">)</span> <span class="hs-varid">rs</span>
<a name="line-57"></a>             <span class="hs-keyword">in</span>
<a name="line-58"></a>                <span class="hs-varid">f</span> <span class="hs-varid">e</span> <span class="hs-str">&quot;&quot;</span> <span class="hs-varid">ds</span>
<a name="line-59"></a>       <span class="hs-conid">Just</span> <span class="hs-varid">dec</span> <span class="hs-keyglyph">-&gt;</span>
<a name="line-60"></a>        <span class="hs-keyword">let</span> <span class="hs-varid">dec'</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">max</span> <span class="hs-varid">dec</span> <span class="hs-num">0</span> <span class="hs-keyword">in</span>
<a name="line-61"></a>        <span class="hs-keyword">if</span> <span class="hs-varid">e</span> <span class="hs-varop">&gt;=</span> <span class="hs-num">0</span> <span class="hs-keyword">then</span>
<a name="line-62"></a>         <span class="hs-keyword">let</span>
<a name="line-63"></a>          <span class="hs-layout">(</span><span class="hs-varid">ei</span><span class="hs-layout">,</span><span class="hs-varid">is'</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">roundTo</span> <span class="hs-varid">base</span> <span class="hs-layout">(</span><span class="hs-varid">dec'</span> <span class="hs-varop">+</span> <span class="hs-varid">e</span><span class="hs-layout">)</span> <span class="hs-varid">is</span>
<a name="line-64"></a>          <span class="hs-layout">(</span><span class="hs-varid">ls</span><span class="hs-layout">,</span><span class="hs-varid">rs</span><span class="hs-layout">)</span>  <span class="hs-keyglyph">=</span> <span class="hs-varid">splitAt</span> <span class="hs-layout">(</span><span class="hs-varid">e</span><span class="hs-varop">+</span><span class="hs-varid">ei</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-varid">map</span> <span class="hs-varid">intToDigit</span> <span class="hs-varid">is'</span><span class="hs-layout">)</span>
<a name="line-65"></a>         <span class="hs-keyword">in</span>
<a name="line-66"></a>         <span class="hs-varid">mk0</span> <span class="hs-varid">ls</span> <span class="hs-varop">++</span> <span class="hs-layout">(</span><span class="hs-keyword">if</span> <span class="hs-varid">null</span> <span class="hs-varid">rs</span> <span class="hs-keyword">then</span> <span class="hs-str">&quot;&quot;</span> <span class="hs-keyword">else</span> <span class="hs-chr">'.'</span><span class="hs-conop">:</span><span class="hs-varid">rs</span><span class="hs-layout">)</span>
<a name="line-67"></a>        <span class="hs-keyword">else</span>
<a name="line-68"></a>         <span class="hs-keyword">let</span>
<a name="line-69"></a>          <span class="hs-layout">(</span><span class="hs-varid">ei</span><span class="hs-layout">,</span><span class="hs-varid">is'</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">roundTo</span> <span class="hs-varid">base</span> <span class="hs-varid">dec'</span> <span class="hs-layout">(</span><span class="hs-varid">replicate</span> <span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-varid">e</span><span class="hs-layout">)</span> <span class="hs-num">0</span> <span class="hs-varop">++</span> <span class="hs-varid">is</span><span class="hs-layout">)</span>
<a name="line-70"></a>          <span class="hs-varid">d</span><span class="hs-conop">:</span><span class="hs-varid">ds'</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">map</span> <span class="hs-varid">intToDigit</span> <span class="hs-layout">(</span><span class="hs-keyword">if</span> <span class="hs-varid">ei</span> <span class="hs-varop">&gt;</span> <span class="hs-num">0</span> <span class="hs-keyword">then</span> <span class="hs-varid">is'</span> <span class="hs-keyword">else</span> <span class="hs-num">0</span><span class="hs-conop">:</span><span class="hs-varid">is'</span><span class="hs-layout">)</span>
<a name="line-71"></a>         <span class="hs-keyword">in</span>
<a name="line-72"></a>         <span class="hs-varid">d</span> <span class="hs-conop">:</span> <span class="hs-layout">(</span><span class="hs-keyword">if</span> <span class="hs-varid">null</span> <span class="hs-varid">ds'</span> <span class="hs-keyword">then</span> <span class="hs-str">&quot;&quot;</span> <span class="hs-keyword">else</span> <span class="hs-chr">'.'</span><span class="hs-conop">:</span><span class="hs-varid">ds'</span><span class="hs-layout">)</span>
<a name="line-73"></a>
<a name="line-74"></a>
<a name="line-75"></a><a name="roundTo"></a><span class="hs-definition">roundTo</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Int</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyglyph">[</span><span class="hs-conid">Int</span><span class="hs-keyglyph">]</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-layout">(</span><span class="hs-conid">Int</span><span class="hs-layout">,</span><span class="hs-keyglyph">[</span><span class="hs-conid">Int</span><span class="hs-keyglyph">]</span><span class="hs-layout">)</span>
<a name="line-76"></a><span class="hs-definition">roundTo</span> <span class="hs-varid">base</span> <span class="hs-varid">d</span> <span class="hs-varid">is</span> <span class="hs-keyglyph">=</span>
<a name="line-77"></a>  <span class="hs-keyword">case</span> <span class="hs-varid">f</span> <span class="hs-varid">d</span> <span class="hs-conid">True</span> <span class="hs-varid">is</span> <span class="hs-keyword">of</span>
<a name="line-78"></a>    <span class="hs-varid">x</span><span class="hs-keyglyph">@</span><span class="hs-layout">(</span><span class="hs-num">0</span><span class="hs-layout">,</span><span class="hs-keyword">_</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">x</span>
<a name="line-79"></a>    <span class="hs-layout">(</span><span class="hs-num">1</span><span class="hs-layout">,</span><span class="hs-varid">xs</span><span class="hs-layout">)</span>  <span class="hs-keyglyph">-&gt;</span> <span class="hs-layout">(</span><span class="hs-num">1</span><span class="hs-layout">,</span> <span class="hs-num">1</span><span class="hs-conop">:</span><span class="hs-varid">xs</span><span class="hs-layout">)</span>
<a name="line-80"></a>    <span class="hs-keyword">_</span>       <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">error</span> <span class="hs-str">&quot;roundTo: bad Value&quot;</span>
<a name="line-81"></a> <span class="hs-keyword">where</span>
<a name="line-82"></a>  <span class="hs-varid">b2</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">base</span> <span class="hs-varop">`quot`</span> <span class="hs-num">2</span>
<a name="line-83"></a>
<a name="line-84"></a>  <span class="hs-varid">f</span> <span class="hs-varid">n</span> <span class="hs-keyword">_</span> <span class="hs-conid">[]</span>     <span class="hs-keyglyph">=</span> <span class="hs-layout">(</span><span class="hs-num">0</span><span class="hs-layout">,</span> <span class="hs-varid">replicate</span> <span class="hs-varid">n</span> <span class="hs-num">0</span><span class="hs-layout">)</span>
<a name="line-85"></a>  <span class="hs-varid">f</span> <span class="hs-num">0</span> <span class="hs-varid">e</span> <span class="hs-layout">(</span><span class="hs-varid">x</span><span class="hs-conop">:</span><span class="hs-varid">xs</span><span class="hs-layout">)</span> <span class="hs-keyglyph">|</span> <span class="hs-varid">x</span> <span class="hs-varop">==</span> <span class="hs-varid">b2</span> <span class="hs-varop">&amp;&amp;</span> <span class="hs-varid">e</span> <span class="hs-varop">&amp;&amp;</span> <span class="hs-varid">all</span> <span class="hs-layout">(</span><span class="hs-varop">==</span> <span class="hs-num">0</span><span class="hs-layout">)</span> <span class="hs-varid">xs</span> <span class="hs-keyglyph">=</span> <span class="hs-layout">(</span><span class="hs-num">0</span><span class="hs-layout">,</span> <span class="hs-conid">[]</span><span class="hs-layout">)</span>   <span class="hs-comment">-- Round to even when at exactly half the base</span>
<a name="line-86"></a>               <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span> <span class="hs-keyglyph">=</span> <span class="hs-layout">(</span><span class="hs-keyword">if</span> <span class="hs-varid">x</span> <span class="hs-varop">&gt;=</span> <span class="hs-varid">b2</span> <span class="hs-keyword">then</span> <span class="hs-num">1</span> <span class="hs-keyword">else</span> <span class="hs-num">0</span><span class="hs-layout">,</span> <span class="hs-conid">[]</span><span class="hs-layout">)</span>
<a name="line-87"></a>  <span class="hs-varid">f</span> <span class="hs-varid">n</span> <span class="hs-keyword">_</span> <span class="hs-layout">(</span><span class="hs-varid">i</span><span class="hs-conop">:</span><span class="hs-varid">xs</span><span class="hs-layout">)</span>
<a name="line-88"></a>     <span class="hs-keyglyph">|</span> <span class="hs-varid">i'</span> <span class="hs-varop">==</span> <span class="hs-varid">base</span> <span class="hs-keyglyph">=</span> <span class="hs-layout">(</span><span class="hs-num">1</span><span class="hs-layout">,</span><span class="hs-num">0</span><span class="hs-conop">:</span><span class="hs-varid">ds</span><span class="hs-layout">)</span>
<a name="line-89"></a>     <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span>  <span class="hs-keyglyph">=</span> <span class="hs-layout">(</span><span class="hs-num">0</span><span class="hs-layout">,</span><span class="hs-varid">i'</span><span class="hs-conop">:</span><span class="hs-varid">ds</span><span class="hs-layout">)</span>
<a name="line-90"></a>      <span class="hs-keyword">where</span>
<a name="line-91"></a>       <span class="hs-layout">(</span><span class="hs-varid">c</span><span class="hs-layout">,</span><span class="hs-varid">ds</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">f</span> <span class="hs-layout">(</span><span class="hs-varid">n</span><span class="hs-comment">-</span><span class="hs-num">1</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-varid">even</span> <span class="hs-varid">i</span><span class="hs-layout">)</span> <span class="hs-varid">xs</span>
<a name="line-92"></a>       <span class="hs-varid">i'</span>     <span class="hs-keyglyph">=</span> <span class="hs-varid">c</span> <span class="hs-varop">+</span> <span class="hs-varid">i</span>
<a name="line-93"></a>
<a name="line-94"></a><span class="hs-comment">-- Based on &quot;Printing Floating-Point Numbers Quickly and Accurately&quot;</span>
<a name="line-95"></a><span class="hs-comment">-- by R.G. Burger and R.K. Dybvig in PLDI 96.</span>
<a name="line-96"></a><span class="hs-comment">-- This version uses a much slower logarithm estimator. It should be improved.</span>
<a name="line-97"></a>
<a name="line-98"></a><span class="hs-comment">-- | 'floatToDigits' takes a base and a non-negative 'RealFloat' number,</span>
<a name="line-99"></a><span class="hs-comment">-- and returns a list of digits and an exponent.</span>
<a name="line-100"></a><span class="hs-comment">-- In particular, if @x&gt;=0@, and</span>
<a name="line-101"></a><span class="hs-comment">--</span>
<a name="line-102"></a><span class="hs-comment">-- &gt; floatToDigits base x = ([d1,d2,...,dn], e)</span>
<a name="line-103"></a><span class="hs-comment">--</span>
<a name="line-104"></a><span class="hs-comment">-- then</span>
<a name="line-105"></a><span class="hs-comment">--</span>
<a name="line-106"></a><span class="hs-comment">--      (1) @n &gt;= 1@</span>
<a name="line-107"></a><span class="hs-comment">--</span>
<a name="line-108"></a><span class="hs-comment">--      (2) @x = 0.d1d2...dn * (base**e)@</span>
<a name="line-109"></a><span class="hs-comment">--</span>
<a name="line-110"></a><span class="hs-comment">--      (3) @0 &lt;= di &lt;= base-1@</span>
<a name="line-111"></a>
<a name="line-112"></a><a name="floatToDigits"></a><span class="hs-definition">floatToDigits</span> <span class="hs-keyglyph">::</span> <span class="hs-layout">(</span><span class="hs-conid">RealFloat</span> <span class="hs-varid">a</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=&gt;</span> <span class="hs-conid">Integer</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-layout">(</span><span class="hs-keyglyph">[</span><span class="hs-conid">Int</span><span class="hs-keyglyph">]</span><span class="hs-layout">,</span> <span class="hs-conid">Int</span><span class="hs-layout">)</span>
<a name="line-113"></a><span class="hs-definition">floatToDigits</span> <span class="hs-keyword">_</span> <span class="hs-num">0</span> <span class="hs-keyglyph">=</span> <span class="hs-layout">(</span><span class="hs-keyglyph">[</span><span class="hs-num">0</span><span class="hs-keyglyph">]</span><span class="hs-layout">,</span> <span class="hs-num">0</span><span class="hs-layout">)</span>
<a name="line-114"></a><span class="hs-definition">floatToDigits</span> <span class="hs-varid">base</span> <span class="hs-varid">x</span> <span class="hs-keyglyph">=</span>
<a name="line-115"></a> <span class="hs-keyword">let</span>
<a name="line-116"></a>  <span class="hs-layout">(</span><span class="hs-varid">f0</span><span class="hs-layout">,</span> <span class="hs-varid">e0</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">decodeFloat</span> <span class="hs-varid">x</span>
<a name="line-117"></a>  <span class="hs-layout">(</span><span class="hs-varid">minExp0</span><span class="hs-layout">,</span> <span class="hs-keyword">_</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">floatRange</span> <span class="hs-varid">x</span>
<a name="line-118"></a>  <span class="hs-varid">p</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">floatDigits</span> <span class="hs-varid">x</span>
<a name="line-119"></a>  <span class="hs-varid">b</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">floatRadix</span> <span class="hs-varid">x</span>
<a name="line-120"></a>  <span class="hs-varid">minExp</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">minExp0</span> <span class="hs-comment">-</span> <span class="hs-varid">p</span> <span class="hs-comment">-- the real minimum exponent</span>
<a name="line-121"></a>  <span class="hs-comment">-- Haskell requires that f be adjusted so denormalized numbers</span>
<a name="line-122"></a>  <span class="hs-comment">-- will have an impossibly low exponent.  Adjust for this.</span>
<a name="line-123"></a>  <span class="hs-layout">(</span><span class="hs-varid">f</span><span class="hs-layout">,</span> <span class="hs-varid">e</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span>
<a name="line-124"></a>   <span class="hs-keyword">let</span> <span class="hs-varid">n</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">minExp</span> <span class="hs-comment">-</span> <span class="hs-varid">e0</span> <span class="hs-keyword">in</span>
<a name="line-125"></a>   <span class="hs-keyword">if</span> <span class="hs-varid">n</span> <span class="hs-varop">&gt;</span> <span class="hs-num">0</span> <span class="hs-keyword">then</span> <span class="hs-layout">(</span><span class="hs-varid">f0</span> <span class="hs-varop">`quot`</span> <span class="hs-layout">(</span><span class="hs-varid">expt</span> <span class="hs-varid">b</span> <span class="hs-varid">n</span><span class="hs-layout">)</span><span class="hs-layout">,</span> <span class="hs-varid">e0</span><span class="hs-varop">+</span><span class="hs-varid">n</span><span class="hs-layout">)</span> <span class="hs-keyword">else</span> <span class="hs-layout">(</span><span class="hs-varid">f0</span><span class="hs-layout">,</span> <span class="hs-varid">e0</span><span class="hs-layout">)</span>
<a name="line-126"></a>  <span class="hs-layout">(</span><span class="hs-varid">r</span><span class="hs-layout">,</span> <span class="hs-varid">s</span><span class="hs-layout">,</span> <span class="hs-varid">mUp</span><span class="hs-layout">,</span> <span class="hs-varid">mDn</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span>
<a name="line-127"></a>   <span class="hs-keyword">if</span> <span class="hs-varid">e</span> <span class="hs-varop">&gt;=</span> <span class="hs-num">0</span> <span class="hs-keyword">then</span>
<a name="line-128"></a>    <span class="hs-keyword">let</span> <span class="hs-varid">be</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">expt</span> <span class="hs-varid">b</span> <span class="hs-varid">e</span> <span class="hs-keyword">in</span>
<a name="line-129"></a>    <span class="hs-keyword">if</span> <span class="hs-varid">f</span> <span class="hs-varop">==</span> <span class="hs-varid">expt</span> <span class="hs-varid">b</span> <span class="hs-layout">(</span><span class="hs-varid">p</span><span class="hs-comment">-</span><span class="hs-num">1</span><span class="hs-layout">)</span> <span class="hs-keyword">then</span>
<a name="line-130"></a>      <span class="hs-layout">(</span><span class="hs-varid">f</span><span class="hs-varop">*</span><span class="hs-varid">be</span><span class="hs-varop">*</span><span class="hs-varid">b</span><span class="hs-varop">*</span><span class="hs-num">2</span><span class="hs-layout">,</span> <span class="hs-num">2</span><span class="hs-varop">*</span><span class="hs-varid">b</span><span class="hs-layout">,</span> <span class="hs-varid">be</span><span class="hs-varop">*</span><span class="hs-varid">b</span><span class="hs-layout">,</span> <span class="hs-varid">be</span><span class="hs-layout">)</span>     <span class="hs-comment">-- according to Burger and Dybvig</span>
<a name="line-131"></a>    <span class="hs-keyword">else</span>
<a name="line-132"></a>      <span class="hs-layout">(</span><span class="hs-varid">f</span><span class="hs-varop">*</span><span class="hs-varid">be</span><span class="hs-varop">*</span><span class="hs-num">2</span><span class="hs-layout">,</span> <span class="hs-num">2</span><span class="hs-layout">,</span> <span class="hs-varid">be</span><span class="hs-layout">,</span> <span class="hs-varid">be</span><span class="hs-layout">)</span>
<a name="line-133"></a>   <span class="hs-keyword">else</span>
<a name="line-134"></a>    <span class="hs-keyword">if</span> <span class="hs-varid">e</span> <span class="hs-varop">&gt;</span> <span class="hs-varid">minExp</span> <span class="hs-varop">&amp;&amp;</span> <span class="hs-varid">f</span> <span class="hs-varop">==</span> <span class="hs-varid">expt</span> <span class="hs-varid">b</span> <span class="hs-layout">(</span><span class="hs-varid">p</span><span class="hs-comment">-</span><span class="hs-num">1</span><span class="hs-layout">)</span> <span class="hs-keyword">then</span>
<a name="line-135"></a>      <span class="hs-layout">(</span><span class="hs-varid">f</span><span class="hs-varop">*</span><span class="hs-varid">b</span><span class="hs-varop">*</span><span class="hs-num">2</span><span class="hs-layout">,</span> <span class="hs-varid">expt</span> <span class="hs-varid">b</span> <span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-varid">e</span><span class="hs-varop">+</span><span class="hs-num">1</span><span class="hs-layout">)</span><span class="hs-varop">*</span><span class="hs-num">2</span><span class="hs-layout">,</span> <span class="hs-varid">b</span><span class="hs-layout">,</span> <span class="hs-num">1</span><span class="hs-layout">)</span>
<a name="line-136"></a>    <span class="hs-keyword">else</span>
<a name="line-137"></a>      <span class="hs-layout">(</span><span class="hs-varid">f</span><span class="hs-varop">*</span><span class="hs-num">2</span><span class="hs-layout">,</span> <span class="hs-varid">expt</span> <span class="hs-varid">b</span> <span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-varid">e</span><span class="hs-layout">)</span><span class="hs-varop">*</span><span class="hs-num">2</span><span class="hs-layout">,</span> <span class="hs-num">1</span><span class="hs-layout">,</span> <span class="hs-num">1</span><span class="hs-layout">)</span>
<a name="line-138"></a>  <span class="hs-varid">k</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Int</span>
<a name="line-139"></a>  <span class="hs-varid">k</span> <span class="hs-keyglyph">=</span>
<a name="line-140"></a>   <span class="hs-keyword">let</span>
<a name="line-141"></a>    <span class="hs-varid">k0</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Int</span>
<a name="line-142"></a>    <span class="hs-varid">k0</span> <span class="hs-keyglyph">=</span>
<a name="line-143"></a>     <span class="hs-keyword">if</span> <span class="hs-varid">b</span> <span class="hs-varop">==</span> <span class="hs-num">2</span> <span class="hs-varop">&amp;&amp;</span> <span class="hs-varid">base</span> <span class="hs-varop">==</span> <span class="hs-num">10</span> <span class="hs-keyword">then</span>
<a name="line-144"></a>        <span class="hs-comment">-- logBase 10 2 is very slightly larger than 8651/28738</span>
<a name="line-145"></a>        <span class="hs-comment">-- (about 5.3558e-10), so if log x &gt;= 0, the approximation</span>
<a name="line-146"></a>        <span class="hs-comment">-- k1 is too small, hence we add one and need one fixup step less.</span>
<a name="line-147"></a>        <span class="hs-comment">-- If log x &lt; 0, the approximation errs rather on the high side.</span>
<a name="line-148"></a>        <span class="hs-comment">-- That is usually more than compensated for by ignoring the</span>
<a name="line-149"></a>        <span class="hs-comment">-- fractional part of logBase 2 x, but when x is a power of 1/2</span>
<a name="line-150"></a>        <span class="hs-comment">-- or slightly larger and the exponent is a multiple of the</span>
<a name="line-151"></a>        <span class="hs-comment">-- denominator of the rational approximation to logBase 10 2,</span>
<a name="line-152"></a>        <span class="hs-comment">-- k1 is larger than logBase 10 x. If k1 &gt; 1 + logBase 10 x,</span>
<a name="line-153"></a>        <span class="hs-comment">-- we get a leading zero-digit we don't want.</span>
<a name="line-154"></a>        <span class="hs-comment">-- With the approximation 3/10, this happened for</span>
<a name="line-155"></a>        <span class="hs-comment">-- 0.5^1030, 0.5^1040, ..., 0.5^1070 and values close above.</span>
<a name="line-156"></a>        <span class="hs-comment">-- The approximation 8651/28738 guarantees k1 &lt; 1 + logBase 10 x</span>
<a name="line-157"></a>        <span class="hs-comment">-- for IEEE-ish floating point types with exponent fields</span>
<a name="line-158"></a>        <span class="hs-comment">-- &lt;= 17 bits and mantissae of several thousand bits, earlier</span>
<a name="line-159"></a>        <span class="hs-comment">-- convergents to logBase 10 2 would fail for long double.</span>
<a name="line-160"></a>        <span class="hs-comment">-- Using quot instead of div is a little faster and requires</span>
<a name="line-161"></a>        <span class="hs-comment">-- fewer fixup steps for negative lx.</span>
<a name="line-162"></a>        <span class="hs-keyword">let</span> <span class="hs-varid">lx</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">p</span> <span class="hs-comment">-</span> <span class="hs-num">1</span> <span class="hs-varop">+</span> <span class="hs-varid">e0</span>
<a name="line-163"></a>            <span class="hs-varid">k1</span> <span class="hs-keyglyph">=</span> <span class="hs-layout">(</span><span class="hs-varid">lx</span> <span class="hs-varop">*</span> <span class="hs-num">8651</span><span class="hs-layout">)</span> <span class="hs-varop">`quot`</span> <span class="hs-num">28738</span>
<a name="line-164"></a>        <span class="hs-keyword">in</span> <span class="hs-keyword">if</span> <span class="hs-varid">lx</span> <span class="hs-varop">&gt;=</span> <span class="hs-num">0</span> <span class="hs-keyword">then</span> <span class="hs-varid">k1</span> <span class="hs-varop">+</span> <span class="hs-num">1</span> <span class="hs-keyword">else</span> <span class="hs-varid">k1</span>
<a name="line-165"></a>     <span class="hs-keyword">else</span>
<a name="line-166"></a>	<span class="hs-comment">-- f :: Integer, log :: Float -&gt; Float,</span>
<a name="line-167"></a>        <span class="hs-comment">--               ceiling :: Float -&gt; Int</span>
<a name="line-168"></a>        <span class="hs-varid">ceiling</span> <span class="hs-layout">(</span><span class="hs-layout">(</span><span class="hs-varid">log</span> <span class="hs-layout">(</span><span class="hs-varid">fromInteger</span> <span class="hs-layout">(</span><span class="hs-varid">f</span><span class="hs-varop">+</span><span class="hs-num">1</span><span class="hs-layout">)</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Float</span><span class="hs-layout">)</span> <span class="hs-varop">+</span>
<a name="line-169"></a>                 <span class="hs-varid">fromIntegral</span> <span class="hs-varid">e</span> <span class="hs-varop">*</span> <span class="hs-varid">log</span> <span class="hs-layout">(</span><span class="hs-varid">fromInteger</span> <span class="hs-varid">b</span><span class="hs-layout">)</span><span class="hs-layout">)</span> <span class="hs-varop">/</span>
<a name="line-170"></a>                   <span class="hs-varid">log</span> <span class="hs-layout">(</span><span class="hs-varid">fromInteger</span> <span class="hs-varid">base</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-171"></a><span class="hs-comment">--WAS:            fromInt e * log (fromInteger b))</span>
<a name="line-172"></a>
<a name="line-173"></a>    <span class="hs-varid">fixup</span> <span class="hs-varid">n</span> <span class="hs-keyglyph">=</span>
<a name="line-174"></a>      <span class="hs-keyword">if</span> <span class="hs-varid">n</span> <span class="hs-varop">&gt;=</span> <span class="hs-num">0</span> <span class="hs-keyword">then</span>
<a name="line-175"></a>        <span class="hs-keyword">if</span> <span class="hs-varid">r</span> <span class="hs-varop">+</span> <span class="hs-varid">mUp</span> <span class="hs-varop">&lt;=</span> <span class="hs-varid">expt</span> <span class="hs-varid">base</span> <span class="hs-varid">n</span> <span class="hs-varop">*</span> <span class="hs-varid">s</span> <span class="hs-keyword">then</span> <span class="hs-varid">n</span> <span class="hs-keyword">else</span> <span class="hs-varid">fixup</span> <span class="hs-layout">(</span><span class="hs-varid">n</span><span class="hs-varop">+</span><span class="hs-num">1</span><span class="hs-layout">)</span>
<a name="line-176"></a>      <span class="hs-keyword">else</span>
<a name="line-177"></a>        <span class="hs-keyword">if</span> <span class="hs-varid">expt</span> <span class="hs-varid">base</span> <span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-varid">n</span><span class="hs-layout">)</span> <span class="hs-varop">*</span> <span class="hs-layout">(</span><span class="hs-varid">r</span> <span class="hs-varop">+</span> <span class="hs-varid">mUp</span><span class="hs-layout">)</span> <span class="hs-varop">&lt;=</span> <span class="hs-varid">s</span> <span class="hs-keyword">then</span> <span class="hs-varid">n</span> <span class="hs-keyword">else</span> <span class="hs-varid">fixup</span> <span class="hs-layout">(</span><span class="hs-varid">n</span><span class="hs-varop">+</span><span class="hs-num">1</span><span class="hs-layout">)</span>
<a name="line-178"></a>   <span class="hs-keyword">in</span>
<a name="line-179"></a>   <span class="hs-varid">fixup</span> <span class="hs-varid">k0</span>
<a name="line-180"></a>
<a name="line-181"></a>  <span class="hs-varid">gen</span> <span class="hs-varid">ds</span> <span class="hs-varid">rn</span> <span class="hs-varid">sN</span> <span class="hs-varid">mUpN</span> <span class="hs-varid">mDnN</span> <span class="hs-keyglyph">=</span>
<a name="line-182"></a>   <span class="hs-keyword">let</span>
<a name="line-183"></a>    <span class="hs-layout">(</span><span class="hs-varid">dn</span><span class="hs-layout">,</span> <span class="hs-varid">rn'</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-layout">(</span><span class="hs-varid">rn</span> <span class="hs-varop">*</span> <span class="hs-varid">base</span><span class="hs-layout">)</span> <span class="hs-varop">`quotRem`</span> <span class="hs-varid">sN</span>
<a name="line-184"></a>    <span class="hs-varid">mUpN'</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">mUpN</span> <span class="hs-varop">*</span> <span class="hs-varid">base</span>
<a name="line-185"></a>    <span class="hs-varid">mDnN'</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">mDnN</span> <span class="hs-varop">*</span> <span class="hs-varid">base</span>
<a name="line-186"></a>   <span class="hs-keyword">in</span>
<a name="line-187"></a>   <span class="hs-keyword">case</span> <span class="hs-layout">(</span><span class="hs-varid">rn'</span> <span class="hs-varop">&lt;</span> <span class="hs-varid">mDnN'</span><span class="hs-layout">,</span> <span class="hs-varid">rn'</span> <span class="hs-varop">+</span> <span class="hs-varid">mUpN'</span> <span class="hs-varop">&gt;</span> <span class="hs-varid">sN</span><span class="hs-layout">)</span> <span class="hs-keyword">of</span>
<a name="line-188"></a>    <span class="hs-layout">(</span><span class="hs-conid">True</span><span class="hs-layout">,</span>  <span class="hs-conid">False</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">dn</span> <span class="hs-conop">:</span> <span class="hs-varid">ds</span>
<a name="line-189"></a>    <span class="hs-layout">(</span><span class="hs-conid">False</span><span class="hs-layout">,</span> <span class="hs-conid">True</span><span class="hs-layout">)</span>  <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">dn</span><span class="hs-varop">+</span><span class="hs-num">1</span> <span class="hs-conop">:</span> <span class="hs-varid">ds</span>
<a name="line-190"></a>    <span class="hs-layout">(</span><span class="hs-conid">True</span><span class="hs-layout">,</span>  <span class="hs-conid">True</span><span class="hs-layout">)</span>  <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyword">if</span> <span class="hs-varid">rn'</span> <span class="hs-varop">*</span> <span class="hs-num">2</span> <span class="hs-varop">&lt;</span> <span class="hs-varid">sN</span> <span class="hs-keyword">then</span> <span class="hs-varid">dn</span> <span class="hs-conop">:</span> <span class="hs-varid">ds</span> <span class="hs-keyword">else</span> <span class="hs-varid">dn</span><span class="hs-varop">+</span><span class="hs-num">1</span> <span class="hs-conop">:</span> <span class="hs-varid">ds</span>
<a name="line-191"></a>    <span class="hs-layout">(</span><span class="hs-conid">False</span><span class="hs-layout">,</span> <span class="hs-conid">False</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">gen</span> <span class="hs-layout">(</span><span class="hs-varid">dn</span><span class="hs-conop">:</span><span class="hs-varid">ds</span><span class="hs-layout">)</span> <span class="hs-varid">rn'</span> <span class="hs-varid">sN</span> <span class="hs-varid">mUpN'</span> <span class="hs-varid">mDnN'</span>
<a name="line-192"></a>
<a name="line-193"></a>  <span class="hs-varid">rds</span> <span class="hs-keyglyph">=</span>
<a name="line-194"></a>   <span class="hs-keyword">if</span> <span class="hs-varid">k</span> <span class="hs-varop">&gt;=</span> <span class="hs-num">0</span> <span class="hs-keyword">then</span>
<a name="line-195"></a>      <span class="hs-varid">gen</span> <span class="hs-conid">[]</span> <span class="hs-varid">r</span> <span class="hs-layout">(</span><span class="hs-varid">s</span> <span class="hs-varop">*</span> <span class="hs-varid">expt</span> <span class="hs-varid">base</span> <span class="hs-varid">k</span><span class="hs-layout">)</span> <span class="hs-varid">mUp</span> <span class="hs-varid">mDn</span>
<a name="line-196"></a>   <span class="hs-keyword">else</span>
<a name="line-197"></a>     <span class="hs-keyword">let</span> <span class="hs-varid">bk</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">expt</span> <span class="hs-varid">base</span> <span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-varid">k</span><span class="hs-layout">)</span> <span class="hs-keyword">in</span>
<a name="line-198"></a>     <span class="hs-varid">gen</span> <span class="hs-conid">[]</span> <span class="hs-layout">(</span><span class="hs-varid">r</span> <span class="hs-varop">*</span> <span class="hs-varid">bk</span><span class="hs-layout">)</span> <span class="hs-varid">s</span> <span class="hs-layout">(</span><span class="hs-varid">mUp</span> <span class="hs-varop">*</span> <span class="hs-varid">bk</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-varid">mDn</span> <span class="hs-varop">*</span> <span class="hs-varid">bk</span><span class="hs-layout">)</span>
<a name="line-199"></a> <span class="hs-keyword">in</span>
<a name="line-200"></a> <span class="hs-layout">(</span><span class="hs-varid">map</span> <span class="hs-varid">fromIntegral</span> <span class="hs-layout">(</span><span class="hs-varid">reverse</span> <span class="hs-varid">rds</span><span class="hs-layout">)</span><span class="hs-layout">,</span> <span class="hs-varid">k</span><span class="hs-layout">)</span>
<a name="line-201"></a>
</pre>\end{code}


%*********************************************************
%*                                                      *
\subsection{Converting from a Rational to a RealFloat
%*                                                      *
%*********************************************************

[In response to a request for documentation of how fromRational works,
Joe Fasel writes:] A quite reasonable request!  This code was added to
the Prelude just before the 1.2 release, when Lennart, working with an
early version of hbi, noticed that (read . show) was not the identity
for floating-point numbers.  (There was a one-bit error about half the
time.)  The original version of the conversion function was in fact
simply a floating-point divide, as you suggest above. The new version
is, I grant you, somewhat denser.

Unfortunately, Joe's code doesn't work!  Here's an example:

main = putStr (shows (1.82173691287639817263897126389712638972163e-300::Double) &quot;\n&quot;)

This program prints
        0.0000000000000000
instead of
        1.8217369128763981e-300

Here's Joe's code:

\begin{pseudocode}
fromRat :: (RealFloat a) =&gt; Rational -&gt; a
fromRat x = x'
        where x' = f e

--              If the exponent of the nearest floating-point number to x
--              is e, then the significand is the integer nearest xb^(-e),
--              where b is the floating-point radix.  We start with a good
--              guess for e, and if it is correct, the exponent of the
--              floating-point number we construct will again be e.  If
--              not, one more iteration is needed.

              f e   = if e' == e then y else f e'
                      where y      = encodeFloat (round (x * (1 % b)^^e)) e
                            (_,e') = decodeFloat y
              b     = floatRadix x'

--              We obtain a trial exponent by doing a floating-point
--              division of x's numerator by its denominator.  The
--              result of this division may not itself be the ultimate
--              result, because of an accumulation of three rounding
--              errors.

              (s,e) = decodeFloat (fromInteger (numerator x) `asTypeOf` x'
                                        / fromInteger (denominator x))
\end{pseudocode}

Now, here's Lennart's code (which works)

\begin{code}
<pre><a name="line-1"></a><a name="fromRat"></a><span class="hs-comment">-- | Converts a 'Rational' value into any type in class 'RealFloat'.</span>
<a name="line-2"></a><span class="hs-comment">{-# RULES
<a name="line-3"></a>&quot;fromRat/Float&quot;     fromRat = (fromRational :: Rational -&gt; Float)
<a name="line-4"></a>&quot;fromRat/Double&quot;    fromRat = (fromRational :: Rational -&gt; Double)
<a name="line-5"></a>  #-}</span>
<a name="line-6"></a><span class="hs-definition">fromRat</span> <span class="hs-keyglyph">::</span> <span class="hs-layout">(</span><span class="hs-conid">RealFloat</span> <span class="hs-varid">a</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=&gt;</span> <span class="hs-conid">Rational</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span>
<a name="line-7"></a>
<a name="line-8"></a><span class="hs-comment">-- Deal with special cases first, delegating the real work to fromRat'</span>
<a name="line-9"></a><span class="hs-definition">fromRat</span> <span class="hs-layout">(</span><span class="hs-varid">n</span> <span class="hs-conop">:%</span> <span class="hs-num">0</span><span class="hs-layout">)</span> <span class="hs-keyglyph">|</span> <span class="hs-varid">n</span> <span class="hs-varop">&gt;</span> <span class="hs-num">0</span>     <span class="hs-keyglyph">=</span>  <span class="hs-num">1</span><span class="hs-varop">/</span><span class="hs-num">0</span>        <span class="hs-comment">-- +Infinity</span>
<a name="line-10"></a>                 <span class="hs-keyglyph">|</span> <span class="hs-varid">n</span> <span class="hs-varop">&lt;</span> <span class="hs-num">0</span>     <span class="hs-keyglyph">=</span> <span class="hs-comment">-</span><span class="hs-num">1</span><span class="hs-varop">/</span><span class="hs-num">0</span>        <span class="hs-comment">-- -Infinity</span>
<a name="line-11"></a>                 <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span> <span class="hs-keyglyph">=</span>  <span class="hs-num">0</span><span class="hs-varop">/</span><span class="hs-num">0</span>        <span class="hs-comment">-- NaN</span>
<a name="line-12"></a>
<a name="line-13"></a><span class="hs-definition">fromRat</span> <span class="hs-layout">(</span><span class="hs-varid">n</span> <span class="hs-conop">:%</span> <span class="hs-varid">d</span><span class="hs-layout">)</span> <span class="hs-keyglyph">|</span> <span class="hs-varid">n</span> <span class="hs-varop">&gt;</span> <span class="hs-num">0</span>     <span class="hs-keyglyph">=</span> <span class="hs-varid">fromRat'</span> <span class="hs-layout">(</span><span class="hs-varid">n</span> <span class="hs-conop">:%</span> <span class="hs-varid">d</span><span class="hs-layout">)</span>
<a name="line-14"></a>                 <span class="hs-keyglyph">|</span> <span class="hs-varid">n</span> <span class="hs-varop">&lt;</span> <span class="hs-num">0</span>     <span class="hs-keyglyph">=</span> <span class="hs-comment">-</span> <span class="hs-varid">fromRat'</span> <span class="hs-layout">(</span><span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-varid">n</span><span class="hs-layout">)</span> <span class="hs-conop">:%</span> <span class="hs-varid">d</span><span class="hs-layout">)</span>
<a name="line-15"></a>                 <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">encodeFloat</span> <span class="hs-num">0</span> <span class="hs-num">0</span>             <span class="hs-comment">-- Zero</span>
<a name="line-16"></a>
<a name="line-17"></a><span class="hs-comment">-- Conversion process:</span>
<a name="line-18"></a><span class="hs-comment">-- Scale the rational number by the RealFloat base until</span>
<a name="line-19"></a><span class="hs-comment">-- it lies in the range of the mantissa (as used by decodeFloat/encodeFloat).</span>
<a name="line-20"></a><span class="hs-comment">-- Then round the rational to an Integer and encode it with the exponent</span>
<a name="line-21"></a><span class="hs-comment">-- that we got from the scaling.</span>
<a name="line-22"></a><span class="hs-comment">-- To speed up the scaling process we compute the log2 of the number to get</span>
<a name="line-23"></a><span class="hs-comment">-- a first guess of the exponent.</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="fromRat'"></a><span class="hs-definition">fromRat'</span> <span class="hs-keyglyph">::</span> <span class="hs-layout">(</span><span class="hs-conid">RealFloat</span> <span class="hs-varid">a</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=&gt;</span> <span class="hs-conid">Rational</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span>
<a name="line-26"></a><span class="hs-comment">-- Invariant: argument is strictly positive</span>
<a name="line-27"></a><span class="hs-definition">fromRat'</span> <span class="hs-varid">x</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">r</span>
<a name="line-28"></a>  <span class="hs-keyword">where</span> <span class="hs-varid">b</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">floatRadix</span> <span class="hs-varid">r</span>
<a name="line-29"></a>        <span class="hs-varid">p</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">floatDigits</span> <span class="hs-varid">r</span>
<a name="line-30"></a>        <span class="hs-layout">(</span><span class="hs-varid">minExp0</span><span class="hs-layout">,</span> <span class="hs-keyword">_</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">floatRange</span> <span class="hs-varid">r</span>
<a name="line-31"></a>        <span class="hs-varid">minExp</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">minExp0</span> <span class="hs-comment">-</span> <span class="hs-varid">p</span>            <span class="hs-comment">-- the real minimum exponent</span>
<a name="line-32"></a>        <span class="hs-varid">xMax</span>   <span class="hs-keyglyph">=</span> <span class="hs-varid">toRational</span> <span class="hs-layout">(</span><span class="hs-varid">expt</span> <span class="hs-varid">b</span> <span class="hs-varid">p</span><span class="hs-layout">)</span>
<a name="line-33"></a>        <span class="hs-varid">p0</span> <span class="hs-keyglyph">=</span> <span class="hs-layout">(</span><span class="hs-varid">integerLogBase</span> <span class="hs-varid">b</span> <span class="hs-layout">(</span><span class="hs-varid">numerator</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-comment">-</span> <span class="hs-varid">integerLogBase</span> <span class="hs-varid">b</span> <span class="hs-layout">(</span><span class="hs-varid">denominator</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-comment">-</span> <span class="hs-varid">p</span><span class="hs-layout">)</span> <span class="hs-varop">`max`</span> <span class="hs-varid">minExp</span>
<a name="line-34"></a>        <span class="hs-comment">-- if x = n/d and ln = integerLogBase b n, ld = integerLogBase b d,</span>
<a name="line-35"></a>        <span class="hs-comment">-- then b^(ln-ld-1) &lt; x &lt; b^(ln-ld+1)</span>
<a name="line-36"></a>        <span class="hs-varid">f</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">if</span> <span class="hs-varid">p0</span> <span class="hs-varop">&lt;</span> <span class="hs-num">0</span> <span class="hs-keyword">then</span> <span class="hs-num">1</span> <span class="hs-conop">:%</span> <span class="hs-varid">expt</span> <span class="hs-varid">b</span> <span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-varid">p0</span><span class="hs-layout">)</span> <span class="hs-keyword">else</span> <span class="hs-varid">expt</span> <span class="hs-varid">b</span> <span class="hs-varid">p0</span> <span class="hs-conop">:%</span> <span class="hs-num">1</span>
<a name="line-37"></a>        <span class="hs-varid">x0</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">x</span> <span class="hs-varop">/</span> <span class="hs-varid">f</span>
<a name="line-38"></a>        <span class="hs-comment">-- if ln - ld &gt;= minExp0, then b^(p-1) &lt; x0 &lt; b^(p+1), so there's at most</span>
<a name="line-39"></a>        <span class="hs-comment">-- one scaling step needed, otherwise, x0 &lt; b^p and no scaling is needed</span>
<a name="line-40"></a>        <span class="hs-layout">(</span><span class="hs-varid">x'</span><span class="hs-layout">,</span> <span class="hs-varid">p'</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">if</span> <span class="hs-varid">x0</span> <span class="hs-varop">&gt;=</span> <span class="hs-varid">xMax</span> <span class="hs-keyword">then</span> <span class="hs-layout">(</span><span class="hs-varid">x0</span> <span class="hs-varop">/</span> <span class="hs-varid">toRational</span> <span class="hs-varid">b</span><span class="hs-layout">,</span> <span class="hs-varid">p0</span><span class="hs-varop">+</span><span class="hs-num">1</span><span class="hs-layout">)</span> <span class="hs-keyword">else</span> <span class="hs-layout">(</span><span class="hs-varid">x0</span><span class="hs-layout">,</span> <span class="hs-varid">p0</span><span class="hs-layout">)</span>
<a name="line-41"></a>        <span class="hs-varid">r</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">encodeFloat</span> <span class="hs-layout">(</span><span class="hs-varid">round</span> <span class="hs-varid">x'</span><span class="hs-layout">)</span> <span class="hs-varid">p'</span>
<a name="line-42"></a>
<a name="line-43"></a><a name="minExpt"></a><span class="hs-comment">-- Exponentiation with a cache for the most common numbers.</span>
<a name="line-44"></a><span class="hs-definition">minExpt</span><span class="hs-layout">,</span> <span class="hs-varid">maxExpt</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Int</span>
<a name="line-45"></a><span class="hs-definition">minExpt</span> <span class="hs-keyglyph">=</span> <span class="hs-num">0</span>
<a name="line-46"></a><a name="maxExpt"></a><span class="hs-definition">maxExpt</span> <span class="hs-keyglyph">=</span> <span class="hs-num">1100</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="expt"></a><span class="hs-definition">expt</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Integer</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Integer</span>
<a name="line-49"></a><span class="hs-definition">expt</span> <span class="hs-varid">base</span> <span class="hs-varid">n</span> <span class="hs-keyglyph">=</span>
<a name="line-50"></a>    <span class="hs-keyword">if</span> <span class="hs-varid">base</span> <span class="hs-varop">==</span> <span class="hs-num">2</span> <span class="hs-varop">&amp;&amp;</span> <span class="hs-varid">n</span> <span class="hs-varop">&gt;=</span> <span class="hs-varid">minExpt</span> <span class="hs-varop">&amp;&amp;</span> <span class="hs-varid">n</span> <span class="hs-varop">&lt;=</span> <span class="hs-varid">maxExpt</span> <span class="hs-keyword">then</span>
<a name="line-51"></a>        <span class="hs-varid">expts</span><span class="hs-varop">!</span><span class="hs-varid">n</span>
<a name="line-52"></a>    <span class="hs-keyword">else</span>
<a name="line-53"></a>        <span class="hs-keyword">if</span> <span class="hs-varid">base</span> <span class="hs-varop">==</span> <span class="hs-num">10</span> <span class="hs-varop">&amp;&amp;</span> <span class="hs-varid">n</span> <span class="hs-varop">&lt;=</span> <span class="hs-varid">maxExpt10</span> <span class="hs-keyword">then</span>
<a name="line-54"></a>            <span class="hs-varid">expts10</span><span class="hs-varop">!</span><span class="hs-varid">n</span>
<a name="line-55"></a>        <span class="hs-keyword">else</span>
<a name="line-56"></a>            <span class="hs-varid">base</span><span class="hs-varop">^</span><span class="hs-varid">n</span>
<a name="line-57"></a>
<a name="line-58"></a><a name="expts"></a><span class="hs-definition">expts</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Array</span> <span class="hs-conid">Int</span> <span class="hs-conid">Integer</span>
<a name="line-59"></a><span class="hs-definition">expts</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">array</span> <span class="hs-layout">(</span><span class="hs-varid">minExpt</span><span class="hs-layout">,</span><span class="hs-varid">maxExpt</span><span class="hs-layout">)</span> <span class="hs-keyglyph">[</span><span class="hs-layout">(</span><span class="hs-varid">n</span><span class="hs-layout">,</span><span class="hs-num">2</span><span class="hs-varop">^</span><span class="hs-varid">n</span><span class="hs-layout">)</span> <span class="hs-keyglyph">|</span> <span class="hs-varid">n</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-keyglyph">[</span><span class="hs-varid">minExpt</span> <span class="hs-keyglyph">..</span> <span class="hs-varid">maxExpt</span><span class="hs-keyglyph">]</span><span class="hs-keyglyph">]</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="maxExpt10"></a><span class="hs-definition">maxExpt10</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Int</span>
<a name="line-62"></a><span class="hs-definition">maxExpt10</span> <span class="hs-keyglyph">=</span> <span class="hs-num">324</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="expts10"></a><span class="hs-definition">expts10</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Array</span> <span class="hs-conid">Int</span> <span class="hs-conid">Integer</span>
<a name="line-65"></a><span class="hs-definition">expts10</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">array</span> <span class="hs-layout">(</span><span class="hs-varid">minExpt</span><span class="hs-layout">,</span><span class="hs-varid">maxExpt10</span><span class="hs-layout">)</span> <span class="hs-keyglyph">[</span><span class="hs-layout">(</span><span class="hs-varid">n</span><span class="hs-layout">,</span><span class="hs-num">10</span><span class="hs-varop">^</span><span class="hs-varid">n</span><span class="hs-layout">)</span> <span class="hs-keyglyph">|</span> <span class="hs-varid">n</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-keyglyph">[</span><span class="hs-varid">minExpt</span> <span class="hs-keyglyph">..</span> <span class="hs-varid">maxExpt10</span><span class="hs-keyglyph">]</span><span class="hs-keyglyph">]</span>
<a name="line-66"></a>
<a name="line-67"></a><a name="integerLogBase"></a><span class="hs-comment">-- Compute the (floor of the) log of i in base b.</span>
<a name="line-68"></a><span class="hs-comment">-- Simplest way would be just divide i by b until it's smaller then b, but that would</span>
<a name="line-69"></a><span class="hs-comment">-- be very slow!  We are just slightly more clever, except for base 2, where</span>
<a name="line-70"></a><span class="hs-comment">-- we take advantage of the representation of Integers.</span>
<a name="line-71"></a><span class="hs-comment">-- The general case could be improved by a lookup table for</span>
<a name="line-72"></a><span class="hs-comment">-- approximating the result by integerLog2 i / integerLog2 b.</span>
<a name="line-73"></a><span class="hs-definition">integerLogBase</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Integer</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Integer</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int</span>
<a name="line-74"></a><span class="hs-definition">integerLogBase</span> <span class="hs-varid">b</span> <span class="hs-varid">i</span>
<a name="line-75"></a>   <span class="hs-keyglyph">|</span> <span class="hs-varid">i</span> <span class="hs-varop">&lt;</span> <span class="hs-varid">b</span>     <span class="hs-keyglyph">=</span> <span class="hs-num">0</span>
<a name="line-76"></a>   <span class="hs-keyglyph">|</span> <span class="hs-varid">b</span> <span class="hs-varop">==</span> <span class="hs-num">2</span>    <span class="hs-keyglyph">=</span> <span class="hs-conid">I</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">integerLog2</span><span class="hs-cpp">#</span> <span class="hs-varid">i</span><span class="hs-layout">)</span>
<a name="line-77"></a>   <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">I</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">integerLogBase</span><span class="hs-cpp">#</span> <span class="hs-varid">b</span> <span class="hs-varid">i</span><span class="hs-layout">)</span>
<a name="line-78"></a>
</pre>\end{code}

Unfortunately, the old conversion code was awfully slow due to
a) a slow integer logarithm
b) repeated calculation of gcd's

For the case of Rational's coming from a Float or Double via toRational,
we can exploit the fact that the denominator is a power of two, which for
these brings a huge speedup since we need only shift and add instead
of division.

The below is an adaption of fromRat' for the conversion to
Float or Double exploiting the known floatRadix and avoiding
divisions as much as possible.

\begin{code}
<pre><a name="line-1"></a><a name="fromRat''"></a><span class="hs-comment">{-# SPECIALISE fromRat'' :: Int -&gt; Int -&gt; Integer -&gt; Integer -&gt; Float,
<a name="line-2"></a>                            Int -&gt; Int -&gt; Integer -&gt; Integer -&gt; Double #-}</span>
<a name="line-3"></a><span class="hs-definition">fromRat''</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">RealFloat</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">=&gt;</span> <span class="hs-conid">Int</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Integer</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Integer</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span>
<a name="line-4"></a><span class="hs-comment">-- Invariant: n and d strictly positive</span>
<a name="line-5"></a><span class="hs-definition">fromRat''</span> <span class="hs-varid">minEx</span><span class="hs-keyglyph">@</span><span class="hs-layout">(</span><span class="hs-conid">I</span><span class="hs-cpp">#</span> <span class="hs-varid">me</span><span class="hs-cpp">#</span><span class="hs-layout">)</span> <span class="hs-varid">mantDigs</span><span class="hs-keyglyph">@</span><span class="hs-layout">(</span><span class="hs-conid">I</span><span class="hs-cpp">#</span> <span class="hs-varid">md</span><span class="hs-cpp">#</span><span class="hs-layout">)</span> <span class="hs-varid">n</span> <span class="hs-varid">d</span> <span class="hs-keyglyph">=</span>
<a name="line-6"></a>    <span class="hs-keyword">case</span> <span class="hs-varid">integerLog2IsPowerOf2</span><span class="hs-cpp">#</span> <span class="hs-varid">d</span> <span class="hs-keyword">of</span>
<a name="line-7"></a>      <span class="hs-layout">(</span><span class="hs-cpp">#</span> <span class="hs-varid">ld</span><span class="hs-cpp">#</span><span class="hs-layout">,</span> <span class="hs-varid">pw</span><span class="hs-cpp">#</span> <span class="hs-cpp">#</span><span class="hs-layout">)</span>
<a name="line-8"></a>        <span class="hs-keyglyph">|</span> <span class="hs-varid">pw</span><span class="hs-cpp">#</span> <span class="hs-varop">==#</span> <span class="hs-num">0</span><span class="hs-cpp">#</span> <span class="hs-keyglyph">-&gt;</span>
<a name="line-9"></a>          <span class="hs-keyword">case</span> <span class="hs-varid">integerLog2</span><span class="hs-cpp">#</span> <span class="hs-varid">n</span> <span class="hs-keyword">of</span>
<a name="line-10"></a>            <span class="hs-varid">ln</span><span class="hs-cpp">#</span> <span class="hs-keyglyph">|</span> <span class="hs-varid">ln</span><span class="hs-cpp">#</span> <span class="hs-varop">&gt;=#</span> <span class="hs-layout">(</span><span class="hs-varid">ld</span><span class="hs-cpp">#</span> <span class="hs-varop">+#</span> <span class="hs-varid">me</span><span class="hs-cpp">#</span> <span class="hs-varop">-#</span> <span class="hs-num">1</span><span class="hs-cpp">#</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span>
<a name="line-11"></a>                  <span class="hs-comment">-- this means n/d &gt;= 2^(minEx-1), i.e. we are guaranteed to get</span>
<a name="line-12"></a>                  <span class="hs-comment">-- a normalised number, round to mantDigs bits</span>
<a name="line-13"></a>                  <span class="hs-keyword">if</span> <span class="hs-varid">ln</span><span class="hs-cpp">#</span> <span class="hs-varop">&lt;#</span> <span class="hs-varid">md</span><span class="hs-cpp">#</span>
<a name="line-14"></a>                    <span class="hs-keyword">then</span> <span class="hs-varid">encodeFloat</span> <span class="hs-varid">n</span> <span class="hs-layout">(</span><span class="hs-conid">I</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">negateInt</span><span class="hs-cpp">#</span> <span class="hs-varid">ld</span><span class="hs-cpp">#</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-15"></a>                    <span class="hs-keyword">else</span> <span class="hs-keyword">let</span> <span class="hs-varid">n'</span>  <span class="hs-keyglyph">=</span> <span class="hs-varid">n</span> <span class="hs-varop">`shiftR`</span> <span class="hs-layout">(</span><span class="hs-conid">I</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">ln</span><span class="hs-cpp">#</span> <span class="hs-varop">+#</span> <span class="hs-num">1</span><span class="hs-cpp">#</span> <span class="hs-varop">-#</span> <span class="hs-varid">md</span><span class="hs-cpp">#</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-16"></a>                             <span class="hs-varid">n''</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-varid">roundingMode</span><span class="hs-cpp">#</span> <span class="hs-varid">n</span> <span class="hs-layout">(</span><span class="hs-varid">ln</span><span class="hs-cpp">#</span> <span class="hs-varop">-#</span> <span class="hs-varid">md</span><span class="hs-cpp">#</span><span class="hs-layout">)</span> <span class="hs-keyword">of</span>
<a name="line-17"></a>                                    <span class="hs-num">0</span><span class="hs-cpp">#</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">n'</span>
<a name="line-18"></a>                                    <span class="hs-num">2</span><span class="hs-cpp">#</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">n'</span> <span class="hs-varop">+</span> <span class="hs-num">1</span>
<a name="line-19"></a>                                    <span class="hs-keyword">_</span>  <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyword">case</span> <span class="hs-varid">fromInteger</span> <span class="hs-varid">n'</span> <span class="hs-varop">.&amp;.</span> <span class="hs-layout">(</span><span class="hs-num">1</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Int</span><span class="hs-layout">)</span> <span class="hs-keyword">of</span>
<a name="line-20"></a>                                            <span class="hs-num">0</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">n'</span>
<a name="line-21"></a>                                            <span class="hs-keyword">_</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">n'</span> <span class="hs-varop">+</span> <span class="hs-num">1</span>
<a name="line-22"></a>                         <span class="hs-keyword">in</span> <span class="hs-varid">encodeFloat</span> <span class="hs-varid">n''</span> <span class="hs-layout">(</span><span class="hs-conid">I</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">ln</span><span class="hs-cpp">#</span> <span class="hs-varop">-#</span> <span class="hs-varid">ld</span><span class="hs-cpp">#</span> <span class="hs-varop">+#</span> <span class="hs-num">1</span><span class="hs-cpp">#</span> <span class="hs-varop">-#</span> <span class="hs-varid">md</span><span class="hs-cpp">#</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-23"></a>                <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span> <span class="hs-keyglyph">-&gt;</span>
<a name="line-24"></a>                  <span class="hs-comment">-- n/d &lt; 2^(minEx-1), a denorm or rounded to 2^(minEx-1)</span>
<a name="line-25"></a>                  <span class="hs-comment">-- the exponent for encoding is always minEx-mantDigs</span>
<a name="line-26"></a>                  <span class="hs-comment">-- so we must shift right by (minEx-mantDigs) - (-ld)</span>
<a name="line-27"></a>                  <span class="hs-keyword">case</span> <span class="hs-varid">ld</span><span class="hs-cpp">#</span> <span class="hs-varop">+#</span> <span class="hs-layout">(</span><span class="hs-varid">me</span><span class="hs-cpp">#</span> <span class="hs-varop">-#</span> <span class="hs-varid">md</span><span class="hs-cpp">#</span><span class="hs-layout">)</span> <span class="hs-keyword">of</span>
<a name="line-28"></a>                    <span class="hs-varid">ld'</span><span class="hs-cpp">#</span> <span class="hs-keyglyph">|</span> <span class="hs-varid">ld'</span><span class="hs-cpp">#</span> <span class="hs-varop">&lt;=#</span> <span class="hs-num">0</span><span class="hs-cpp">#</span>  <span class="hs-keyglyph">-&gt;</span> <span class="hs-comment">-- we would shift left, so we don't shift</span>
<a name="line-29"></a>                           <span class="hs-varid">encodeFloat</span> <span class="hs-varid">n</span> <span class="hs-layout">(</span><span class="hs-conid">I</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-layout">(</span><span class="hs-varid">me</span><span class="hs-cpp">#</span> <span class="hs-varop">-#</span> <span class="hs-varid">md</span><span class="hs-cpp">#</span><span class="hs-layout">)</span> <span class="hs-varop">-#</span> <span class="hs-varid">ld'</span><span class="hs-cpp">#</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-30"></a>                         <span class="hs-keyglyph">|</span> <span class="hs-varid">ld'</span><span class="hs-cpp">#</span> <span class="hs-varop">&lt;=#</span> <span class="hs-varid">ln</span><span class="hs-cpp">#</span>  <span class="hs-keyglyph">-&gt;</span>
<a name="line-31"></a>                           <span class="hs-keyword">let</span> <span class="hs-varid">n'</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">n</span> <span class="hs-varop">`shiftR`</span> <span class="hs-layout">(</span><span class="hs-conid">I</span><span class="hs-cpp">#</span> <span class="hs-varid">ld'</span><span class="hs-cpp">#</span><span class="hs-layout">)</span>
<a name="line-32"></a>                           <span class="hs-keyword">in</span> <span class="hs-keyword">case</span> <span class="hs-varid">roundingMode</span><span class="hs-cpp">#</span> <span class="hs-varid">n</span> <span class="hs-layout">(</span><span class="hs-varid">ld'</span><span class="hs-cpp">#</span> <span class="hs-varop">-#</span> <span class="hs-num">1</span><span class="hs-cpp">#</span><span class="hs-layout">)</span> <span class="hs-keyword">of</span>
<a name="line-33"></a>                                <span class="hs-num">0</span><span class="hs-cpp">#</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">encodeFloat</span> <span class="hs-varid">n'</span> <span class="hs-layout">(</span><span class="hs-varid">minEx</span> <span class="hs-comment">-</span> <span class="hs-varid">mantDigs</span><span class="hs-layout">)</span>
<a name="line-34"></a>                                <span class="hs-num">1</span><span class="hs-cpp">#</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyword">if</span> <span class="hs-varid">fromInteger</span> <span class="hs-varid">n'</span> <span class="hs-varop">.&amp;.</span> <span class="hs-layout">(</span><span class="hs-num">1</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Int</span><span class="hs-layout">)</span> <span class="hs-varop">==</span> <span class="hs-num">0</span>
<a name="line-35"></a>                                        <span class="hs-keyword">then</span> <span class="hs-varid">encodeFloat</span> <span class="hs-varid">n'</span> <span class="hs-layout">(</span><span class="hs-varid">minEx</span><span class="hs-comment">-</span><span class="hs-varid">mantDigs</span><span class="hs-layout">)</span>
<a name="line-36"></a>                                        <span class="hs-keyword">else</span> <span class="hs-varid">encodeFloat</span> <span class="hs-layout">(</span><span class="hs-varid">n'</span> <span class="hs-varop">+</span> <span class="hs-num">1</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-varid">minEx</span><span class="hs-comment">-</span><span class="hs-varid">mantDigs</span><span class="hs-layout">)</span>
<a name="line-37"></a>                                <span class="hs-keyword">_</span>  <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">encodeFloat</span> <span class="hs-layout">(</span><span class="hs-varid">n'</span> <span class="hs-varop">+</span> <span class="hs-num">1</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-varid">minEx</span><span class="hs-comment">-</span><span class="hs-varid">mantDigs</span><span class="hs-layout">)</span>
<a name="line-38"></a>                         <span class="hs-keyglyph">|</span> <span class="hs-varid">ld'</span><span class="hs-cpp">#</span> <span class="hs-varop">&gt;#</span> <span class="hs-layout">(</span><span class="hs-varid">ln</span><span class="hs-cpp">#</span> <span class="hs-varop">+#</span> <span class="hs-num">1</span><span class="hs-cpp">#</span><span class="hs-layout">)</span>  <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">encodeFloat</span> <span class="hs-num">0</span> <span class="hs-num">0</span> <span class="hs-comment">-- result of shift &lt; 0.5</span>
<a name="line-39"></a>                         <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span> <span class="hs-keyglyph">-&gt;</span>  <span class="hs-comment">-- first bit of n shifted to 0.5 place</span>
<a name="line-40"></a>                           <span class="hs-keyword">case</span> <span class="hs-varid">integerLog2IsPowerOf2</span><span class="hs-cpp">#</span> <span class="hs-varid">n</span> <span class="hs-keyword">of</span>
<a name="line-41"></a>                            <span class="hs-layout">(</span><span class="hs-cpp">#</span> <span class="hs-keyword">_</span><span class="hs-layout">,</span> <span class="hs-num">0</span><span class="hs-cpp">#</span> <span class="hs-cpp">#</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">encodeFloat</span> <span class="hs-num">0</span> <span class="hs-num">0</span>  <span class="hs-comment">-- round to even</span>
<a name="line-42"></a>                            <span class="hs-layout">(</span><span class="hs-cpp">#</span> <span class="hs-keyword">_</span><span class="hs-layout">,</span> <span class="hs-keyword">_</span> <span class="hs-cpp">#</span><span class="hs-layout">)</span>  <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">encodeFloat</span> <span class="hs-num">1</span> <span class="hs-layout">(</span><span class="hs-varid">minEx</span> <span class="hs-comment">-</span> <span class="hs-varid">mantDigs</span><span class="hs-layout">)</span>
<a name="line-43"></a>        <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span> <span class="hs-keyglyph">-&gt;</span>
<a name="line-44"></a>          <span class="hs-keyword">let</span> <span class="hs-varid">ln</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">I</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">integerLog2</span><span class="hs-cpp">#</span> <span class="hs-varid">n</span><span class="hs-layout">)</span>
<a name="line-45"></a>              <span class="hs-varid">ld</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">I</span><span class="hs-cpp">#</span> <span class="hs-varid">ld</span><span class="hs-cpp">#</span>
<a name="line-46"></a>              <span class="hs-comment">-- 2^(ln-ld-1) &lt; n/d &lt; 2^(ln-ld+1)</span>
<a name="line-47"></a>              <span class="hs-varid">p0</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">max</span> <span class="hs-varid">minEx</span> <span class="hs-layout">(</span><span class="hs-varid">ln</span> <span class="hs-comment">-</span> <span class="hs-varid">ld</span><span class="hs-layout">)</span>
<a name="line-48"></a>              <span class="hs-layout">(</span><span class="hs-varid">n'</span><span class="hs-layout">,</span> <span class="hs-varid">d'</span><span class="hs-layout">)</span>
<a name="line-49"></a>                <span class="hs-keyglyph">|</span> <span class="hs-varid">p0</span> <span class="hs-varop">&lt;</span> <span class="hs-varid">mantDigs</span> <span class="hs-keyglyph">=</span> <span class="hs-layout">(</span><span class="hs-varid">n</span> <span class="hs-varop">`shiftL`</span> <span class="hs-layout">(</span><span class="hs-varid">mantDigs</span> <span class="hs-comment">-</span> <span class="hs-varid">p0</span><span class="hs-layout">)</span><span class="hs-layout">,</span> <span class="hs-varid">d</span><span class="hs-layout">)</span>
<a name="line-50"></a>                <span class="hs-keyglyph">|</span> <span class="hs-varid">p0</span> <span class="hs-varop">==</span> <span class="hs-varid">mantDigs</span> <span class="hs-keyglyph">=</span> <span class="hs-layout">(</span><span class="hs-varid">n</span><span class="hs-layout">,</span> <span class="hs-varid">d</span><span class="hs-layout">)</span>
<a name="line-51"></a>                <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span>     <span class="hs-keyglyph">=</span> <span class="hs-layout">(</span><span class="hs-varid">n</span><span class="hs-layout">,</span> <span class="hs-varid">d</span> <span class="hs-varop">`shiftL`</span> <span class="hs-layout">(</span><span class="hs-varid">p0</span> <span class="hs-comment">-</span> <span class="hs-varid">mantDigs</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-52"></a>              <span class="hs-comment">-- if ln-ld &lt; minEx, then n'/d' &lt; 2^mantDigs, else</span>
<a name="line-53"></a>              <span class="hs-comment">-- 2^(mantDigs-1) &lt; n'/d' &lt; 2^(mantDigs+1) and we</span>
<a name="line-54"></a>              <span class="hs-comment">-- may need one scaling step</span>
<a name="line-55"></a>              <span class="hs-varid">scale</span> <span class="hs-varid">p</span> <span class="hs-varid">a</span> <span class="hs-varid">b</span>
<a name="line-56"></a>                <span class="hs-keyglyph">|</span> <span class="hs-layout">(</span><span class="hs-varid">b</span> <span class="hs-varop">`shiftL`</span> <span class="hs-varid">mantDigs</span><span class="hs-layout">)</span> <span class="hs-varop">&lt;=</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">=</span> <span class="hs-layout">(</span><span class="hs-varid">p</span><span class="hs-varop">+</span><span class="hs-num">1</span><span class="hs-layout">,</span> <span class="hs-varid">a</span><span class="hs-layout">,</span> <span class="hs-varid">b</span> <span class="hs-varop">`shiftL`</span> <span class="hs-num">1</span><span class="hs-layout">)</span>
<a name="line-57"></a>                <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span> <span class="hs-keyglyph">=</span> <span class="hs-layout">(</span><span class="hs-varid">p</span><span class="hs-layout">,</span> <span class="hs-varid">a</span><span class="hs-layout">,</span> <span class="hs-varid">b</span><span class="hs-layout">)</span>
<a name="line-58"></a>              <span class="hs-layout">(</span><span class="hs-varid">p'</span><span class="hs-layout">,</span> <span class="hs-varid">n''</span><span class="hs-layout">,</span> <span class="hs-varid">d''</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">scale</span> <span class="hs-layout">(</span><span class="hs-varid">p0</span><span class="hs-comment">-</span><span class="hs-varid">mantDigs</span><span class="hs-layout">)</span> <span class="hs-varid">n'</span> <span class="hs-varid">d'</span>
<a name="line-59"></a>              <span class="hs-comment">-- n''/d'' &lt; 2^mantDigs and p' == minEx-mantDigs or n''/d'' &gt;= 2^(mantDigs-1)</span>
<a name="line-60"></a>              <span class="hs-varid">rdq</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-varid">n''</span> <span class="hs-varop">`quotRem`</span> <span class="hs-varid">d''</span> <span class="hs-keyword">of</span>
<a name="line-61"></a>                     <span class="hs-layout">(</span><span class="hs-varid">q</span><span class="hs-layout">,</span><span class="hs-varid">r</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyword">case</span> <span class="hs-varid">compare</span> <span class="hs-layout">(</span><span class="hs-varid">r</span> <span class="hs-varop">`shiftL`</span> <span class="hs-num">1</span><span class="hs-layout">)</span> <span class="hs-varid">d''</span> <span class="hs-keyword">of</span>
<a name="line-62"></a>                                <span class="hs-conid">LT</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">q</span>
<a name="line-63"></a>                                <span class="hs-conid">EQ</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyword">if</span> <span class="hs-varid">fromInteger</span> <span class="hs-varid">q</span> <span class="hs-varop">.&amp;.</span> <span class="hs-layout">(</span><span class="hs-num">1</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Int</span><span class="hs-layout">)</span> <span class="hs-varop">==</span> <span class="hs-num">0</span>
<a name="line-64"></a>                                        <span class="hs-keyword">then</span> <span class="hs-varid">q</span> <span class="hs-keyword">else</span> <span class="hs-varid">q</span><span class="hs-varop">+</span><span class="hs-num">1</span>
<a name="line-65"></a>                                <span class="hs-conid">GT</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">q</span><span class="hs-varop">+</span><span class="hs-num">1</span>
<a name="line-66"></a>          <span class="hs-keyword">in</span>  <span class="hs-varid">encodeFloat</span> <span class="hs-varid">rdq</span> <span class="hs-varid">p'</span>
</pre>\end{code}


%*********************************************************
%*                                                      *
\subsection{Floating point numeric primops}
%*                                                      *
%*********************************************************

Definitions of the boxed PrimOps; these will be
used in the case of partial applications, etc.

\begin{code}
<pre><a name="line-1"></a><a name="plusFloat"></a><span class="hs-definition">plusFloat</span><span class="hs-layout">,</span> <span class="hs-varid">minusFloat</span><span class="hs-layout">,</span> <span class="hs-varid">timesFloat</span><span class="hs-layout">,</span> <span class="hs-varid">divideFloat</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Float</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Float</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Float</span>
<a name="line-2"></a><span class="hs-definition">plusFloat</span>   <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">plusFloat</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span><span class="hs-layout">)</span>
<a name="line-3"></a><a name="minusFloat"></a><span class="hs-definition">minusFloat</span>  <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">minusFloat</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span><span class="hs-layout">)</span>
<a name="line-4"></a><a name="timesFloat"></a><span class="hs-definition">timesFloat</span>  <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">timesFloat</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span><span class="hs-layout">)</span>
<a name="line-5"></a><a name="divideFloat"></a><span class="hs-definition">divideFloat</span> <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">divideFloat</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span><span class="hs-layout">)</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="negateFloat"></a><span class="hs-definition">negateFloat</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Float</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Float</span>
<a name="line-8"></a><span class="hs-definition">negateFloat</span> <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>        <span class="hs-keyglyph">=</span> <span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">negateFloat</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="gtFloat"></a><span class="hs-definition">gtFloat</span><span class="hs-layout">,</span> <span class="hs-varid">geFloat</span><span class="hs-layout">,</span> <span class="hs-varid">eqFloat</span><span class="hs-layout">,</span> <span class="hs-varid">neFloat</span><span class="hs-layout">,</span> <span class="hs-varid">ltFloat</span><span class="hs-layout">,</span> <span class="hs-varid">leFloat</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Float</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Float</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Bool</span>
<a name="line-11"></a><span class="hs-definition">gtFloat</span>     <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">gtFloat</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span>
<a name="line-12"></a><a name="geFloat"></a><span class="hs-definition">geFloat</span>     <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">geFloat</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span>
<a name="line-13"></a><a name="eqFloat"></a><span class="hs-definition">eqFloat</span>     <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">eqFloat</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span>
<a name="line-14"></a><a name="neFloat"></a><span class="hs-definition">neFloat</span>     <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">neFloat</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span>
<a name="line-15"></a><a name="ltFloat"></a><span class="hs-definition">ltFloat</span>     <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">ltFloat</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span>
<a name="line-16"></a><a name="leFloat"></a><span class="hs-definition">leFloat</span>     <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">leFloat</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="expFloat"></a><span class="hs-definition">expFloat</span><span class="hs-layout">,</span> <span class="hs-varid">logFloat</span><span class="hs-layout">,</span> <span class="hs-varid">sqrtFloat</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Float</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Float</span>
<a name="line-19"></a><a name="sinFloat"></a><span class="hs-definition">sinFloat</span><span class="hs-layout">,</span> <span class="hs-varid">cosFloat</span><span class="hs-layout">,</span> <span class="hs-varid">tanFloat</span>  <span class="hs-keyglyph">::</span> <span class="hs-conid">Float</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Float</span>
<a name="line-20"></a><a name="asinFloat"></a><span class="hs-definition">asinFloat</span><span class="hs-layout">,</span> <span class="hs-varid">acosFloat</span><span class="hs-layout">,</span> <span class="hs-varid">atanFloat</span>  <span class="hs-keyglyph">::</span> <span class="hs-conid">Float</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Float</span>
<a name="line-21"></a><a name="sinhFloat"></a><span class="hs-definition">sinhFloat</span><span class="hs-layout">,</span> <span class="hs-varid">coshFloat</span><span class="hs-layout">,</span> <span class="hs-varid">tanhFloat</span>  <span class="hs-keyglyph">::</span> <span class="hs-conid">Float</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Float</span>
<a name="line-22"></a><span class="hs-definition">expFloat</span>    <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">expFloat</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-23"></a><a name="logFloat"></a><span class="hs-definition">logFloat</span>    <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">logFloat</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-24"></a><a name="sqrtFloat"></a><span class="hs-definition">sqrtFloat</span>   <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">sqrtFloat</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-25"></a><span class="hs-definition">sinFloat</span>    <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">sinFloat</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-26"></a><a name="cosFloat"></a><span class="hs-definition">cosFloat</span>    <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">cosFloat</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-27"></a><a name="tanFloat"></a><span class="hs-definition">tanFloat</span>    <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">tanFloat</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-28"></a><span class="hs-definition">asinFloat</span>   <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">asinFloat</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-29"></a><a name="acosFloat"></a><span class="hs-definition">acosFloat</span>   <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">acosFloat</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-30"></a><a name="atanFloat"></a><span class="hs-definition">atanFloat</span>   <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">atanFloat</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-31"></a><span class="hs-definition">sinhFloat</span>   <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">sinhFloat</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-32"></a><a name="coshFloat"></a><span class="hs-definition">coshFloat</span>   <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">coshFloat</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-33"></a><a name="tanhFloat"></a><span class="hs-definition">tanhFloat</span>   <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">tanhFloat</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="powerFloat"></a><span class="hs-definition">powerFloat</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Float</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Float</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Float</span>
<a name="line-36"></a><span class="hs-definition">powerFloat</span>  <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">powerFloat</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span> <span class="hs-varid">y</span><span class="hs-layout">)</span>
<a name="line-37"></a>
<a name="line-38"></a><span class="hs-comment">-- definitions of the boxed PrimOps; these will be</span>
<a name="line-39"></a><span class="hs-comment">-- used in the case of partial applications, etc.</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="plusDouble"></a><span class="hs-definition">plusDouble</span><span class="hs-layout">,</span> <span class="hs-varid">minusDouble</span><span class="hs-layout">,</span> <span class="hs-varid">timesDouble</span><span class="hs-layout">,</span> <span class="hs-varid">divideDouble</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Double</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Double</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Double</span>
<a name="line-42"></a><span class="hs-definition">plusDouble</span>   <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">x</span> <span class="hs-varop">+##</span> <span class="hs-varid">y</span><span class="hs-layout">)</span>
<a name="line-43"></a><a name="minusDouble"></a><span class="hs-definition">minusDouble</span>  <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">x</span> <span class="hs-varop">-##</span> <span class="hs-varid">y</span><span class="hs-layout">)</span>
<a name="line-44"></a><a name="timesDouble"></a><span class="hs-definition">timesDouble</span>  <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">x</span> <span class="hs-varop">*##</span> <span class="hs-varid">y</span><span class="hs-layout">)</span>
<a name="line-45"></a><a name="divideDouble"></a><span class="hs-definition">divideDouble</span> <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">x</span> <span class="hs-varop">/##</span> <span class="hs-varid">y</span><span class="hs-layout">)</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="negateDouble"></a><span class="hs-definition">negateDouble</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Double</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Double</span>
<a name="line-48"></a><span class="hs-definition">negateDouble</span> <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>        <span class="hs-keyglyph">=</span> <span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">negateDouble</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-49"></a>
<a name="line-50"></a><a name="gtDouble"></a><span class="hs-definition">gtDouble</span><span class="hs-layout">,</span> <span class="hs-varid">geDouble</span><span class="hs-layout">,</span> <span class="hs-varid">eqDouble</span><span class="hs-layout">,</span> <span class="hs-varid">neDouble</span><span class="hs-layout">,</span> <span class="hs-varid">leDouble</span><span class="hs-layout">,</span> <span class="hs-varid">ltDouble</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Double</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Double</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Bool</span>
<a name="line-51"></a><span class="hs-definition">gtDouble</span>    <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">x</span> <span class="hs-varop">&gt;##</span> <span class="hs-varid">y</span>
<a name="line-52"></a><a name="geDouble"></a><span class="hs-definition">geDouble</span>    <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">x</span> <span class="hs-varop">&gt;=##</span> <span class="hs-varid">y</span>
<a name="line-53"></a><a name="eqDouble"></a><span class="hs-definition">eqDouble</span>    <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">x</span> <span class="hs-varop">==##</span> <span class="hs-varid">y</span>
<a name="line-54"></a><a name="neDouble"></a><span class="hs-definition">neDouble</span>    <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">x</span> <span class="hs-varop">/=##</span> <span class="hs-varid">y</span>
<a name="line-55"></a><a name="ltDouble"></a><span class="hs-definition">ltDouble</span>    <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">x</span> <span class="hs-varop">&lt;##</span> <span class="hs-varid">y</span>
<a name="line-56"></a><a name="leDouble"></a><span class="hs-definition">leDouble</span>    <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">x</span> <span class="hs-varop">&lt;=##</span> <span class="hs-varid">y</span>
<a name="line-57"></a>
<a name="line-58"></a><a name="double2Float"></a><span class="hs-definition">double2Float</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Double</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Float</span>
<a name="line-59"></a><span class="hs-definition">double2Float</span> <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">double2Float</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="float2Double"></a><span class="hs-definition">float2Double</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Float</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Double</span>
<a name="line-62"></a><span class="hs-definition">float2Double</span> <span class="hs-layout">(</span><span class="hs-conid">F</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">float2Double</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="expDouble"></a><span class="hs-definition">expDouble</span><span class="hs-layout">,</span> <span class="hs-varid">logDouble</span><span class="hs-layout">,</span> <span class="hs-varid">sqrtDouble</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Double</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Double</span>
<a name="line-65"></a><a name="sinDouble"></a><span class="hs-definition">sinDouble</span><span class="hs-layout">,</span> <span class="hs-varid">cosDouble</span><span class="hs-layout">,</span> <span class="hs-varid">tanDouble</span>  <span class="hs-keyglyph">::</span> <span class="hs-conid">Double</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Double</span>
<a name="line-66"></a><a name="asinDouble"></a><span class="hs-definition">asinDouble</span><span class="hs-layout">,</span> <span class="hs-varid">acosDouble</span><span class="hs-layout">,</span> <span class="hs-varid">atanDouble</span>  <span class="hs-keyglyph">::</span> <span class="hs-conid">Double</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Double</span>
<a name="line-67"></a><a name="sinhDouble"></a><span class="hs-definition">sinhDouble</span><span class="hs-layout">,</span> <span class="hs-varid">coshDouble</span><span class="hs-layout">,</span> <span class="hs-varid">tanhDouble</span>  <span class="hs-keyglyph">::</span> <span class="hs-conid">Double</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Double</span>
<a name="line-68"></a><span class="hs-definition">expDouble</span>    <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">expDouble</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-69"></a><a name="logDouble"></a><span class="hs-definition">logDouble</span>    <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">logDouble</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-70"></a><a name="sqrtDouble"></a><span class="hs-definition">sqrtDouble</span>   <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">sqrtDouble</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-71"></a><span class="hs-definition">sinDouble</span>    <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">sinDouble</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-72"></a><a name="cosDouble"></a><span class="hs-definition">cosDouble</span>    <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">cosDouble</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-73"></a><a name="tanDouble"></a><span class="hs-definition">tanDouble</span>    <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">tanDouble</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-74"></a><span class="hs-definition">asinDouble</span>   <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">asinDouble</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-75"></a><a name="acosDouble"></a><span class="hs-definition">acosDouble</span>   <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">acosDouble</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-76"></a><a name="atanDouble"></a><span class="hs-definition">atanDouble</span>   <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">atanDouble</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-77"></a><span class="hs-definition">sinhDouble</span>   <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">sinhDouble</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-78"></a><a name="coshDouble"></a><span class="hs-definition">coshDouble</span>   <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">coshDouble</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-79"></a><a name="tanhDouble"></a><span class="hs-definition">tanhDouble</span>   <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">tanhDouble</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-80"></a>
<a name="line-81"></a><a name="powerDouble"></a><span class="hs-definition">powerDouble</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Double</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Double</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Double</span>
<a name="line-82"></a><span class="hs-definition">powerDouble</span>  <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">x</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-varid">y</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">D</span><span class="hs-cpp">#</span> <span class="hs-layout">(</span><span class="hs-varid">x</span> <span class="hs-varop">**##</span> <span class="hs-varid">y</span><span class="hs-layout">)</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><span class="hs-keyword">foreign</span> <span class="hs-keyword">import</span> <span class="hs-keyword">ccall</span> <span class="hs-keyword">unsafe</span> <span class="hs-str">&quot;isFloatNaN&quot;</span> <span class="hs-varid">isFloatNaN</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Float</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int</span>
<a name="line-2"></a><span class="hs-keyword">foreign</span> <span class="hs-keyword">import</span> <span class="hs-keyword">ccall</span> <span class="hs-keyword">unsafe</span> <span class="hs-str">&quot;isFloatInfinite&quot;</span> <span class="hs-varid">isFloatInfinite</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Float</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int</span>
<a name="line-3"></a><span class="hs-keyword">foreign</span> <span class="hs-keyword">import</span> <span class="hs-keyword">ccall</span> <span class="hs-keyword">unsafe</span> <span class="hs-str">&quot;isFloatDenormalized&quot;</span> <span class="hs-varid">isFloatDenormalized</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Float</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int</span>
<a name="line-4"></a><span class="hs-keyword">foreign</span> <span class="hs-keyword">import</span> <span class="hs-keyword">ccall</span> <span class="hs-keyword">unsafe</span> <span class="hs-str">&quot;isFloatNegativeZero&quot;</span> <span class="hs-varid">isFloatNegativeZero</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Float</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int</span>
<a name="line-5"></a><span class="hs-keyword">foreign</span> <span class="hs-keyword">import</span> <span class="hs-keyword">ccall</span> <span class="hs-keyword">unsafe</span> <span class="hs-str">&quot;isFloatFinite&quot;</span> <span class="hs-varid">isFloatFinite</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Float</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int</span>
<a name="line-6"></a>
<a name="line-7"></a><span class="hs-keyword">foreign</span> <span class="hs-keyword">import</span> <span class="hs-keyword">ccall</span> <span class="hs-keyword">unsafe</span> <span class="hs-str">&quot;isDoubleNaN&quot;</span> <span class="hs-varid">isDoubleNaN</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Double</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int</span>
<a name="line-8"></a><span class="hs-keyword">foreign</span> <span class="hs-keyword">import</span> <span class="hs-keyword">ccall</span> <span class="hs-keyword">unsafe</span> <span class="hs-str">&quot;isDoubleInfinite&quot;</span> <span class="hs-varid">isDoubleInfinite</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Double</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int</span>
<a name="line-9"></a><span class="hs-keyword">foreign</span> <span class="hs-keyword">import</span> <span class="hs-keyword">ccall</span> <span class="hs-keyword">unsafe</span> <span class="hs-str">&quot;isDoubleDenormalized&quot;</span> <span class="hs-varid">isDoubleDenormalized</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Double</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int</span>
<a name="line-10"></a><span class="hs-keyword">foreign</span> <span class="hs-keyword">import</span> <span class="hs-keyword">ccall</span> <span class="hs-keyword">unsafe</span> <span class="hs-str">&quot;isDoubleNegativeZero&quot;</span> <span class="hs-varid">isDoubleNegativeZero</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Double</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int</span>
<a name="line-11"></a><span class="hs-keyword">foreign</span> <span class="hs-keyword">import</span> <span class="hs-keyword">ccall</span> <span class="hs-keyword">unsafe</span> <span class="hs-str">&quot;isDoubleFinite&quot;</span> <span class="hs-varid">isDoubleFinite</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Double</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int</span>
</pre>\end{code}

%*********************************************************
%*                                                      *
\subsection{Coercion rules}
%*                                                      *
%*********************************************************

\begin{code}
<pre><a name="line-1"></a><span class="hs-comment">{-# RULES
<a name="line-2"></a>&quot;fromIntegral/Int-&gt;Float&quot;   fromIntegral = int2Float
<a name="line-3"></a>&quot;fromIntegral/Int-&gt;Double&quot;  fromIntegral = int2Double
<a name="line-4"></a>&quot;realToFrac/Float-&gt;Float&quot;   realToFrac   = id :: Float -&gt; Float
<a name="line-5"></a>&quot;realToFrac/Float-&gt;Double&quot;  realToFrac   = float2Double
<a name="line-6"></a>&quot;realToFrac/Double-&gt;Float&quot;  realToFrac   = double2Float
<a name="line-7"></a>&quot;realToFrac/Double-&gt;Double&quot; realToFrac   = id :: Double -&gt; Double
<a name="line-8"></a>&quot;realToFrac/Int-&gt;Double&quot;    realToFrac   = int2Double	-- See Note [realToFrac int-to-float]
<a name="line-9"></a>&quot;realToFrac/Int-&gt;Float&quot;     realToFrac   = int2Float	-- 	..ditto
<a name="line-10"></a>    #-}</span>
</pre>\end{code}

Note [realToFrac int-to-float]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Don found that the RULES for realToFrac/Int-&gt;Double and simliarly
Float made a huge difference to some stream-fusion programs.  Here's
an example

      import Data.Array.Vector

      n = 40000000

      main = do
            let c = replicateU n (2::Double)
                a = mapU realToFrac (enumFromToU 0 (n-1) ) :: UArr Double
            print (sumU (zipWithU (*) c a))

Without the RULE we get this loop body:

      case $wtoRational sc_sY4 of ww_aM7 { (# ww1_aM9, ww2_aMa #) -&gt;
      case $wfromRat ww1_aM9 ww2_aMa of tpl_X1P { D# ipv_sW3 -&gt;
      Main.$s$wfold
        (+# sc_sY4 1)
        (+# wild_X1i 1)
        (+## sc2_sY6 (*## 2.0 ipv_sW3))

And with the rule:

     Main.$s$wfold
        (+# sc_sXT 1)
        (+# wild_X1h 1)
        (+## sc2_sXV (*## 2.0 (int2Double# sc_sXT)))

The running time of the program goes from 120 seconds to 0.198 seconds
with the native backend, and 0.143 seconds with the C backend.

A few more details in Trac #2251, and the patch message
&quot;Add RULES for realToFrac from Int&quot;.

%*********************************************************
%*                                                      *
\subsection{Utils}
%*                                                      *
%*********************************************************

\begin{code}
<pre><a name="line-1"></a><a name="showSignedFloat"></a><span class="hs-definition">showSignedFloat</span> <span class="hs-keyglyph">::</span> <span class="hs-layout">(</span><span class="hs-conid">RealFloat</span> <span class="hs-varid">a</span><span class="hs-layout">)</span>
<a name="line-2"></a>  <span class="hs-keyglyph">=&gt;</span> <span class="hs-layout">(</span><span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">ShowS</span><span class="hs-layout">)</span>       <span class="hs-comment">-- ^ a function that can show unsigned values</span>
<a name="line-3"></a>  <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int</span>                <span class="hs-comment">-- ^ the precedence of the enclosing context</span>
<a name="line-4"></a>  <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span>                  <span class="hs-comment">-- ^ the value to show</span>
<a name="line-5"></a>  <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">ShowS</span>
<a name="line-6"></a><span class="hs-definition">showSignedFloat</span> <span class="hs-varid">showPos</span> <span class="hs-varid">p</span> <span class="hs-varid">x</span>
<a name="line-7"></a>   <span class="hs-keyglyph">|</span> <span class="hs-varid">x</span> <span class="hs-varop">&lt;</span> <span class="hs-num">0</span> <span class="hs-varop">||</span> <span class="hs-varid">isNegativeZero</span> <span class="hs-varid">x</span>
<a name="line-8"></a>       <span class="hs-keyglyph">=</span> <span class="hs-varid">showParen</span> <span class="hs-layout">(</span><span class="hs-varid">p</span> <span class="hs-varop">&gt;</span> <span class="hs-num">6</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-varid">showChar</span> <span class="hs-chr">'-'</span> <span class="hs-varop">.</span> <span class="hs-varid">showPos</span> <span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-varid">x</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-9"></a>   <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">showPos</span> <span class="hs-varid">x</span>
</pre>\end{code}

We need to prevent over/underflow of the exponent in encodeFloat when
called from scaleFloat, hence we clamp the scaling parameter.
We must have a large enough range to cover the maximum difference of
exponents returned by decodeFloat.
\begin{code}
<pre><a name="line-1"></a><a name="clamp"></a><span class="hs-definition">clamp</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Int</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int</span>
<a name="line-2"></a><span class="hs-definition">clamp</span> <span class="hs-varid">bd</span> <span class="hs-varid">k</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">max</span> <span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-varid">bd</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-varid">min</span> <span class="hs-varid">bd</span> <span class="hs-varid">k</span><span class="hs-layout">)</span>
</pre>\end{code}
</body>
</html>
