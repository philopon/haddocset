<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Event/Thread.hs</title>
<link type="text/css" rel="stylesheet" href="hscolour.css"></link>
</head>
<body>
<pre><a name="line-1"></a><span class="hs-comment">{-# LANGUAGE Trustworthy #-}</span>
<a name="line-2"></a><span class="hs-comment">{-# LANGUAGE BangPatterns, ForeignFunctionInterface, NoImplicitPrelude #-}</span>
<a name="line-3"></a>
<a name="line-4"></a><span class="hs-keyword">module</span> <span class="hs-conid">GHC</span><span class="hs-varop">.</span><span class="hs-conid">Event</span><span class="hs-varop">.</span><span class="hs-conid">Thread</span>
<a name="line-5"></a>    <span class="hs-layout">(</span> <span class="hs-varid">getSystemEventManager</span>
<a name="line-6"></a>    <span class="hs-layout">,</span> <span class="hs-varid">ensureIOManagerIsRunning</span>
<a name="line-7"></a>    <span class="hs-layout">,</span> <span class="hs-varid">threadWaitRead</span>
<a name="line-8"></a>    <span class="hs-layout">,</span> <span class="hs-varid">threadWaitWrite</span>
<a name="line-9"></a>    <span class="hs-layout">,</span> <span class="hs-varid">closeFdWith</span>
<a name="line-10"></a>    <span class="hs-layout">,</span> <span class="hs-varid">threadDelay</span>
<a name="line-11"></a>    <span class="hs-layout">,</span> <span class="hs-varid">registerDelay</span>
<a name="line-12"></a>    <span class="hs-layout">)</span> <span class="hs-keyword">where</span>
<a name="line-13"></a>
<a name="line-14"></a><span class="hs-keyword">import</span> <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">IORef</span> <span class="hs-layout">(</span><span class="hs-conid">IORef</span><span class="hs-layout">,</span> <span class="hs-varid">newIORef</span><span class="hs-layout">,</span> <span class="hs-varid">readIORef</span><span class="hs-layout">,</span> <span class="hs-varid">writeIORef</span><span class="hs-layout">)</span>
<a name="line-15"></a><span class="hs-keyword">import</span> <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">Maybe</span> <span class="hs-layout">(</span><span class="hs-conid">Maybe</span><span class="hs-layout">(</span><span class="hs-keyglyph">..</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-16"></a><span class="hs-keyword">import</span> <span class="hs-conid">Foreign</span><span class="hs-varop">.</span><span class="hs-conid">C</span><span class="hs-varop">.</span><span class="hs-conid">Error</span> <span class="hs-layout">(</span><span class="hs-varid">eBADF</span><span class="hs-layout">,</span> <span class="hs-varid">errnoToIOError</span><span class="hs-layout">)</span>
<a name="line-17"></a><span class="hs-keyword">import</span> <span class="hs-conid">Foreign</span><span class="hs-varop">.</span><span class="hs-conid">Ptr</span> <span class="hs-layout">(</span><span class="hs-conid">Ptr</span><span class="hs-layout">)</span>
<a name="line-18"></a><span class="hs-keyword">import</span> <span class="hs-conid">GHC</span><span class="hs-varop">.</span><span class="hs-conid">Base</span>
<a name="line-19"></a><span class="hs-keyword">import</span> <span class="hs-conid">GHC</span><span class="hs-varop">.</span><span class="hs-conid">Conc</span><span class="hs-varop">.</span><span class="hs-conid">Sync</span> <span class="hs-layout">(</span><span class="hs-conid">TVar</span><span class="hs-layout">,</span> <span class="hs-conid">ThreadId</span><span class="hs-layout">,</span> <span class="hs-conid">ThreadStatus</span><span class="hs-layout">(</span><span class="hs-keyglyph">..</span><span class="hs-layout">)</span><span class="hs-layout">,</span> <span class="hs-varid">atomically</span><span class="hs-layout">,</span> <span class="hs-varid">forkIO</span><span class="hs-layout">,</span>
<a name="line-20"></a>                      <span class="hs-varid">labelThread</span><span class="hs-layout">,</span> <span class="hs-varid">modifyMVar_</span><span class="hs-layout">,</span> <span class="hs-varid">newTVar</span><span class="hs-layout">,</span> <span class="hs-varid">sharedCAF</span><span class="hs-layout">,</span>
<a name="line-21"></a>                      <span class="hs-varid">threadStatus</span><span class="hs-layout">,</span> <span class="hs-varid">writeTVar</span><span class="hs-layout">)</span>
<a name="line-22"></a><span class="hs-keyword">import</span> <span class="hs-conid">GHC</span><span class="hs-varop">.</span><span class="hs-conid">IO</span> <span class="hs-layout">(</span><span class="hs-varid">mask_</span><span class="hs-layout">,</span> <span class="hs-varid">onException</span><span class="hs-layout">)</span>
<a name="line-23"></a><span class="hs-keyword">import</span> <span class="hs-conid">GHC</span><span class="hs-varop">.</span><span class="hs-conid">IO</span><span class="hs-varop">.</span><span class="hs-conid">Exception</span> <span class="hs-layout">(</span><span class="hs-varid">ioError</span><span class="hs-layout">)</span>
<a name="line-24"></a><span class="hs-keyword">import</span> <span class="hs-conid">GHC</span><span class="hs-varop">.</span><span class="hs-conid">MVar</span> <span class="hs-layout">(</span><span class="hs-conid">MVar</span><span class="hs-layout">,</span> <span class="hs-varid">newEmptyMVar</span><span class="hs-layout">,</span> <span class="hs-varid">newMVar</span><span class="hs-layout">,</span> <span class="hs-varid">putMVar</span><span class="hs-layout">,</span> <span class="hs-varid">takeMVar</span><span class="hs-layout">)</span>
<a name="line-25"></a><span class="hs-keyword">import</span> <span class="hs-conid">GHC</span><span class="hs-varop">.</span><span class="hs-conid">Event</span><span class="hs-varop">.</span><span class="hs-conid">Internal</span> <span class="hs-layout">(</span><span class="hs-varid">eventIs</span><span class="hs-layout">,</span> <span class="hs-varid">evtClose</span><span class="hs-layout">)</span>
<a name="line-26"></a><span class="hs-keyword">import</span> <span class="hs-conid">GHC</span><span class="hs-varop">.</span><span class="hs-conid">Event</span><span class="hs-varop">.</span><span class="hs-conid">Manager</span> <span class="hs-layout">(</span><span class="hs-conid">Event</span><span class="hs-layout">,</span> <span class="hs-conid">EventManager</span><span class="hs-layout">,</span> <span class="hs-varid">evtRead</span><span class="hs-layout">,</span> <span class="hs-varid">evtWrite</span><span class="hs-layout">,</span> <span class="hs-varid">loop</span><span class="hs-layout">,</span>
<a name="line-27"></a>                             <span class="hs-varid">new</span><span class="hs-layout">,</span> <span class="hs-varid">registerFd</span><span class="hs-layout">,</span> <span class="hs-varid">unregisterFd_</span><span class="hs-layout">,</span> <span class="hs-varid">registerTimeout</span><span class="hs-layout">)</span>
<a name="line-28"></a><span class="hs-keyword">import</span> <span class="hs-keyword">qualified</span> <span class="hs-conid">GHC</span><span class="hs-varop">.</span><span class="hs-conid">Event</span><span class="hs-varop">.</span><span class="hs-conid">Manager</span> <span class="hs-keyword">as</span> <span class="hs-conid">M</span>
<a name="line-29"></a><span class="hs-keyword">import</span> <span class="hs-conid">System</span><span class="hs-varop">.</span><span class="hs-conid">IO</span><span class="hs-varop">.</span><span class="hs-conid">Unsafe</span> <span class="hs-layout">(</span><span class="hs-varid">unsafePerformIO</span><span class="hs-layout">)</span>
<a name="line-30"></a><span class="hs-keyword">import</span> <span class="hs-conid">System</span><span class="hs-varop">.</span><span class="hs-conid">Posix</span><span class="hs-varop">.</span><span class="hs-conid">Types</span> <span class="hs-layout">(</span><span class="hs-conid">Fd</span><span class="hs-layout">)</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="threadDelay"></a><span class="hs-comment">-- | Suspends the current thread for a given number of microseconds</span>
<a name="line-33"></a><span class="hs-comment">-- (GHC only).</span>
<a name="line-34"></a><span class="hs-comment">--</span>
<a name="line-35"></a><span class="hs-comment">-- There is no guarantee that the thread will be rescheduled promptly</span>
<a name="line-36"></a><span class="hs-comment">-- when the delay has expired, but the thread will never continue to</span>
<a name="line-37"></a><span class="hs-comment">-- run /earlier/ than specified.</span>
<a name="line-38"></a><span class="hs-definition">threadDelay</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Int</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-conid">()</span>
<a name="line-39"></a><span class="hs-definition">threadDelay</span> <span class="hs-varid">usecs</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">mask_</span> <span class="hs-varop">$</span> <span class="hs-keyword">do</span>
<a name="line-40"></a>  <span class="hs-conid">Just</span> <span class="hs-varid">mgr</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">getSystemEventManager</span>
<a name="line-41"></a>  <span class="hs-varid">m</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">newEmptyMVar</span>
<a name="line-42"></a>  <span class="hs-varid">reg</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">registerTimeout</span> <span class="hs-varid">mgr</span> <span class="hs-varid">usecs</span> <span class="hs-layout">(</span><span class="hs-varid">putMVar</span> <span class="hs-varid">m</span> <span class="hs-conid">()</span><span class="hs-layout">)</span>
<a name="line-43"></a>  <span class="hs-varid">takeMVar</span> <span class="hs-varid">m</span> <span class="hs-varop">`onException`</span> <span class="hs-conid">M</span><span class="hs-varop">.</span><span class="hs-varid">unregisterTimeout</span> <span class="hs-varid">mgr</span> <span class="hs-varid">reg</span>
<a name="line-44"></a>
<a name="line-45"></a><a name="registerDelay"></a><span class="hs-comment">-- | Set the value of returned TVar to True after a given number of</span>
<a name="line-46"></a><span class="hs-comment">-- microseconds. The caveats associated with threadDelay also apply.</span>
<a name="line-47"></a><span class="hs-comment">--</span>
<a name="line-48"></a><span class="hs-definition">registerDelay</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Int</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-layout">(</span><span class="hs-conid">TVar</span> <span class="hs-conid">Bool</span><span class="hs-layout">)</span>
<a name="line-49"></a><span class="hs-definition">registerDelay</span> <span class="hs-varid">usecs</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span>
<a name="line-50"></a>  <span class="hs-varid">t</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">atomically</span> <span class="hs-varop">$</span> <span class="hs-varid">newTVar</span> <span class="hs-conid">False</span>
<a name="line-51"></a>  <span class="hs-conid">Just</span> <span class="hs-varid">mgr</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">getSystemEventManager</span>
<a name="line-52"></a>  <span class="hs-keyword">_</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">registerTimeout</span> <span class="hs-varid">mgr</span> <span class="hs-varid">usecs</span> <span class="hs-varop">.</span> <span class="hs-varid">atomically</span> <span class="hs-varop">$</span> <span class="hs-varid">writeTVar</span> <span class="hs-varid">t</span> <span class="hs-conid">True</span>
<a name="line-53"></a>  <span class="hs-varid">return</span> <span class="hs-varid">t</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="threadWaitRead"></a><span class="hs-comment">-- | Block the current thread until data is available to read from the</span>
<a name="line-56"></a><span class="hs-comment">-- given file descriptor.</span>
<a name="line-57"></a><span class="hs-comment">--</span>
<a name="line-58"></a><span class="hs-comment">-- This will throw an 'IOError' if the file descriptor was closed</span>
<a name="line-59"></a><span class="hs-comment">-- while this thread was blocked.  To safely close a file descriptor</span>
<a name="line-60"></a><span class="hs-comment">-- that has been used with 'threadWaitRead', use 'closeFdWith'.</span>
<a name="line-61"></a><span class="hs-definition">threadWaitRead</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Fd</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-conid">()</span>
<a name="line-62"></a><span class="hs-definition">threadWaitRead</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">threadWait</span> <span class="hs-varid">evtRead</span>
<a name="line-63"></a><span class="hs-comment">{-# INLINE threadWaitRead #-}</span>
<a name="line-64"></a>
<a name="line-65"></a><a name="threadWaitWrite"></a><span class="hs-comment">-- | Block the current thread until the given file descriptor can</span>
<a name="line-66"></a><span class="hs-comment">-- accept data to write.</span>
<a name="line-67"></a><span class="hs-comment">--</span>
<a name="line-68"></a><span class="hs-comment">-- This will throw an 'IOError' if the file descriptor was closed</span>
<a name="line-69"></a><span class="hs-comment">-- while this thread was blocked.  To safely close a file descriptor</span>
<a name="line-70"></a><span class="hs-comment">-- that has been used with 'threadWaitWrite', use 'closeFdWith'.</span>
<a name="line-71"></a><span class="hs-definition">threadWaitWrite</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Fd</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-conid">()</span>
<a name="line-72"></a><span class="hs-definition">threadWaitWrite</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">threadWait</span> <span class="hs-varid">evtWrite</span>
<a name="line-73"></a><span class="hs-comment">{-# INLINE threadWaitWrite #-}</span>
<a name="line-74"></a>
<a name="line-75"></a><a name="closeFdWith"></a><span class="hs-comment">-- | Close a file descriptor in a concurrency-safe way.</span>
<a name="line-76"></a><span class="hs-comment">--</span>
<a name="line-77"></a><span class="hs-comment">-- Any threads that are blocked on the file descriptor via</span>
<a name="line-78"></a><span class="hs-comment">-- 'threadWaitRead' or 'threadWaitWrite' will be unblocked by having</span>
<a name="line-79"></a><span class="hs-comment">-- IO exceptions thrown.</span>
<a name="line-80"></a><span class="hs-definition">closeFdWith</span> <span class="hs-keyglyph">::</span> <span class="hs-layout">(</span><span class="hs-conid">Fd</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-conid">()</span><span class="hs-layout">)</span>        <span class="hs-comment">-- ^ Action that performs the close.</span>
<a name="line-81"></a>            <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Fd</span>                   <span class="hs-comment">-- ^ File descriptor to close.</span>
<a name="line-82"></a>            <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-conid">()</span>
<a name="line-83"></a><span class="hs-definition">closeFdWith</span> <span class="hs-varid">close</span> <span class="hs-varid">fd</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span>
<a name="line-84"></a>  <span class="hs-conid">Just</span> <span class="hs-varid">mgr</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">getSystemEventManager</span>
<a name="line-85"></a>  <span class="hs-conid">M</span><span class="hs-varop">.</span><span class="hs-varid">closeFd</span> <span class="hs-varid">mgr</span> <span class="hs-varid">close</span> <span class="hs-varid">fd</span>
<a name="line-86"></a>
<a name="line-87"></a><a name="threadWait"></a><span class="hs-definition">threadWait</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Event</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Fd</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-conid">()</span>
<a name="line-88"></a><span class="hs-definition">threadWait</span> <span class="hs-varid">evt</span> <span class="hs-varid">fd</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">mask_</span> <span class="hs-varop">$</span> <span class="hs-keyword">do</span>
<a name="line-89"></a>  <span class="hs-varid">m</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">newEmptyMVar</span>
<a name="line-90"></a>  <span class="hs-conid">Just</span> <span class="hs-varid">mgr</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">getSystemEventManager</span>
<a name="line-91"></a>  <span class="hs-varid">reg</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">registerFd</span> <span class="hs-varid">mgr</span> <span class="hs-layout">(</span><span class="hs-keyglyph">\</span><span class="hs-varid">reg</span> <span class="hs-varid">e</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">unregisterFd_</span> <span class="hs-varid">mgr</span> <span class="hs-varid">reg</span> <span class="hs-varop">&gt;&gt;</span> <span class="hs-varid">putMVar</span> <span class="hs-varid">m</span> <span class="hs-varid">e</span><span class="hs-layout">)</span> <span class="hs-varid">fd</span> <span class="hs-varid">evt</span>
<a name="line-92"></a>  <span class="hs-varid">evt'</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">takeMVar</span> <span class="hs-varid">m</span> <span class="hs-varop">`onException`</span> <span class="hs-varid">unregisterFd_</span> <span class="hs-varid">mgr</span> <span class="hs-varid">reg</span>
<a name="line-93"></a>  <span class="hs-keyword">if</span> <span class="hs-varid">evt'</span> <span class="hs-varop">`eventIs`</span> <span class="hs-varid">evtClose</span>
<a name="line-94"></a>    <span class="hs-keyword">then</span> <span class="hs-varid">ioError</span> <span class="hs-varop">$</span> <span class="hs-varid">errnoToIOError</span> <span class="hs-str">&quot;threadWait&quot;</span> <span class="hs-varid">eBADF</span> <span class="hs-conid">Nothing</span> <span class="hs-conid">Nothing</span>
<a name="line-95"></a>    <span class="hs-keyword">else</span> <span class="hs-varid">return</span> <span class="hs-conid">()</span>
<a name="line-96"></a>
<a name="line-97"></a><a name="getSystemEventManager"></a><span class="hs-comment">-- | Retrieve the system event manager.</span>
<a name="line-98"></a><span class="hs-comment">--</span>
<a name="line-99"></a><span class="hs-comment">-- This function always returns 'Just' the system event manager when using the</span>
<a name="line-100"></a><span class="hs-comment">-- threaded RTS and 'Nothing' otherwise.</span>
<a name="line-101"></a><span class="hs-definition">getSystemEventManager</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">IO</span> <span class="hs-layout">(</span><span class="hs-conid">Maybe</span> <span class="hs-conid">EventManager</span><span class="hs-layout">)</span>
<a name="line-102"></a><span class="hs-definition">getSystemEventManager</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">readIORef</span> <span class="hs-varid">eventManager</span>
<a name="line-103"></a>
<a name="line-104"></a><span class="hs-keyword">foreign</span> <span class="hs-keyword">import</span> <span class="hs-keyword">ccall</span> <span class="hs-keyword">unsafe</span> <span class="hs-str">&quot;getOrSetSystemEventThreadEventManagerStore&quot;</span>
<a name="line-105"></a>    <span class="hs-varid">getOrSetSystemEventThreadEventManagerStore</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Ptr</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-layout">(</span><span class="hs-conid">Ptr</span> <span class="hs-varid">a</span><span class="hs-layout">)</span>
<a name="line-106"></a>
<a name="line-107"></a><a name="eventManager"></a><span class="hs-definition">eventManager</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">IORef</span> <span class="hs-layout">(</span><span class="hs-conid">Maybe</span> <span class="hs-conid">EventManager</span><span class="hs-layout">)</span>
<a name="line-108"></a><span class="hs-definition">eventManager</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">unsafePerformIO</span> <span class="hs-varop">$</span> <span class="hs-keyword">do</span>
<a name="line-109"></a>    <span class="hs-varid">em</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">newIORef</span> <span class="hs-conid">Nothing</span>
<a name="line-110"></a>    <span class="hs-varid">sharedCAF</span> <span class="hs-varid">em</span> <span class="hs-varid">getOrSetSystemEventThreadEventManagerStore</span>
<a name="line-111"></a><span class="hs-comment">{-# NOINLINE eventManager #-}</span>
<a name="line-112"></a>
<a name="line-113"></a><span class="hs-keyword">foreign</span> <span class="hs-keyword">import</span> <span class="hs-keyword">ccall</span> <span class="hs-keyword">unsafe</span> <span class="hs-str">&quot;getOrSetSystemEventThreadIOManagerThreadStore&quot;</span>
<a name="line-114"></a>    <span class="hs-varid">getOrSetSystemEventThreadIOManagerThreadStore</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Ptr</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-layout">(</span><span class="hs-conid">Ptr</span> <span class="hs-varid">a</span><span class="hs-layout">)</span>
<a name="line-115"></a>
<a name="line-116"></a><a name="ioManager"></a><span class="hs-comment">{-# NOINLINE ioManager #-}</span>
<a name="line-117"></a><span class="hs-definition">ioManager</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">MVar</span> <span class="hs-layout">(</span><span class="hs-conid">Maybe</span> <span class="hs-conid">ThreadId</span><span class="hs-layout">)</span>
<a name="line-118"></a><span class="hs-definition">ioManager</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">unsafePerformIO</span> <span class="hs-varop">$</span> <span class="hs-keyword">do</span>
<a name="line-119"></a>   <span class="hs-varid">m</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">newMVar</span> <span class="hs-conid">Nothing</span>
<a name="line-120"></a>   <span class="hs-varid">sharedCAF</span> <span class="hs-varid">m</span> <span class="hs-varid">getOrSetSystemEventThreadIOManagerThreadStore</span>
<a name="line-121"></a>
<a name="line-122"></a><a name="ensureIOManagerIsRunning"></a><span class="hs-definition">ensureIOManagerIsRunning</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">IO</span> <span class="hs-conid">()</span>
<a name="line-123"></a><span class="hs-definition">ensureIOManagerIsRunning</span>
<a name="line-124"></a>  <span class="hs-keyglyph">|</span> <span class="hs-varid">not</span> <span class="hs-varid">threaded</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">return</span> <span class="hs-conid">()</span>
<a name="line-125"></a>  <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span>
<a name="line-126"></a>      <span class="hs-varid">startIOManagerThread</span>
<a name="line-127"></a>
<a name="line-128"></a><a name="startIOManagerThread"></a><span class="hs-definition">startIOManagerThread</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">IO</span> <span class="hs-conid">()</span>
<a name="line-129"></a><span class="hs-definition">startIOManagerThread</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">modifyMVar_</span> <span class="hs-varid">ioManager</span> <span class="hs-varop">$</span> <span class="hs-keyglyph">\</span><span class="hs-varid">old</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyword">do</span>
<a name="line-130"></a>  <span class="hs-keyword">let</span> <span class="hs-varid">create</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span>
<a name="line-131"></a>        <span class="hs-varop">!</span><span class="hs-varid">mgr</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">new</span>
<a name="line-132"></a>        <span class="hs-varid">writeIORef</span> <span class="hs-varid">eventManager</span> <span class="hs-varop">$</span> <span class="hs-conid">Just</span> <span class="hs-varid">mgr</span>
<a name="line-133"></a>        <span class="hs-varop">!</span><span class="hs-varid">t</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">forkIO</span> <span class="hs-varop">$</span> <span class="hs-varid">loop</span> <span class="hs-varid">mgr</span>
<a name="line-134"></a>        <span class="hs-varid">labelThread</span> <span class="hs-varid">t</span> <span class="hs-str">&quot;IOManager&quot;</span>
<a name="line-135"></a>        <span class="hs-varid">return</span> <span class="hs-varop">$</span> <span class="hs-conid">Just</span> <span class="hs-varid">t</span>
<a name="line-136"></a>  <span class="hs-keyword">case</span> <span class="hs-varid">old</span> <span class="hs-keyword">of</span>
<a name="line-137"></a>    <span class="hs-conid">Nothing</span>            <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">create</span>
<a name="line-138"></a>    <span class="hs-varid">st</span><span class="hs-keyglyph">@</span><span class="hs-layout">(</span><span class="hs-conid">Just</span> <span class="hs-varid">t</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyword">do</span>
<a name="line-139"></a>      <span class="hs-varid">s</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">threadStatus</span> <span class="hs-varid">t</span>
<a name="line-140"></a>      <span class="hs-keyword">case</span> <span class="hs-varid">s</span> <span class="hs-keyword">of</span>
<a name="line-141"></a>        <span class="hs-conid">ThreadFinished</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">create</span>
<a name="line-142"></a>        <span class="hs-conid">ThreadDied</span>     <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyword">do</span> 
<a name="line-143"></a>          <span class="hs-comment">-- Sanity check: if the thread has died, there is a chance</span>
<a name="line-144"></a>          <span class="hs-comment">-- that event manager is still alive. This could happend during</span>
<a name="line-145"></a>          <span class="hs-comment">-- the fork, for example. In this case we should clean up</span>
<a name="line-146"></a>          <span class="hs-comment">-- open pipes and everything else related to the event manager.</span>
<a name="line-147"></a>          <span class="hs-comment">-- See #4449</span>
<a name="line-148"></a>          <span class="hs-varid">mem</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">readIORef</span> <span class="hs-varid">eventManager</span>
<a name="line-149"></a>          <span class="hs-keyword">_</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-keyword">case</span> <span class="hs-varid">mem</span> <span class="hs-keyword">of</span>
<a name="line-150"></a>                 <span class="hs-conid">Nothing</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">return</span> <span class="hs-conid">()</span>
<a name="line-151"></a>                 <span class="hs-conid">Just</span> <span class="hs-varid">em</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">M</span><span class="hs-varop">.</span><span class="hs-varid">cleanup</span> <span class="hs-varid">em</span>
<a name="line-152"></a>          <span class="hs-varid">create</span>
<a name="line-153"></a>        <span class="hs-sel">_other</span>         <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">return</span> <span class="hs-varid">st</span>
<a name="line-154"></a>
<a name="line-155"></a><span class="hs-keyword">foreign</span> <span class="hs-keyword">import</span> <span class="hs-keyword">ccall</span> <span class="hs-keyword">unsafe</span> <span class="hs-str">&quot;rtsSupportsBoundThreads&quot;</span> <span class="hs-varid">threaded</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Bool</span>
</pre></body>
</html>
