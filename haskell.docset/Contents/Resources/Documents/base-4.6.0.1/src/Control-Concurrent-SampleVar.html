<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Control/Concurrent/SampleVar.hs</title>
<link type="text/css" rel="stylesheet" href="hscolour.css"></link>
</head>
<body>
<pre><a name="line-1"></a><span class="hs-comment">{-# LANGUAGE Trustworthy #-}</span>
<a name="line-2"></a><span class="hs-comment">{-# LANGUAGE CPP #-}</span>
<a name="line-3"></a><span class="hs-cpp">#ifdef __GLASGOW_HASKELL__</span>
<a name="line-4"></a><span class="hs-comment">{-# LANGUAGE DeriveDataTypeable, StandaloneDeriving #-}</span>
<a name="line-5"></a><span class="hs-cpp">#endif</span>
<a name="line-6"></a>
<a name="line-7"></a><span class="hs-comment">-----------------------------------------------------------------------------</span>
<a name="line-8"></a><span class="hs-comment">-- |</span>
<a name="line-9"></a><span class="hs-comment">-- Module      :  Control.Concurrent.SampleVar</span>
<a name="line-10"></a><span class="hs-comment">-- Copyright   :  (c) The University of Glasgow 2001</span>
<a name="line-11"></a><span class="hs-comment">-- License     :  BSD-style (see the file libraries/base/LICENSE)</span>
<a name="line-12"></a><span class="hs-comment">-- </span>
<a name="line-13"></a><span class="hs-comment">-- Maintainer  :  libraries@haskell.org</span>
<a name="line-14"></a><span class="hs-comment">-- Stability   :  experimental</span>
<a name="line-15"></a><span class="hs-comment">-- Portability :  non-portable (concurrency)</span>
<a name="line-16"></a><span class="hs-comment">--</span>
<a name="line-17"></a><span class="hs-comment">-- Sample variables</span>
<a name="line-18"></a><span class="hs-comment">--</span>
<a name="line-19"></a><span class="hs-comment">-----------------------------------------------------------------------------</span>
<a name="line-20"></a>
<a name="line-21"></a><span class="hs-keyword">module</span> <span class="hs-conid">Control</span><span class="hs-varop">.</span><span class="hs-conid">Concurrent</span><span class="hs-varop">.</span><span class="hs-conid">SampleVar</span>
<a name="line-22"></a>        <span class="hs-comment">{-# DEPRECATED &quot;Control.Concurrent.SampleVar will be removed in GHC 7.8. Please use an alternative, e.g. the SafeSemaphore package, instead.&quot; #-}</span>
<a name="line-23"></a>       <span class="hs-layout">(</span>
<a name="line-24"></a>         <span class="hs-comment">-- * Sample Variables</span>
<a name="line-25"></a>         <span class="hs-conid">SampleVar</span><span class="hs-layout">,</span>         <span class="hs-comment">-- :: type _ =</span>
<a name="line-26"></a> 
<a name="line-27"></a>         <span class="hs-varid">newEmptySampleVar</span><span class="hs-layout">,</span> <span class="hs-comment">-- :: IO (SampleVar a)</span>
<a name="line-28"></a>         <span class="hs-varid">newSampleVar</span><span class="hs-layout">,</span>      <span class="hs-comment">-- :: a -&gt; IO (SampleVar a)</span>
<a name="line-29"></a>         <span class="hs-varid">emptySampleVar</span><span class="hs-layout">,</span>    <span class="hs-comment">-- :: SampleVar a -&gt; IO ()</span>
<a name="line-30"></a>         <span class="hs-varid">readSampleVar</span><span class="hs-layout">,</span>     <span class="hs-comment">-- :: SampleVar a -&gt; IO a</span>
<a name="line-31"></a>         <span class="hs-varid">writeSampleVar</span><span class="hs-layout">,</span>    <span class="hs-comment">-- :: SampleVar a -&gt; a -&gt; IO ()</span>
<a name="line-32"></a>         <span class="hs-varid">isEmptySampleVar</span><span class="hs-layout">,</span>  <span class="hs-comment">-- :: SampleVar a -&gt; IO Bool</span>
<a name="line-33"></a>
<a name="line-34"></a>       <span class="hs-layout">)</span> <span class="hs-keyword">where</span>
<a name="line-35"></a>
<a name="line-36"></a><span class="hs-keyword">import</span> <span class="hs-conid">Prelude</span>
<a name="line-37"></a>
<a name="line-38"></a><span class="hs-keyword">import</span> <span class="hs-conid">Control</span><span class="hs-varop">.</span><span class="hs-conid">Concurrent</span><span class="hs-varop">.</span><span class="hs-conid">MVar</span>
<a name="line-39"></a>
<a name="line-40"></a><span class="hs-keyword">import</span> <span class="hs-conid">Control</span><span class="hs-varop">.</span><span class="hs-conid">Exception</span> <span class="hs-layout">(</span> <span class="hs-varid">mask_</span> <span class="hs-layout">)</span>
<a name="line-41"></a>
<a name="line-42"></a><span class="hs-keyword">import</span> <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">Functor</span> <span class="hs-layout">(</span> <span class="hs-layout">(</span><span class="hs-varop">&lt;$&gt;</span><span class="hs-layout">)</span> <span class="hs-layout">)</span>
<a name="line-43"></a>
<a name="line-44"></a><span class="hs-keyword">import</span> <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">Typeable</span>
<a name="line-45"></a>
<a name="line-46"></a><span class="hs-cpp">#include &quot;Typeable.h&quot;</span>
<a name="line-47"></a>
<a name="line-48"></a><span class="hs-comment">-- |</span>
<a name="line-49"></a><span class="hs-comment">-- Sample variables are slightly different from a normal 'MVar':</span>
<a name="line-50"></a><span class="hs-comment">-- </span>
<a name="line-51"></a><span class="hs-comment">--  * Reading an empty 'SampleVar' causes the reader to block.</span>
<a name="line-52"></a><span class="hs-comment">--    (same as 'takeMVar' on empty 'MVar')</span>
<a name="line-53"></a><span class="hs-comment">-- </span>
<a name="line-54"></a><span class="hs-comment">--  * Reading a filled 'SampleVar' empties it and returns value.</span>
<a name="line-55"></a><span class="hs-comment">--    (same as 'takeMVar')</span>
<a name="line-56"></a><span class="hs-comment">-- </span>
<a name="line-57"></a><span class="hs-comment">--  * Writing to an empty 'SampleVar' fills it with a value, and</span>
<a name="line-58"></a><span class="hs-comment">--    potentially, wakes up a blocked reader (same as for 'putMVar' on</span>
<a name="line-59"></a><span class="hs-comment">--    empty 'MVar').</span>
<a name="line-60"></a><span class="hs-comment">--</span>
<a name="line-61"></a><span class="hs-comment">--  * Writing to a filled 'SampleVar' overwrites the current value.</span>
<a name="line-62"></a><span class="hs-comment">--    (different from 'putMVar' on full 'MVar'.)</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="SampleVar"></a><span class="hs-keyword">newtype</span> <span class="hs-conid">SampleVar</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">SampleVar</span> <span class="hs-layout">(</span> <span class="hs-conid">MVar</span> <span class="hs-layout">(</span> <span class="hs-conid">Int</span>    <span class="hs-comment">-- 1  == full</span>
<a name="line-65"></a>                                                <span class="hs-comment">-- 0  == empty</span>
<a name="line-66"></a>                                                <span class="hs-comment">-- &lt;0 no of readers blocked</span>
<a name="line-67"></a>                                       <span class="hs-layout">,</span> <span class="hs-conid">MVar</span> <span class="hs-varid">a</span>
<a name="line-68"></a>                                       <span class="hs-layout">)</span>
<a name="line-69"></a>                                <span class="hs-layout">)</span>
<a name="line-70"></a>    <span class="hs-keyword">deriving</span> <span class="hs-layout">(</span><span class="hs-conid">Eq</span><span class="hs-layout">)</span>
<a name="line-71"></a>
<a name="line-72"></a><span class="hs-conid">INSTANCE_TYPEABLE1</span><span class="hs-layout">(</span><span class="hs-conid">SampleVar</span><span class="hs-layout">,</span><span class="hs-varid">sampleVarTc</span><span class="hs-layout">,</span><span class="hs-str">&quot;SampleVar&quot;</span><span class="hs-layout">)</span>
<a name="line-73"></a>
<a name="line-74"></a><a name="newEmptySampleVar"></a><span class="hs-comment">-- |Build a new, empty, 'SampleVar'</span>
<a name="line-75"></a><span class="hs-definition">newEmptySampleVar</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">IO</span> <span class="hs-layout">(</span><span class="hs-conid">SampleVar</span> <span class="hs-varid">a</span><span class="hs-layout">)</span>
<a name="line-76"></a><span class="hs-definition">newEmptySampleVar</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span>
<a name="line-77"></a>   <span class="hs-varid">v</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">newEmptyMVar</span>
<a name="line-78"></a>   <span class="hs-conid">SampleVar</span> <span class="hs-varop">&lt;$&gt;</span> <span class="hs-varid">newMVar</span> <span class="hs-layout">(</span><span class="hs-num">0</span><span class="hs-layout">,</span><span class="hs-varid">v</span><span class="hs-layout">)</span>
<a name="line-79"></a>
<a name="line-80"></a><a name="newSampleVar"></a><span class="hs-comment">-- |Build a 'SampleVar' with an initial value.</span>
<a name="line-81"></a><span class="hs-definition">newSampleVar</span> <span class="hs-keyglyph">::</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-layout">(</span><span class="hs-conid">SampleVar</span> <span class="hs-varid">a</span><span class="hs-layout">)</span>
<a name="line-82"></a><span class="hs-definition">newSampleVar</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span>
<a name="line-83"></a>   <span class="hs-varid">v</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">newMVar</span> <span class="hs-varid">a</span>
<a name="line-84"></a>   <span class="hs-conid">SampleVar</span> <span class="hs-varop">&lt;$&gt;</span> <span class="hs-varid">newMVar</span> <span class="hs-layout">(</span><span class="hs-num">1</span><span class="hs-layout">,</span><span class="hs-varid">v</span><span class="hs-layout">)</span>
<a name="line-85"></a>
<a name="line-86"></a><a name="emptySampleVar"></a><span class="hs-comment">-- |If the SampleVar is full, leave it empty.  Otherwise, do nothing.</span>
<a name="line-87"></a><span class="hs-definition">emptySampleVar</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">SampleVar</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-conid">()</span>
<a name="line-88"></a><span class="hs-definition">emptySampleVar</span> <span class="hs-layout">(</span><span class="hs-conid">SampleVar</span> <span class="hs-varid">v</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">mask_</span> <span class="hs-varop">$</span> <span class="hs-keyword">do</span>
<a name="line-89"></a>   <span class="hs-varid">s</span><span class="hs-keyglyph">@</span><span class="hs-layout">(</span><span class="hs-varid">readers</span><span class="hs-layout">,</span> <span class="hs-varid">var</span><span class="hs-layout">)</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">takeMVar</span> <span class="hs-varid">v</span>
<a name="line-90"></a>   <span class="hs-keyword">if</span> <span class="hs-varid">readers</span> <span class="hs-varop">&gt;</span> <span class="hs-num">0</span> <span class="hs-keyword">then</span> <span class="hs-keyword">do</span>
<a name="line-91"></a>     <span class="hs-keyword">_</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">takeMVar</span> <span class="hs-varid">var</span>
<a name="line-92"></a>     <span class="hs-varid">putMVar</span> <span class="hs-varid">v</span> <span class="hs-layout">(</span><span class="hs-num">0</span><span class="hs-layout">,</span><span class="hs-varid">var</span><span class="hs-layout">)</span>
<a name="line-93"></a>    <span class="hs-keyword">else</span>
<a name="line-94"></a>     <span class="hs-varid">putMVar</span> <span class="hs-varid">v</span> <span class="hs-varid">s</span>
<a name="line-95"></a>
<a name="line-96"></a><a name="readSampleVar"></a><span class="hs-comment">-- |Wait for a value to become available, then take it and return.</span>
<a name="line-97"></a><span class="hs-definition">readSampleVar</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">SampleVar</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-varid">a</span>
<a name="line-98"></a><span class="hs-definition">readSampleVar</span> <span class="hs-layout">(</span><span class="hs-conid">SampleVar</span> <span class="hs-varid">svar</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">mask_</span> <span class="hs-varop">$</span> <span class="hs-keyword">do</span>
<a name="line-99"></a><span class="hs-comment">--</span>
<a name="line-100"></a><span class="hs-comment">-- filled =&gt; make empty and grab sample</span>
<a name="line-101"></a><span class="hs-comment">-- not filled =&gt; try to grab value, empty when read val.</span>
<a name="line-102"></a><span class="hs-comment">--</span>
<a name="line-103"></a>   <span class="hs-layout">(</span><span class="hs-varid">readers</span><span class="hs-layout">,</span><span class="hs-varid">val</span><span class="hs-layout">)</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">takeMVar</span> <span class="hs-varid">svar</span>
<a name="line-104"></a>   <span class="hs-keyword">let</span> <span class="hs-varid">readers'</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">readers</span><span class="hs-comment">-</span><span class="hs-num">1</span>
<a name="line-105"></a>   <span class="hs-varid">readers'</span> <span class="hs-varop">`seq`</span> <span class="hs-varid">putMVar</span> <span class="hs-varid">svar</span> <span class="hs-layout">(</span><span class="hs-varid">readers'</span><span class="hs-layout">,</span><span class="hs-varid">val</span><span class="hs-layout">)</span>
<a name="line-106"></a>   <span class="hs-varid">takeMVar</span> <span class="hs-varid">val</span>
<a name="line-107"></a>
<a name="line-108"></a><a name="writeSampleVar"></a><span class="hs-comment">-- |Write a value into the 'SampleVar', overwriting any previous value that</span>
<a name="line-109"></a><span class="hs-comment">-- was there.</span>
<a name="line-110"></a><span class="hs-definition">writeSampleVar</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">SampleVar</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-conid">()</span>
<a name="line-111"></a><span class="hs-definition">writeSampleVar</span> <span class="hs-layout">(</span><span class="hs-conid">SampleVar</span> <span class="hs-varid">svar</span><span class="hs-layout">)</span> <span class="hs-varid">v</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">mask_</span> <span class="hs-varop">$</span> <span class="hs-keyword">do</span>
<a name="line-112"></a><span class="hs-comment">--</span>
<a name="line-113"></a><span class="hs-comment">-- filled =&gt; overwrite</span>
<a name="line-114"></a><span class="hs-comment">-- not filled =&gt; fill, write val</span>
<a name="line-115"></a><span class="hs-comment">--</span>
<a name="line-116"></a>   <span class="hs-varid">s</span><span class="hs-keyglyph">@</span><span class="hs-layout">(</span><span class="hs-varid">readers</span><span class="hs-layout">,</span><span class="hs-varid">val</span><span class="hs-layout">)</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">takeMVar</span> <span class="hs-varid">svar</span>
<a name="line-117"></a>   <span class="hs-keyword">case</span> <span class="hs-varid">readers</span> <span class="hs-keyword">of</span>
<a name="line-118"></a>     <span class="hs-num">1</span> <span class="hs-keyglyph">-&gt;</span>
<a name="line-119"></a>       <span class="hs-varid">swapMVar</span> <span class="hs-varid">val</span> <span class="hs-varid">v</span> <span class="hs-varop">&gt;&gt;</span>
<a name="line-120"></a>       <span class="hs-varid">putMVar</span> <span class="hs-varid">svar</span> <span class="hs-varid">s</span>
<a name="line-121"></a>     <span class="hs-keyword">_</span> <span class="hs-keyglyph">-&gt;</span>
<a name="line-122"></a>       <span class="hs-varid">putMVar</span> <span class="hs-varid">val</span> <span class="hs-varid">v</span> <span class="hs-varop">&gt;&gt;</span>
<a name="line-123"></a>       <span class="hs-keyword">let</span> <span class="hs-varid">readers'</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">min</span> <span class="hs-num">1</span> <span class="hs-layout">(</span><span class="hs-varid">readers</span><span class="hs-varop">+</span><span class="hs-num">1</span><span class="hs-layout">)</span>
<a name="line-124"></a>       <span class="hs-keyword">in</span> <span class="hs-varid">readers'</span> <span class="hs-varop">`seq`</span> <span class="hs-varid">putMVar</span> <span class="hs-varid">svar</span> <span class="hs-layout">(</span><span class="hs-varid">readers'</span><span class="hs-layout">,</span> <span class="hs-varid">val</span><span class="hs-layout">)</span>
<a name="line-125"></a>
<a name="line-126"></a><a name="isEmptySampleVar"></a><span class="hs-comment">-- | Returns 'True' if the 'SampleVar' is currently empty.</span>
<a name="line-127"></a><span class="hs-comment">--</span>
<a name="line-128"></a><span class="hs-comment">-- Note that this function is only useful if you know that no other</span>
<a name="line-129"></a><span class="hs-comment">-- threads can be modifying the state of the 'SampleVar', because</span>
<a name="line-130"></a><span class="hs-comment">-- otherwise the state of the 'SampleVar' may have changed by the time</span>
<a name="line-131"></a><span class="hs-comment">-- you see the result of 'isEmptySampleVar'.</span>
<a name="line-132"></a><span class="hs-comment">--</span>
<a name="line-133"></a><span class="hs-definition">isEmptySampleVar</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">SampleVar</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-conid">Bool</span>
<a name="line-134"></a><span class="hs-definition">isEmptySampleVar</span> <span class="hs-layout">(</span><span class="hs-conid">SampleVar</span> <span class="hs-varid">svar</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span>
<a name="line-135"></a>   <span class="hs-layout">(</span><span class="hs-varid">readers</span><span class="hs-layout">,</span> <span class="hs-keyword">_</span><span class="hs-layout">)</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">readMVar</span> <span class="hs-varid">svar</span>
<a name="line-136"></a>   <span class="hs-varid">return</span> <span class="hs-layout">(</span><span class="hs-varid">readers</span> <span class="hs-varop">&lt;=</span> <span class="hs-num">0</span><span class="hs-layout">)</span>
<a name="line-137"></a>
</pre></body>
</html>
