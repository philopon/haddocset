<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Trace/Hpc/Mix.hs</title>
<link type="text/css" rel="stylesheet" href="hscolour.css"></link>
</head>
<body>
<pre><a name="line-1"></a><span class="hs-cpp">#</span><span class="hs-keyword">if</span> <span class="hs-sel">__GLASGOW_HASKELL__</span> <span class="hs-varop">&gt;=</span> <span class="hs-num">701</span>
<a name="line-2"></a><span class="hs-comment">{-# LANGUAGE Trustworthy #-}</span>
<a name="line-3"></a><span class="hs-cpp">#endif</span>
<a name="line-4"></a><span class="hs-comment">---------------------------------------------------------------</span>
<a name="line-5"></a><span class="hs-comment">-- Colin Runciman and Andy Gill, June 2006</span>
<a name="line-6"></a><span class="hs-comment">---------------------------------------------------------------</span>
<a name="line-7"></a>
<a name="line-8"></a><span class="hs-comment">-- | Datatypes and file-access routines for the per-module (.mix)</span>
<a name="line-9"></a><span class="hs-comment">-- indexes used by Hpc.</span>
<a name="line-10"></a><span class="hs-keyword">module</span> <span class="hs-conid">Trace</span><span class="hs-varop">.</span><span class="hs-conid">Hpc</span><span class="hs-varop">.</span><span class="hs-conid">Mix</span>
<a name="line-11"></a>        <span class="hs-layout">(</span> <span class="hs-conid">Mix</span><span class="hs-layout">(</span><span class="hs-keyglyph">..</span><span class="hs-layout">)</span>
<a name="line-12"></a>        <span class="hs-layout">,</span> <span class="hs-conid">MixEntry</span>
<a name="line-13"></a>        <span class="hs-layout">,</span> <span class="hs-conid">BoxLabel</span><span class="hs-layout">(</span><span class="hs-keyglyph">..</span><span class="hs-layout">)</span>
<a name="line-14"></a>        <span class="hs-layout">,</span> <span class="hs-conid">CondBox</span><span class="hs-layout">(</span><span class="hs-keyglyph">..</span><span class="hs-layout">)</span>
<a name="line-15"></a>        <span class="hs-layout">,</span> <span class="hs-varid">mixCreate</span>
<a name="line-16"></a>        <span class="hs-layout">,</span> <span class="hs-varid">readMix</span>
<a name="line-17"></a>        <span class="hs-layout">,</span> <span class="hs-varid">createMixEntryDom</span>
<a name="line-18"></a>        <span class="hs-layout">,</span> <span class="hs-conid">MixEntryDom</span>
<a name="line-19"></a>        <span class="hs-layout">)</span>
<a name="line-20"></a>  <span class="hs-keyword">where</span>
<a name="line-21"></a>
<a name="line-22"></a><span class="hs-keyword">import</span> <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">Maybe</span> <span class="hs-layout">(</span><span class="hs-varid">catMaybes</span><span class="hs-layout">)</span>
<a name="line-23"></a><span class="hs-keyword">import</span> <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">Time</span>
<a name="line-24"></a><span class="hs-keyword">import</span> <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">Tree</span>
<a name="line-25"></a><span class="hs-keyword">import</span> <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">Char</span>
<a name="line-26"></a>
<a name="line-27"></a><span class="hs-comment">-- a module index records the attributes of each tick-box that has</span>
<a name="line-28"></a><span class="hs-comment">-- been introduced in that module, accessed by tick-number position</span>
<a name="line-29"></a><span class="hs-comment">-- in the list</span>
<a name="line-30"></a>
<a name="line-31"></a><span class="hs-keyword">import</span> <span class="hs-conid">Trace</span><span class="hs-varop">.</span><span class="hs-conid">Hpc</span><span class="hs-varop">.</span><span class="hs-conid">Util</span> <span class="hs-layout">(</span><span class="hs-conid">HpcPos</span><span class="hs-layout">,</span> <span class="hs-varid">insideHpcPos</span><span class="hs-layout">,</span> <span class="hs-conid">Hash</span><span class="hs-layout">,</span> <span class="hs-conid">HpcHash</span><span class="hs-layout">(</span><span class="hs-keyglyph">..</span><span class="hs-layout">)</span><span class="hs-layout">,</span> <span class="hs-varid">catchIO</span><span class="hs-layout">)</span>
<a name="line-32"></a><span class="hs-keyword">import</span> <span class="hs-conid">Trace</span><span class="hs-varop">.</span><span class="hs-conid">Hpc</span><span class="hs-varop">.</span><span class="hs-conid">Tix</span>
<a name="line-33"></a>
<a name="line-34"></a><span class="hs-comment">-- | 'Mix' is the information about a modules static properties, like</span>
<a name="line-35"></a><span class="hs-comment">-- location of Tix's in a file.</span>
<a name="line-36"></a><span class="hs-comment">-- tab stops are the size of a tab in the provided line:colunm values.</span>
<a name="line-37"></a><span class="hs-comment">--  * In GHC, this is 1 (a tab is just a character)</span>
<a name="line-38"></a><span class="hs-comment">--  * With hpc-tracer, this is 8 (a tab represents several spaces).</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="Mix"></a><span class="hs-keyword">data</span> <span class="hs-conid">Mix</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">Mix</span>
<a name="line-41"></a>             <span class="hs-conid">FilePath</span>           <span class="hs-comment">-- location of original file</span>
<a name="line-42"></a>             <span class="hs-conid">UTCTime</span>            <span class="hs-comment">-- time of original file's last update</span>
<a name="line-43"></a>             <span class="hs-conid">Hash</span>               <span class="hs-comment">-- hash of mix entry + timestamp</span>
<a name="line-44"></a>             <span class="hs-conid">Int</span>                <span class="hs-comment">-- tab stop value.</span>
<a name="line-45"></a>             <span class="hs-keyglyph">[</span><span class="hs-conid">MixEntry</span><span class="hs-keyglyph">]</span>         <span class="hs-comment">-- entries</span>
<a name="line-46"></a>        <span class="hs-keyword">deriving</span> <span class="hs-layout">(</span><span class="hs-conid">Show</span><span class="hs-layout">,</span><span class="hs-conid">Read</span><span class="hs-layout">)</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="MixEntry"></a><span class="hs-keyword">type</span> <span class="hs-conid">MixEntry</span> <span class="hs-keyglyph">=</span> <span class="hs-layout">(</span><span class="hs-conid">HpcPos</span><span class="hs-layout">,</span> <span class="hs-conid">BoxLabel</span><span class="hs-layout">)</span>
<a name="line-49"></a>
<a name="line-50"></a><a name="BoxLabel"></a><span class="hs-keyword">data</span> <span class="hs-conid">BoxLabel</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">ExpBox</span>  <span class="hs-conid">Bool</span> <span class="hs-comment">-- isAlt</span>
<a name="line-51"></a>              <span class="hs-keyglyph">|</span> <span class="hs-conid">TopLevelBox</span> <span class="hs-keyglyph">[</span><span class="hs-conid">String</span><span class="hs-keyglyph">]</span>
<a name="line-52"></a>              <span class="hs-keyglyph">|</span> <span class="hs-conid">LocalBox</span> <span class="hs-keyglyph">[</span><span class="hs-conid">String</span><span class="hs-keyglyph">]</span>
<a name="line-53"></a>              <span class="hs-keyglyph">|</span> <span class="hs-conid">BinBox</span> <span class="hs-conid">CondBox</span> <span class="hs-conid">Bool</span>
<a name="line-54"></a>              <span class="hs-keyword">deriving</span> <span class="hs-layout">(</span><span class="hs-conid">Read</span><span class="hs-layout">,</span> <span class="hs-conid">Show</span><span class="hs-layout">,</span> <span class="hs-conid">Eq</span><span class="hs-layout">,</span> <span class="hs-conid">Ord</span><span class="hs-layout">)</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="CondBox"></a><span class="hs-keyword">data</span> <span class="hs-conid">CondBox</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">GuardBinBox</span>
<a name="line-57"></a>             <span class="hs-keyglyph">|</span> <span class="hs-conid">CondBinBox</span>
<a name="line-58"></a>             <span class="hs-keyglyph">|</span> <span class="hs-conid">QualBinBox</span>
<a name="line-59"></a>              <span class="hs-keyword">deriving</span> <span class="hs-layout">(</span><span class="hs-conid">Read</span><span class="hs-layout">,</span> <span class="hs-conid">Show</span><span class="hs-layout">,</span> <span class="hs-conid">Eq</span><span class="hs-layout">,</span> <span class="hs-conid">Ord</span><span class="hs-layout">)</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="instance%20HpcHash%20BoxLabel"></a><span class="hs-keyword">instance</span> <span class="hs-conid">HpcHash</span> <span class="hs-conid">BoxLabel</span> <span class="hs-keyword">where</span>
<a name="line-62"></a>   <span class="hs-varid">toHash</span> <span class="hs-layout">(</span><span class="hs-conid">ExpBox</span> <span class="hs-varid">b</span><span class="hs-layout">)</span>       <span class="hs-keyglyph">=</span> <span class="hs-num">0x100</span> <span class="hs-varop">+</span> <span class="hs-varid">toHash</span> <span class="hs-varid">b</span>
<a name="line-63"></a>   <span class="hs-varid">toHash</span> <span class="hs-layout">(</span><span class="hs-conid">TopLevelBox</span> <span class="hs-varid">nm</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-num">0x200</span> <span class="hs-varop">+</span> <span class="hs-varid">toHash</span> <span class="hs-varid">nm</span>
<a name="line-64"></a>   <span class="hs-varid">toHash</span> <span class="hs-layout">(</span><span class="hs-conid">LocalBox</span> <span class="hs-varid">nm</span><span class="hs-layout">)</span>    <span class="hs-keyglyph">=</span> <span class="hs-num">0x300</span> <span class="hs-varop">+</span> <span class="hs-varid">toHash</span> <span class="hs-varid">nm</span>
<a name="line-65"></a>   <span class="hs-varid">toHash</span> <span class="hs-layout">(</span><span class="hs-conid">BinBox</span> <span class="hs-varid">cond</span> <span class="hs-varid">b</span><span class="hs-layout">)</span>  <span class="hs-keyglyph">=</span> <span class="hs-num">0x400</span> <span class="hs-varop">+</span> <span class="hs-varid">toHash</span> <span class="hs-layout">(</span><span class="hs-varid">cond</span><span class="hs-layout">,</span><span class="hs-varid">b</span><span class="hs-layout">)</span>
<a name="line-66"></a>
<a name="line-67"></a><a name="instance%20HpcHash%20CondBox"></a><span class="hs-keyword">instance</span> <span class="hs-conid">HpcHash</span> <span class="hs-conid">CondBox</span> <span class="hs-keyword">where</span>
<a name="line-68"></a>   <span class="hs-varid">toHash</span> <span class="hs-conid">GuardBinBox</span> <span class="hs-keyglyph">=</span> <span class="hs-num">0x10</span>
<a name="line-69"></a>   <span class="hs-varid">toHash</span> <span class="hs-conid">CondBinBox</span>  <span class="hs-keyglyph">=</span> <span class="hs-num">0x20</span>
<a name="line-70"></a>   <span class="hs-varid">toHash</span> <span class="hs-conid">QualBinBox</span>  <span class="hs-keyglyph">=</span> <span class="hs-num">0x30</span>
<a name="line-71"></a>
<a name="line-72"></a>
<a name="line-73"></a><a name="mixCreate"></a><span class="hs-comment">-- | Create is mix file.</span>
<a name="line-74"></a><span class="hs-definition">mixCreate</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">String</span> <span class="hs-comment">-- ^ Dir Name</span>
<a name="line-75"></a>          <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">String</span> <span class="hs-comment">-- ^ module Name</span>
<a name="line-76"></a>          <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Mix</span>    <span class="hs-comment">-- ^ Mix DataStructure</span>
<a name="line-77"></a>          <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-conid">()</span>
<a name="line-78"></a><span class="hs-definition">mixCreate</span> <span class="hs-varid">dirName</span> <span class="hs-varid">modName</span> <span class="hs-varid">mix</span> <span class="hs-keyglyph">=</span>
<a name="line-79"></a>   <span class="hs-varid">writeFile</span> <span class="hs-layout">(</span><span class="hs-varid">mixName</span> <span class="hs-varid">dirName</span> <span class="hs-varid">modName</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-varid">show</span> <span class="hs-varid">mix</span><span class="hs-layout">)</span>
<a name="line-80"></a>
<a name="line-81"></a><a name="readMix"></a><span class="hs-comment">-- | Read a mix file.</span>
<a name="line-82"></a><span class="hs-definition">readMix</span> <span class="hs-keyglyph">::</span> <span class="hs-keyglyph">[</span><span class="hs-conid">String</span><span class="hs-keyglyph">]</span>                 <span class="hs-comment">-- ^ Dir Names</span>
<a name="line-83"></a>        <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Either</span> <span class="hs-conid">String</span> <span class="hs-conid">TixModule</span>  <span class="hs-comment">-- ^ module wanted</span>
<a name="line-84"></a>        <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-conid">Mix</span>
<a name="line-85"></a><span class="hs-definition">readMix</span> <span class="hs-varid">dirNames</span> <span class="hs-varid">mod'</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span>
<a name="line-86"></a>   <span class="hs-keyword">let</span> <span class="hs-varid">modName</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">case</span> <span class="hs-varid">mod'</span> <span class="hs-keyword">of</span>
<a name="line-87"></a>                    <span class="hs-conid">Left</span> <span class="hs-varid">str</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">str</span>
<a name="line-88"></a>                    <span class="hs-conid">Right</span> <span class="hs-varid">tix</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">tixModuleName</span> <span class="hs-varid">tix</span>
<a name="line-89"></a>   <span class="hs-varid">res</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">sequence</span> <span class="hs-keyglyph">[</span> <span class="hs-layout">(</span><span class="hs-keyword">do</span> <span class="hs-varid">contents</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">readFile</span> <span class="hs-layout">(</span><span class="hs-varid">mixName</span> <span class="hs-varid">dirName</span> <span class="hs-varid">modName</span><span class="hs-layout">)</span>
<a name="line-90"></a>                         <span class="hs-keyword">case</span> <span class="hs-varid">reads</span> <span class="hs-varid">contents</span> <span class="hs-keyword">of</span>
<a name="line-91"></a>                           <span class="hs-keyglyph">[</span><span class="hs-layout">(</span><span class="hs-varid">r</span><span class="hs-keyglyph">@</span><span class="hs-layout">(</span><span class="hs-conid">Mix</span> <span class="hs-keyword">_</span> <span class="hs-keyword">_</span> <span class="hs-varid">h</span> <span class="hs-keyword">_</span> <span class="hs-keyword">_</span><span class="hs-layout">)</span><span class="hs-layout">,</span><span class="hs-varid">cs</span><span class="hs-layout">)</span><span class="hs-keyglyph">]</span>
<a name="line-92"></a>                                <span class="hs-keyglyph">|</span> <span class="hs-varid">all</span> <span class="hs-varid">isSpace</span> <span class="hs-varid">cs</span>
<a name="line-93"></a>                               <span class="hs-varop">&amp;&amp;</span> <span class="hs-layout">(</span><span class="hs-keyword">case</span> <span class="hs-varid">mod'</span> <span class="hs-keyword">of</span>
<a name="line-94"></a>                                     <span class="hs-conid">Left</span>  <span class="hs-keyword">_</span>   <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">True</span>
<a name="line-95"></a>                                     <span class="hs-conid">Right</span> <span class="hs-varid">tix</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">h</span> <span class="hs-varop">==</span> <span class="hs-varid">tixModuleHash</span> <span class="hs-varid">tix</span>
<a name="line-96"></a>                                  <span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">return</span> <span class="hs-varop">$</span> <span class="hs-conid">Just</span> <span class="hs-varid">r</span>
<a name="line-97"></a>                           <span class="hs-keyword">_</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">return</span> <span class="hs-varop">$</span> <span class="hs-conid">Nothing</span><span class="hs-layout">)</span> <span class="hs-varop">`catchIO`</span> <span class="hs-layout">(</span><span class="hs-keyglyph">\</span> <span class="hs-keyword">_</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">return</span> <span class="hs-varop">$</span> <span class="hs-conid">Nothing</span><span class="hs-layout">)</span>
<a name="line-98"></a>                   <span class="hs-keyglyph">|</span> <span class="hs-varid">dirName</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">dirNames</span>
<a name="line-99"></a>                   <span class="hs-keyglyph">]</span>
<a name="line-100"></a>   <span class="hs-keyword">case</span> <span class="hs-varid">catMaybes</span> <span class="hs-varid">res</span> <span class="hs-keyword">of</span>
<a name="line-101"></a>     <span class="hs-keyglyph">[</span><span class="hs-varid">r</span><span class="hs-keyglyph">]</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">return</span> <span class="hs-varid">r</span>
<a name="line-102"></a>     <span class="hs-varid">xs</span><span class="hs-keyglyph">@</span><span class="hs-layout">(</span><span class="hs-keyword">_</span><span class="hs-conop">:</span><span class="hs-keyword">_</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">error</span> <span class="hs-varop">$</span> <span class="hs-str">&quot;found &quot;</span> <span class="hs-varop">++</span> <span class="hs-varid">show</span><span class="hs-layout">(</span><span class="hs-varid">length</span> <span class="hs-varid">xs</span><span class="hs-layout">)</span> <span class="hs-varop">++</span> <span class="hs-str">&quot; instances of &quot;</span> <span class="hs-varop">++</span> <span class="hs-varid">modName</span> <span class="hs-varop">++</span> <span class="hs-str">&quot; in &quot;</span> <span class="hs-varop">++</span> <span class="hs-varid">show</span> <span class="hs-varid">dirNames</span>
<a name="line-103"></a>     <span class="hs-keyword">_</span>        <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">error</span> <span class="hs-varop">$</span> <span class="hs-str">&quot;can not find &quot;</span> <span class="hs-varop">++</span> <span class="hs-varid">modName</span> <span class="hs-varop">++</span> <span class="hs-str">&quot; in &quot;</span> <span class="hs-varop">++</span> <span class="hs-varid">show</span> <span class="hs-varid">dirNames</span>
<a name="line-104"></a>
<a name="line-105"></a><a name="mixName"></a><span class="hs-definition">mixName</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">FilePath</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">String</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">String</span>
<a name="line-106"></a><span class="hs-definition">mixName</span> <span class="hs-varid">dirName</span> <span class="hs-varid">name</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">dirName</span> <span class="hs-varop">++</span> <span class="hs-str">&quot;/&quot;</span> <span class="hs-varop">++</span> <span class="hs-varid">name</span> <span class="hs-varop">++</span> <span class="hs-str">&quot;.mix&quot;</span>
<a name="line-107"></a>
<a name="line-108"></a><span class="hs-comment">------------------------------------------------------------------------------</span>
<a name="line-109"></a>
<a name="line-110"></a><a name="MixEntryDom"></a><span class="hs-keyword">type</span> <span class="hs-conid">MixEntryDom</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">Tree</span> <span class="hs-layout">(</span><span class="hs-conid">HpcPos</span><span class="hs-layout">,</span><span class="hs-varid">a</span><span class="hs-layout">)</span>
<a name="line-111"></a>
<a name="line-112"></a><span class="hs-comment">-- A good tree has all its children fully inside its parents HpcPos.</span>
<a name="line-113"></a><span class="hs-comment">-- No child should have the *same* HpcPos.</span>
<a name="line-114"></a><span class="hs-comment">-- There is no ordering to the children</span>
<a name="line-115"></a>
<a name="line-116"></a><a name="isGoodNode"></a><span class="hs-definition">isGoodNode</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">MixEntryDom</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Bool</span>
<a name="line-117"></a><span class="hs-definition">isGoodNode</span> <span class="hs-layout">(</span><span class="hs-conid">Node</span> <span class="hs-layout">(</span><span class="hs-varid">pos</span><span class="hs-layout">,</span><span class="hs-keyword">_</span><span class="hs-layout">)</span> <span class="hs-varid">sub_nodes</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span>
<a name="line-118"></a>      <span class="hs-varid">and</span> <span class="hs-keyglyph">[</span> <span class="hs-varid">pos'</span> <span class="hs-varop">`insideHpcPos`</span> <span class="hs-varid">pos</span>  <span class="hs-keyglyph">|</span> <span class="hs-conid">Node</span><span class="hs-layout">(</span><span class="hs-varid">pos'</span><span class="hs-layout">,</span><span class="hs-keyword">_</span><span class="hs-layout">)</span>  <span class="hs-keyword">_</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">sub_nodes</span> <span class="hs-keyglyph">]</span>
<a name="line-119"></a>   <span class="hs-varop">&amp;&amp;</span> <span class="hs-varid">and</span> <span class="hs-keyglyph">[</span> <span class="hs-varid">pos'</span> <span class="hs-varop">/=</span> <span class="hs-varid">pos</span> <span class="hs-keyglyph">|</span> <span class="hs-conid">Node</span><span class="hs-layout">(</span><span class="hs-varid">pos'</span><span class="hs-layout">,</span><span class="hs-keyword">_</span><span class="hs-layout">)</span> <span class="hs-keyword">_</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">sub_nodes</span> <span class="hs-keyglyph">]</span>
<a name="line-120"></a>   <span class="hs-varop">&amp;&amp;</span> <span class="hs-varid">isGoodForest</span> <span class="hs-varid">sub_nodes</span>
<a name="line-121"></a>
<a name="line-122"></a><a name="isGoodForest"></a><span class="hs-comment">-- all sub-trees are good trees, and no two HpcPos are inside each other.</span>
<a name="line-123"></a><span class="hs-definition">isGoodForest</span> <span class="hs-keyglyph">::</span> <span class="hs-keyglyph">[</span><span class="hs-conid">MixEntryDom</span> <span class="hs-varid">a</span><span class="hs-keyglyph">]</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Bool</span>
<a name="line-124"></a><span class="hs-definition">isGoodForest</span> <span class="hs-varid">sub_nodes</span> <span class="hs-keyglyph">=</span>
<a name="line-125"></a>   <span class="hs-varid">all</span> <span class="hs-varid">isGoodNode</span> <span class="hs-varid">sub_nodes</span>
<a name="line-126"></a>   <span class="hs-varop">&amp;&amp;</span> <span class="hs-varid">and</span> <span class="hs-keyglyph">[</span>  <span class="hs-varid">not</span> <span class="hs-layout">(</span><span class="hs-varid">pos1</span> <span class="hs-varop">`insideHpcPos`</span> <span class="hs-varid">pos2</span> <span class="hs-varop">||</span>
<a name="line-127"></a>                  <span class="hs-varid">pos2</span> <span class="hs-varop">`insideHpcPos`</span> <span class="hs-varid">pos1</span><span class="hs-layout">)</span>
<a name="line-128"></a>          <span class="hs-keyglyph">|</span> <span class="hs-layout">(</span><span class="hs-conid">Node</span> <span class="hs-layout">(</span><span class="hs-varid">pos1</span><span class="hs-layout">,</span><span class="hs-keyword">_</span><span class="hs-layout">)</span> <span class="hs-keyword">_</span><span class="hs-layout">,</span><span class="hs-varid">n1</span><span class="hs-layout">)</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">zip</span> <span class="hs-varid">sub_nodes</span> <span class="hs-keyglyph">[</span><span class="hs-num">0</span><span class="hs-keyglyph">..</span><span class="hs-keyglyph">]</span>
<a name="line-129"></a>          <span class="hs-layout">,</span> <span class="hs-layout">(</span><span class="hs-conid">Node</span> <span class="hs-layout">(</span><span class="hs-varid">pos2</span><span class="hs-layout">,</span><span class="hs-keyword">_</span><span class="hs-layout">)</span> <span class="hs-keyword">_</span><span class="hs-layout">,</span><span class="hs-varid">n2</span><span class="hs-layout">)</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">zip</span> <span class="hs-varid">sub_nodes</span> <span class="hs-keyglyph">[</span><span class="hs-num">0</span><span class="hs-keyglyph">..</span><span class="hs-keyglyph">]</span>
<a name="line-130"></a>          <span class="hs-layout">,</span> <span class="hs-layout">(</span><span class="hs-varid">n1</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Int</span><span class="hs-layout">)</span> <span class="hs-varop">/=</span> <span class="hs-varid">n2</span> <span class="hs-keyglyph">]</span>
<a name="line-131"></a>
<a name="line-132"></a><a name="addNodeToTree"></a><span class="hs-definition">addNodeToTree</span> <span class="hs-keyglyph">::</span> <span class="hs-layout">(</span><span class="hs-conid">Show</span> <span class="hs-varid">a</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=&gt;</span> <span class="hs-layout">(</span><span class="hs-conid">HpcPos</span><span class="hs-layout">,</span><span class="hs-varid">a</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">MixEntryDom</span> <span class="hs-keyglyph">[</span><span class="hs-varid">a</span><span class="hs-keyglyph">]</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">MixEntryDom</span> <span class="hs-keyglyph">[</span><span class="hs-varid">a</span><span class="hs-keyglyph">]</span>
<a name="line-133"></a><span class="hs-definition">addNodeToTree</span> <span class="hs-layout">(</span><span class="hs-varid">new_pos</span><span class="hs-layout">,</span><span class="hs-varid">new_a</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-conid">Node</span> <span class="hs-layout">(</span><span class="hs-varid">pos</span><span class="hs-layout">,</span><span class="hs-varid">a</span><span class="hs-layout">)</span> <span class="hs-varid">children</span><span class="hs-layout">)</span>
<a name="line-134"></a>  <span class="hs-keyglyph">|</span> <span class="hs-varid">pos</span> <span class="hs-varop">==</span> <span class="hs-varid">new_pos</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">Node</span> <span class="hs-layout">(</span><span class="hs-varid">pos</span><span class="hs-layout">,</span><span class="hs-varid">new_a</span> <span class="hs-conop">:</span> <span class="hs-varid">a</span><span class="hs-layout">)</span> <span class="hs-varid">children</span>
<a name="line-135"></a>  <span class="hs-keyglyph">|</span> <span class="hs-varid">new_pos</span> <span class="hs-varop">`insideHpcPos`</span> <span class="hs-varid">pos</span> <span class="hs-keyglyph">=</span>
<a name="line-136"></a>       <span class="hs-conid">Node</span> <span class="hs-layout">(</span><span class="hs-varid">pos</span><span class="hs-layout">,</span><span class="hs-varid">a</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-varid">addNodeToList</span> <span class="hs-layout">(</span><span class="hs-varid">new_pos</span><span class="hs-layout">,</span><span class="hs-varid">new_a</span><span class="hs-layout">)</span> <span class="hs-varid">children</span><span class="hs-layout">)</span>
<a name="line-137"></a>  <span class="hs-keyglyph">|</span> <span class="hs-varid">pos</span> <span class="hs-varop">`insideHpcPos`</span> <span class="hs-varid">new_pos</span> <span class="hs-keyglyph">=</span>
<a name="line-138"></a>       <span class="hs-varid">error</span> <span class="hs-str">&quot;precondition not met inside addNodeToNode&quot;</span>
<a name="line-139"></a>  <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">error</span> <span class="hs-str">&quot;something impossible happened in addNodeToTree&quot;</span>
<a name="line-140"></a>
<a name="line-141"></a><a name="addNodeToList"></a><span class="hs-definition">addNodeToList</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Show</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">=&gt;</span> <span class="hs-layout">(</span><span class="hs-conid">HpcPos</span><span class="hs-layout">,</span><span class="hs-varid">a</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyglyph">[</span><span class="hs-conid">MixEntryDom</span> <span class="hs-keyglyph">[</span><span class="hs-varid">a</span><span class="hs-keyglyph">]</span><span class="hs-keyglyph">]</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyglyph">[</span><span class="hs-conid">MixEntryDom</span> <span class="hs-keyglyph">[</span><span class="hs-varid">a</span><span class="hs-keyglyph">]</span><span class="hs-keyglyph">]</span>
<a name="line-142"></a><span class="hs-definition">addNodeToList</span> <span class="hs-layout">(</span><span class="hs-varid">new_pos</span><span class="hs-layout">,</span><span class="hs-varid">new_a</span><span class="hs-layout">)</span> <span class="hs-varid">entries</span>
<a name="line-143"></a>  <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span> <span class="hs-keyglyph">=</span>
<a name="line-144"></a>  <span class="hs-keyword">if</span> <span class="hs-varid">length</span> <span class="hs-keyglyph">[</span> <span class="hs-conid">()</span>
<a name="line-145"></a>          <span class="hs-keyglyph">|</span> <span class="hs-layout">(</span><span class="hs-varid">am_inside</span><span class="hs-layout">,</span><span class="hs-varid">am_outside</span><span class="hs-layout">,</span><span class="hs-keyword">_</span><span class="hs-layout">)</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">entries'</span>
<a name="line-146"></a>          <span class="hs-layout">,</span> <span class="hs-varid">am_inside</span> <span class="hs-varop">||</span> <span class="hs-varid">am_outside</span>
<a name="line-147"></a>          <span class="hs-keyglyph">]</span> <span class="hs-varop">==</span> <span class="hs-num">0</span>
<a name="line-148"></a>     <span class="hs-comment">-- The case where we have a new HpcPos range</span>
<a name="line-149"></a>     <span class="hs-keyword">then</span> <span class="hs-conid">Node</span> <span class="hs-layout">(</span><span class="hs-varid">new_pos</span><span class="hs-layout">,</span><span class="hs-keyglyph">[</span><span class="hs-varid">new_a</span><span class="hs-keyglyph">]</span><span class="hs-layout">)</span> <span class="hs-conid">[]</span> <span class="hs-conop">:</span> <span class="hs-varid">entries</span> <span class="hs-keyword">else</span>
<a name="line-150"></a>  <span class="hs-keyword">if</span> <span class="hs-varid">length</span> <span class="hs-keyglyph">[</span> <span class="hs-conid">()</span>
<a name="line-151"></a>            <span class="hs-keyglyph">|</span> <span class="hs-layout">(</span><span class="hs-varid">am_inside</span><span class="hs-layout">,</span><span class="hs-keyword">_</span><span class="hs-layout">,</span><span class="hs-keyword">_</span><span class="hs-layout">)</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">entries'</span>
<a name="line-152"></a>            <span class="hs-layout">,</span> <span class="hs-varid">am_inside</span>
<a name="line-153"></a>            <span class="hs-keyglyph">]</span> <span class="hs-varop">&gt;</span> <span class="hs-num">0</span>
<a name="line-154"></a>     <span class="hs-comment">-- The case where we are recursing into a tree</span>
<a name="line-155"></a>     <span class="hs-comment">-- Note we can recurse down many branches, in the case of</span>
<a name="line-156"></a>     <span class="hs-comment">-- overlapping ranges.</span>
<a name="line-157"></a>     <span class="hs-comment">-- Assumes we have captures the new HpcPos</span>
<a name="line-158"></a>     <span class="hs-comment">-- (or the above conditional would be true)</span>
<a name="line-159"></a>     <span class="hs-keyword">then</span> <span class="hs-keyglyph">[</span> <span class="hs-keyword">if</span> <span class="hs-varid">i_am_inside</span>  <span class="hs-comment">-- or the same as</span>
<a name="line-160"></a>            <span class="hs-keyword">then</span> <span class="hs-varid">addNodeToTree</span> <span class="hs-layout">(</span><span class="hs-varid">new_pos</span><span class="hs-layout">,</span><span class="hs-varid">new_a</span><span class="hs-layout">)</span> <span class="hs-varid">node</span>
<a name="line-161"></a>            <span class="hs-keyword">else</span> <span class="hs-varid">node</span>
<a name="line-162"></a>          <span class="hs-keyglyph">|</span> <span class="hs-layout">(</span><span class="hs-varid">i_am_inside</span><span class="hs-layout">,</span><span class="hs-keyword">_</span><span class="hs-layout">,</span><span class="hs-varid">node</span><span class="hs-layout">)</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">entries'</span>
<a name="line-163"></a>          <span class="hs-keyglyph">]</span> <span class="hs-keyword">else</span>
<a name="line-164"></a>     <span class="hs-comment">-- The case of a super-range.</span>
<a name="line-165"></a>     <span class="hs-layout">(</span> <span class="hs-conid">Node</span> <span class="hs-layout">(</span><span class="hs-varid">new_pos</span><span class="hs-layout">,</span><span class="hs-keyglyph">[</span><span class="hs-varid">new_a</span><span class="hs-keyglyph">]</span><span class="hs-layout">)</span>
<a name="line-166"></a>             <span class="hs-keyglyph">[</span> <span class="hs-varid">node</span> <span class="hs-keyglyph">|</span> <span class="hs-layout">(</span><span class="hs-keyword">_</span><span class="hs-layout">,</span><span class="hs-conid">True</span><span class="hs-layout">,</span><span class="hs-varid">node</span><span class="hs-layout">)</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">entries'</span> <span class="hs-keyglyph">]</span> <span class="hs-conop">:</span>
<a name="line-167"></a>       <span class="hs-keyglyph">[</span> <span class="hs-varid">node</span> <span class="hs-keyglyph">|</span> <span class="hs-layout">(</span><span class="hs-keyword">_</span><span class="hs-layout">,</span><span class="hs-conid">False</span><span class="hs-layout">,</span><span class="hs-varid">node</span><span class="hs-layout">)</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">entries'</span> <span class="hs-keyglyph">]</span>
<a name="line-168"></a>     <span class="hs-layout">)</span>
<a name="line-169"></a>  <span class="hs-keyword">where</span>
<a name="line-170"></a>    <span class="hs-varid">entries'</span> <span class="hs-keyglyph">=</span> <span class="hs-keyglyph">[</span> <span class="hs-layout">(</span> <span class="hs-varid">new_pos</span> <span class="hs-varop">`insideHpcPos`</span> <span class="hs-varid">pos</span>
<a name="line-171"></a>                 <span class="hs-layout">,</span> <span class="hs-varid">pos</span>  <span class="hs-varop">`insideHpcPos`</span> <span class="hs-varid">new_pos</span>
<a name="line-172"></a>                 <span class="hs-layout">,</span> <span class="hs-varid">node</span><span class="hs-layout">)</span>
<a name="line-173"></a>               <span class="hs-keyglyph">|</span> <span class="hs-varid">node</span><span class="hs-keyglyph">@</span><span class="hs-layout">(</span><span class="hs-conid">Node</span> <span class="hs-layout">(</span><span class="hs-varid">pos</span><span class="hs-layout">,</span><span class="hs-keyword">_</span><span class="hs-layout">)</span> <span class="hs-keyword">_</span><span class="hs-layout">)</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">entries</span>
<a name="line-174"></a>               <span class="hs-keyglyph">]</span>
<a name="line-175"></a>
<a name="line-176"></a><a name="createMixEntryDom"></a><span class="hs-definition">createMixEntryDom</span> <span class="hs-keyglyph">::</span> <span class="hs-layout">(</span><span class="hs-conid">Show</span> <span class="hs-varid">a</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=&gt;</span> <span class="hs-keyglyph">[</span><span class="hs-layout">(</span><span class="hs-conid">HpcPos</span><span class="hs-layout">,</span><span class="hs-varid">a</span><span class="hs-layout">)</span><span class="hs-keyglyph">]</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyglyph">[</span><span class="hs-conid">MixEntryDom</span> <span class="hs-keyglyph">[</span><span class="hs-varid">a</span><span class="hs-keyglyph">]</span><span class="hs-keyglyph">]</span>
<a name="line-177"></a><span class="hs-definition">createMixEntryDom</span> <span class="hs-varid">entries</span>
<a name="line-178"></a>    <span class="hs-keyglyph">|</span> <span class="hs-varid">isGoodForest</span> <span class="hs-varid">forest</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">forest</span>
<a name="line-179"></a>    <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">error</span> <span class="hs-str">&quot;createMixEntryDom: bad forest&quot;</span>
<a name="line-180"></a>  <span class="hs-keyword">where</span> <span class="hs-varid">forest</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">foldr</span> <span class="hs-varid">addNodeToList</span> <span class="hs-conid">[]</span> <span class="hs-varid">entries</span>
</pre></body>
</html>
